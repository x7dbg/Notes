InitCommonControlsEx     ç”¨æ–°ç‰ˆæœ¬æ§ä»¶æ—¶éœ€è¦è°ƒç”¨ä¸€ä¸‹æ­¤api

### é€šè¿‡è§‚å¯ŸMFCç”¨æ§åˆ¶å°æ¨¡æ‹Ÿå®ç°

```c++

int AFXAPI AfxWinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,
	_In_ LPTSTR lpCmdLine, int nCmdShow)
{

	int nReturnCode = -1;
	CWinThread* pThread = AfxGetThread();  //è·å–tlsç§å…¨å±€å¯¹è±¡çš„å€¼
	CWinApp* pApp = AfxGetApp();           //è·å–tlsç§å…¨å±€å¯¹è±¡çš„å€¼
 
	// Perform specific initializations
	if (!pThread->InitInstance())   //çª—å£åˆ›å»ºå¤±è´¥ä»¥åŠæ˜¯å¦æˆåŠŸæˆåŠŸåˆ¤æ–­	
    {
         //çª—å£åˆ›å»ºå¤±è´¥2ç§æƒ…å†µ   
         // 1. çª—å£åˆ›å»ºæˆåŠŸäº†åˆ°æœ€åå¤±è´¥äº†
         // 2. çª—å£ç›´æ¥åˆ›å»ºå¤±è´¥
		if (pThread->m_pMainWnd != NULL) //è¿™é‡Œç›´æ¥ä½¿ç”¨ m_pMainWnd è¯´æ˜æ­¤æˆå‘˜åœ¨ CWinThreadå…¬æœ‰ 
		{
			TRACE(traceAppMsg, 0, "Warning: Destroying non-NULL m_pMainWnd\n");
			pThread->m_pMainWnd->DestroyWindow();
		}
        //å¤±è´¥äº†å¦‚æœæœ‰èµ„æºå°±éœ€è¦é‡Šæ”¾ æ˜¯ pThreadè°ƒç”¨äº†,å› æ­¤æ˜¯CWinThread çš„è™šå‡½æ•° .æ´¾ç”Ÿå¯ä»¥é‡å†™
        //å› æ­¤  ExitInstance æœ‰ä¸¤ä¸ªåŠŸèƒ½ 1.å¦‚æœæœ‰èµ„æºå°±é‡Šæ”¾ 2.ä¿®æ”¹mainå‡½æ•°çš„è¿”å›å€¼
		nReturnCode = pThread->ExitInstance();
		goto InitFailure;
	}
	nReturnCode = pThread->Run();

InitFailure:
	return nReturnCode;
}
```

```c++
BOOL CMFCApplicationApp::InitInstance()
{

	CWinApp::InitInstance();   //è§£å†³å…¼å®¹æ€§é—®é¢˜
	// æ³¨å†Œåº”ç”¨ç¨‹åºçš„æ–‡æ¡£æ¨¡æ¿ã€‚  æ–‡æ¡£æ¨¡æ¿
	// å°†ç”¨ä½œæ–‡æ¡£ã€æ¡†æ¶çª—å£å’Œè§†å›¾ä¹‹é—´çš„è¿æ¥
	CSingleDocTemplate* pDocTemplate;
	pDocTemplate = new CSingleDocTemplate(
		IDR_MAINFRAME,
		RUNTIME_CLASS(CMFCApplicationDoc),
		RUNTIME_CLASS(CMainFrame),       // ä¸» SDI æ¡†æ¶çª—å£
		RUNTIME_CLASS(CMFCApplicationView));
	if (!pDocTemplate)
		return FALSE;
	AddDocTemplate(pDocTemplate);


	// åˆ†ææ ‡å‡† shell å‘½ä»¤ã€DDEã€æ‰“å¼€æ–‡ä»¶æ“ä½œçš„å‘½ä»¤è¡Œ
	CCommandLineInfo cmdInfo;
	ParseCommandLine(cmdInfo);


	// è°ƒåº¦åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šçš„å‘½ä»¤ã€‚  å¦‚æœ
	// ç”¨ /RegServerã€/Registerã€/Unregserver æˆ– /Unregister å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œåˆ™è¿”å› FALSEã€‚
	if (!ProcessShellCommand(cmdInfo))
		return FALSE;

	// å”¯ä¸€çš„ä¸€ä¸ªçª—å£å·²åˆå§‹åŒ–ï¼Œå› æ­¤æ˜¾ç¤ºå®ƒå¹¶å¯¹å…¶è¿›è¡Œæ›´æ–°
	m_pMainWnd->ShowWindow(SW_SHOW);
	m_pMainWnd->UpdateWindow();
	return TRUE;
}
```

å› æ­¤æˆ‘ä»¬çš„ä¸»ç¨‹åºçš„ä»£ç ä¸º

```c++
CTestApp theApp;

CWinThread* AfxGetThread() {
  return &theApp;  //TLS
}

CWinApp* AfxGetApp() {
  return &theApp; //TLS
}


int main()
{
 // CTestDoc* pObject = (CTestDoc*)CreateObject("CTestDoc");
  
  int nReturnCode = -1;
  CWinThread* pThread = AfxGetThread();
  CWinApp* pApp = AfxGetApp();


  pApp->m_hInstance = ::GetModuleHandle(NULL);
  if (!pThread->InitInstance())
  {
    if (pThread->m_pMainWnd != NULL)
    {
      printf("Warning: Destroying non-NULL m_pMainWnd\n");
      pThread->m_pMainWnd->DestroyWindow();
    }
    nReturnCode = pThread->ExitInstance();
    goto InitFailure;
  }
  nReturnCode = pThread->Run();

InitFailure:
  return nReturnCode;
}
```

CWnd

```c++
---------------CWnd.h------------
class CWnd :
    public CCmdTarget
{
public:
  virtual BOOL DestroyWindow();
  BOOL ShowWindow(int nCmdShow);
  void UpdateWindow();
 
public:
  HWND m_hWnd;
};

---------------CWnd.cpp------------
#include "CWnd.h"

BOOL CWnd::DestroyWindow()
{
  return ::DestroyWindow(m_hWnd);
}

BOOL CWnd::ShowWindow(int nCmdShow)
{
    return ::ShowWindow(m_hWnd, nCmdShow);
}

void CWnd::UpdateWindow()
{
  ::UpdateWindow(m_hWnd);
}

```

è¿™æ ·ä¸»ç¨‹åºåŠŸèƒ½å°±å®Œæˆäº†,æ¥ä¸‹æ¥å°±æ˜¯ å®Œæˆ  CtestApp ä¸­çš„  InitInstance åŠŸèƒ½äº†

åœ¨  InitInstance  ä¸»è¦è¦å®Œæˆæ³¨å†Œçª—å£ ,çª—å£å®ä¾‹åŒ–ç­‰åŠŸèƒ½

ä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡çœ‹åœ¨ çœŸæ­£çš„ MFCç¨‹åºçœ‹åˆ° è¯¥åŠŸèƒ½,éœ€è¦é€šè¿‡æ ˆå›æº¯çœ‹ä¸€ä¸‹åœ¨å“ª å®Œæˆçš„

æ‰¾æœ‰æ¶ˆæ¯å¤„ç†åœ°æ–¹ä¸‹ä¸€ä¸ªæ–­ç‚¹

![img](./notesimg/1660838575238-ebd4c9fe-a00b-4e0f-80b7-41d7197fa087.png)

![img](./notesimg/1660838648721-39aa54c9-31b6-41b0-a11b-d893f646042a.png)

![img](./notesimg/1660838774363-5f63e290-91b9-4418-b314-5c876b8ee6a4.png)

å‘ç°æˆ‘æœ‰ create å’Œ  createEX,éƒ½ä¸‹ä¸€ä¸ªæ–­ç‚¹ ,åœ¨è¿è¡Œç¨‹åº

![img](./notesimg/1660838872137-b18e5829-3081-4fb0-9ed3-04d8903cbb89.png)

å¯ä»¥é€šè¿‡æ ˆå›æº¯å‘ç°æ˜¯åœ¨  InitInstance  ä¸­å®ç°çš„

![img](./notesimg/1660838972530-ea665b1c-c878-4e20-8da4-3100bd6037d6.png)

å•æ–‡æ¡£ä¼šé»˜è®¤æ‰“å¼€ä¸€ä¸ªæ–‡æ¡£,æŠŠæ•°æ®è¯»è¿›å»æ˜¾ç¤ºå‡ºæ¥,å› æ­¤ æˆ‘ä»¬éœ€è¦ä»  OnFileNew æ¥ç€ç»§ç»­æ¨¡æ‹Ÿ

![img](./notesimg/1660840610852-5b82c813-3787-4912-bda1-18ef8df1c16b.png)

ä¸­é—´è¿™äº›æ˜¯æ¶ˆæ¯å¤„ç†,,å…¥å£å˜å¾—è¿™ä¹ˆå¤æ‚çš„åŸå› æ˜¯å› ä¸ºè¿™æ—¶å€™æ¶ˆæ¯å¾ªç¯è¿˜æ²¡å¼€å§‹,åˆ›å£è¿˜æ²¡åˆ›å»º,å› æ­¤æ¨¡æ‹Ÿå¾€æ¶ˆæ¯é˜Ÿåˆ—æŠ•é€’äº†ä¸€ä¸ªæ¶ˆæ¯,æœ‰ç‚¹åƒç›´æ¥è°ƒçª—å£è¿‡ç¨‹å‡½æ•°  OnFileNew  å°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯å¤„ç†å‡½æ•°

```c++
BOOL CTestApp::InitInstance()
{
  CWinApp::OnFileNew();

  m_pMainWnd->ShowWindow(SW_SHOW);
  m_pMainWnd->UpdateWindow();

  return TRUE;
}
```

æ¥ä¸‹æ¥å°±æ˜¯æ‰¾æ³¨å†Œä»£ç äº†,åªéœ€è¦æ‰¾åˆ›å»ºçª—å£æ—¶ ç±»åçš„æ¥æº,é€šè¿‡æ ˆå›æº¯æ‰¾,å¯ä»¥çŸ¥é“  æ³¨å†Œæ˜¯ä¹Ÿæ˜¯åœ¨  OnFileNew é‡Œé¢å®ç°çš„

![image.png](./notesimg/1660841218294-d00c499d-4939-4426-a3d1-39fc22f6d03b.png)



è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜,ç±»åå’Œçª—å£åæ˜¯ä¸å›ºå®šçš„,è€Œä¸”è¿™é‡Œä¹Ÿæ²¡æœ‰ä¼ å‚æ•°,é‚£ä¹ˆæ˜¯å¦‚ä½•è§£å†³ç±»åé—®é¢˜çš„å‘¢?  è¿™ä¸ªé—®é¢˜æˆ‘ä»¬åæ¥å†æ¥è§£å†³

```c++
void CWinApp::OnFileNew()
{
	if (m_pDocManager != NULL)
		m_pDocManager->OnFileNew();
}

å¯ä»¥çœ‹åˆ°å‡½æ•°é‡Œé¢ç”¨åˆ°äº†  CDocManager* m_pDocManager;    //æ–‡æ¡£ç®¡ç†å™¨
å› æ­¤æˆ‘ä»¬éœ€è¦å®Œæˆ  CDocManager  ç±»  é‡Œé¢æœ‰å‡½æ•°   OnFileNew()


void CDocManager::OnFileNew()
{

	CDocTemplate* pTemplate = (CDocTemplate*)m_templateList.GetHead();
	pTemplate->OpenDocumentFile(NULL);  //æ ¸å¿ƒä»£ç 
	
}


å¯ä»¥çœ‹åˆ°å‡½æ•°é‡Œé¢ç”¨åˆ°äº† CDocTemplate* pTemplate;    //æ–‡æ¡£ç®¡ç†å™¨
å› æ­¤æˆ‘ä»¬éœ€è¦å®Œæˆ  CDocTemplate  ç±»  é‡Œé¢æœ‰å‡½æ•°   OpenDocumentFile()

m_templateList æˆ‘ä»¬f12 è¿‡å»çœ‹å¯ä»¥å‘ç°è¿™ä¸ªä¸€ä¸ª mfcè‡ªå·±å°è£…çš„é“¾è¡¨,æˆ‘ä»¬æ²¡æœ‰,æ‰€ä»¥å¯ä»¥ç”¨stl
é‡Œé¢å­˜çš„å°±æ˜¯æ–‡æ¡£(å•æ–‡æ¡£å’Œå¤šæ–‡æ¡£çš„æ–‡æ¡£å°±æ˜¯å­˜æ”¾åœ¨é‡Œé¢)
```

CDocManager

```c++
---------------CDocManager.h-------------------
#pragma once
#include "CObject.h"
#include <list>
#include "CDocument.h"
#include "CDocTemplate.h"

class CDocManager :public CObject
{
public:
  void OnFileNew();
  void AddDocTemplate(CDocTemplate* pTemplate);
public:
  std::list<CDocTemplate*> m_templateList;
};

---------------CDocManager.cpp-------------------
 #include "CDocManager.h"
#include "CDocTemplate.h"

void CDocManager::OnFileNew()
{
  if (m_templateList.empty())
  {
    printf("Error: no document templates registered with CWinApp.\n");
    return;
  }

  CDocTemplate* pTemplate = (CDocTemplate*)m_templateList.front();
  pTemplate->OpenDocumentFile(NULL);
}

void CDocManager::AddDocTemplate(CDocTemplate* pTemplate)
{
  m_templateList.push_back(pTemplate);
}



```

```c++
struct CCreateContext   
{
  CDocument* m_pCurrentDoc;
  CDocTemplate* m_pNewDocTemplate;
  //CView* m_pLastView;
  CFrameWnd* m_pCurrentFrame;
};

ä¸ºäº†ç»™ createå¢åŠ é¢å¤–çš„å‚æ•°
æŠŠ lpCreateParams  ç”¨ ç»“æ„ä½“åœ°å€ æ›¿æ¢
```

![img](./notesimg/1660845829207-651650e9-6a4a-4026-895e-a1ed042f42ae.png)

CFrameWnd

```c++
--------CFrameWnd.h-----------------
#pragma once
#include "CWnd.h"
#include "CDocument.h"

class CFrameWnd : public CWnd
{
public:
  BOOL LoadFrame(UINT nIDResource, DWORD dwDefaultStyle,
    CWnd* pParentWnd, CCreateContext* pContext);

  BOOL Create(LPCTSTR lpszClassName,
    LPCTSTR lpszWindowName,
    DWORD dwStyle,
    const RECT& rect,
    CWnd* pParentWnd,
    LPCTSTR lpszMenuName,
    DWORD dwExStyle,
    CCreateContext* pContext);
};


--------CFrameWnd.cpp-----------------
    
#include "CFrameWnd.h"
#include "CView.h"

LRESULT MainWndProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam) {

  if (uMsg == WM_DESTROY) {
    ::PostQuitMessage(0);
  }

  return ::DefWindowProc(hWnd, uMsg, wParam, lParam);
}

BOOL CFrameWnd::LoadFrame(UINT nIDResource, DWORD dwDefaultStyle,
  CWnd* pParentWnd, CCreateContext* pContext)
{

  const char* lpszClass = "MainWindowClass";
  const char* lpszTitle = "51asm";
  RECT rectDefault = {0, 0, CW_USEDEFAULT, CW_USEDEFAULT};
  WNDCLASS wc;

  // Register the main window class. 
  wc.style = CS_HREDRAW | CS_VREDRAW;
  wc.lpfnWndProc = (WNDPROC)MainWndProc;
  wc.cbClsExtra = 0;
  wc.cbWndExtra = 0;
  wc.hInstance = ::GetModuleHandle(NULL);
  wc.hIcon = LoadIcon(NULL, IDI_APPLICATION);
  wc.hCursor = LoadCursor(NULL, IDC_ARROW);
  wc.hbrBackground = (HBRUSH)GetStockObject(WHITE_BRUSH);
  wc.lpszMenuName = NULL;
  wc.lpszClassName = lpszClass;

  if (!RegisterClass(&wc))
    return FALSE;

  if (!Create(lpszClass, lpszTitle, dwDefaultStyle, rectDefault,
    pParentWnd, MAKEINTRESOURCE(nIDResource), 0L, pContext))
  {
    return FALSE;   
  }

  return TRUE;
}

BOOL CFrameWnd::Create(LPCTSTR lpszClassName,
  LPCTSTR lpszWindowName,
  DWORD dwStyle,
  const RECT& rect,
  CWnd* pParentWnd,
  LPCTSTR lpszMenuName,
  DWORD dwExStyle,
  CCreateContext* pContext)
{
  HMENU hMenu = NULL;
  if (lpszMenuName != NULL)
  {
    if ((hMenu = ::LoadMenu(::GetModuleHandle(NULL), lpszMenuName)) == NULL)
    {
      return FALSE;
    }
  }
 
  if (!CreateEx(dwExStyle, lpszClassName, lpszWindowName, dwStyle,
    rect.left, rect.top, 
    rect.right - rect.left, 
    rect.bottom - rect.top,
    pParentWnd->GetSafeHwnd(),
    hMenu, 
    (LPVOID)pContext))
  {
    if (hMenu != NULL)
      ::DestroyMenu(hMenu);
    return FALSE;
  }

  return TRUE;
}
    

```

CSingleDocTemplate

```c++
-------------------CSingleDocTemplate.h----------------

#pragma once
#include "CDocTemplate.h"
#include "CFrameWnd.h"
class CSingleDocTemplate :public CDocTemplate
{
public:
  CDocument* OpenDocumentFile(LPCTSTR lpszPathName, BOOL bMakeVisible = TRUE);
  CDocument* OpenDocumentFile(LPCTSTR lpszPathName, BOOL bAddToMRU, BOOL bMakeVisible);
protected:  
  CDocument* m_pOnlyDoc;
  UINT m_nIDResource;
};

    

-------------------CSingleDocTemplate.cpp--------------   

#include "CSingleDocTemplate.h"
#include "CTestDoc.h"
#include "CTestFrame.h"
#include "resource.h"
#include "CWinApp.h"

CDocument* CSingleDocTemplate::OpenDocumentFile(LPCTSTR lpszPathName, BOOL bMakeVisible)
{
  return OpenDocumentFile(lpszPathName, TRUE, bMakeVisible);
}

CDocument* CSingleDocTemplate::OpenDocumentFile(LPCTSTR lpszPathName, BOOL bAddToMRU, BOOL bMakeVisible)
{
  CDocument* pDocument = NULL;
  CFrameWnd* pFrame = NULL;
  BOOL bCreated = FALSE;      // => doc and frame created
  BOOL bWasModified = FALSE;

  
  pDocument = new CTestDoc();
  bCreated = TRUE;

  pFrame = new CTestFrame();
  if (pFrame == NULL)
  {
    delete pDocument;       // explicit delete on error
    return NULL;
  }

  AfxGetApp()->m_pMainWnd = pFrame;

  CCreateContext context;
  context.m_pCurrentFrame = pFrame;
  context.m_pCurrentDoc = pDocument;
  //context.m_pNewViewClass = m_pViewClass;
  context.m_pNewDocTemplate = this;

  m_nIDResource = IDR_MENU1;
  if (!pFrame->LoadFrame(m_nIDResource,
    WS_OVERLAPPEDWINDOW,   // default frame styles
    NULL, &context))
  {
    return NULL;
  }

  return pDocument;
}   
 
```

æç¤ºï¼š  å¦‚æœå‡ºç°å¤´æ–‡ä»¶ç›¸äº’åŒ…å«é—®é¢˜ï¼Œå¯ä»¥ç”¨å‘å‰ç”³æ˜è§£å†³ 

â€‹              ä¾‹å¦‚æŠŠå…¶ä¸­çš„ä¸€ä¸ªå¤´æ–‡ä»¶åŒ…å«  #include â€œA.hâ€ æ”¹æˆ  class  A

[ğŸ“MyMFC.zip](./MyMFC2.zip)

ä¸Šé¢ä»£ç è¿˜æœ‰2ä¸ªé—®é¢˜

1.  çª—å£åå’Œèœå•é—®é¢˜,ç›®å‰æˆ‘ä»¬æ˜¯å›ºå®šçš„,å®é™…ä¸Šæ˜¯ä¸èƒ½å›ºå®šçš„ 

â€‹      å­—ç¬¦ä¸²æˆ‘ä»¬å¯ä»¥é€šè¿‡èµ„æºé‡Œé¢è¯»å–å°±å¯ä»¥äº†,ä½†æ˜¯èœå•idæ˜¯æ•´å½¢,ä¸å¯ä»¥,ä½†æ˜¯æ˜¯é€šè¿‡ä¼ å‚æˆ–å¾—çš„,å› æ­¤å¯ä»¥é€šè¿‡ä¼ å‚è§£å†³

![img](./notesimg/1660875862720-b0c72e0a-bfe1-469e-a608-e9520827833b.png)

1.  æˆ‘ä»¬ä½¿ç”¨ååé¢æ·»åŠ çš„ç±» 

â€‹        pDocument = new CTestDoc();

â€‹        pFrame = new CTestFrame();

â€‹        å› ä¸ºæˆ‘ä»¬æ— æ³•çŸ¥é“åé¢çš„æ´¾ç”Ÿç±»çš„ç±»åï¼Œè€Œè¿™é‡Œæœ‰éœ€è¦newæ´¾ç”Ÿç±»å¯¹è±¡,å› æ­¤å¦‚ä½•é€šè¿‡åŸºç±»å–newæ´¾ç”Ÿç±»å°±æ˜¯æˆ‘ä»¬ç›®å‰é‡åˆ°çš„éš¾ç‚¹,å³å¦‚ä½•é€šè¿‡å‡½æ•°new ä¸€ä¸ªåæ¥æ‰å‡ºç°çš„ç±»

â€‹         å› æ­¤æˆ‘ä»¬èƒ½æƒ³åˆ°çš„æ–¹æ³•æ˜¯æŠŠç±»åå½“åšå‚æ•°ä¼ é€’,é‚£é—®é¢˜é¢˜å°±è½¬åŒ–æˆäº† å¦‚ä½•é€šè¿‡å­—ç¬¦ä¸² newä¸€ä¸ªå¯¹è±¡

â€‹         è¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†æ¡†æ¶éƒ½ä¼šé‡åˆ°çš„é—®é¢˜

```c++
//å³è¦å®ç°ä¸‹é¢å‡½æ•°éœ€è¦çš„æ•ˆæœ

CObject* CreateObject(const char* pszClassName) {
  return new pszClassName ;
}

CObject* pObject = CreateObject("CObject");

å‡è®¾ä¸Šé¢å¯ä»¥æˆåŠŸ,é‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸‹é¢åŠŸèƒ½

 CTestDoc* pObject = (CTestDoc*)CreateObject("CTestDoc");

è¿™é‡Œçš„é—®é¢˜æ˜¯æˆ‘ä»¬æŠŠä¸€ä¸ªå¯¹è±¡æŒ‡é’ˆè½¬æˆå¦ä¸€ä¸ªå¯¹è±¡æŒ‡é’ˆ,ä¸ç¡®å®šæ˜¯å¦å­˜åœ¨é—®é¢˜
ä¸Šé¢æ˜¯åŸºç±»æŒ‡é’ˆè½¬æ´¾ç”Ÿç±»æ˜¯å¦å¯èƒ½æˆ‘ä»¬ä¸æ¸…æ¥š,å› ä¸ºæ— æ³•åˆ¤æ–­ç»§æ‰¿å…³ç³»

è¦è§£å†³ä¸Šé¢çš„é—®é¢˜,æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ç±»å‹è¯†åˆ«   typeid è¯†åˆ«å½“å‰å¯¹è±¡æŒ‡é’ˆæ˜¯ä»€ä¹ˆç±»å‹çš„å¯¹è±¡æˆ–è€…å¯¹è±¡æŒ‡é’ˆ



```

### RTTI    è¿è¡Œæ—¶ç±»å‹è¯†åˆ«

Run-Time Type Identification

#### C++ç±»å‹è¯†åˆ«ï¼š

-   åŒ…å«å¤´æ–‡ä»¶ <typeinfo.h>
-   è¦ä½¿ç”¨typeid å…³é”®å­—  typeid(å¯¹è±¡)  typeid (ç±»å)

```c++
å½“æˆ‘ä»¬è¦ç»™æ§ä»¶è®¾ç½®æ–‡æœ¬,è¦æ€ä¹ˆæ‰èƒ½é€šç”¨å‘¢,å› ä¸ºå‡½æ•°åå’Œå‚æ•°å¯èƒ½ä¸ä¸€æ ·,å› æ­¤æ— æ³•ç”¨å¤šæ€æ¥å®ç°
åªè¦èƒ½å¤Ÿè¯†åˆ«ç±»çš„ç±»å‹å°±å¯ä»¥åšåˆ°

SetControlText(CObject *pObj, CString text) {
  switch(typeid(pObj).name()) {
  case "CButton":
      ((CButton*)pOb)j->SetButtonText(text);
      break;
  case "CListCtrl":
      ((CListCtrl*)pOb)j->SetWindowText(0,text);
      break;
  }
}

è¿™æ ·æˆ‘ä»¬ç»™ä»»æ„ç©ºé—´è®¾ç½®æ–‡æœ¬ä¸€è¡Œä»£ç å°±å¯ä»¥äº†,æ§ä»¶å³ä½¿å˜äº†ä¹Ÿä¸å½±å“åŠŸèƒ½,è¿™æ ·å°±è§£å†³äº†å¤šæ€ä¸èƒ½è§£å†³çš„é—®é¢˜

SetControlText(obj, "msg");

åé¢å¾ˆå¤šæ–°å‘æ˜çš„é¢å‘å¯¹è±¡è¯­è¨€è‡ªå¸¦è¿™ä¸ªåŠŸèƒ½,ä¸éœ€è¦ç”¨åˆ°  typeid
```

#### MFCç±»å‹è¯†åˆ«ï¼š

â€‹         typeid åŠŸèƒ½å¤ªå¼±,å¹¶ä¸èƒ½å®ç°æˆ‘ä»¬è¦å®ç°çš„ä»£ç çš„åŠŸèƒ½,å› æ­¤ä»–æ˜¯åœ¨ç¼–è¯‘æ—¶ç±»å‹è¯†åˆ«,å¹¶ä¸èƒ½åšåˆ°è¿è¡Œæ—¶ç±»å‹è¯†åˆ«,å³ä¸å…·å¤‡å¤šæ€æ€§,è€Œä¸”èƒ½åšåˆ°è¿è¡Œæ—¶ç±»å‹è¯†åˆ«ä¹Ÿæ²¡åŠæ³•å®ç°æˆ‘ä»¬ä¸Šé¢ è¦æŠŠå­—ç¬¦ä¸² è½¬æˆç±» çš„åŠŸèƒ½

```c++
CObject* pObject = new CWinApp();
printf("%s\n", typeid(pObj).name());

ç»“æœæ˜¯  class  CObject* ,è€Œæ­£ç¡®çš„åº”è¯¥æ˜¯   class  CWinApp*
```

å› æ­¤å°±ç”¨åˆ°äº†  RTTI 



â€‹        æˆ‘ä»¬æœ€ç»ˆè¦æ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªç±»å,é‚£æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠç±»åä¿å­˜èµ·æ¥å³åœ¨ç±»åä¿å­˜ä½è¯¥ç±»å¯¹è±¡çš„ä¸€ä¸ªæˆå‘˜,è¿™æ ·æˆ‘ä»¬è¦è·å–ç±»åçš„æ—¶å€™åªéœ€è¦è¯¥æˆå‘˜çš„å€¼å°±å¯ä»¥äº†,ä½†æ˜¯è¿™æ ·æœ‰ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯æµªè´¹å†…å­˜,å› ä¸ºæ¯newä¸€ä¸ªå¯¹è±¡å°±è¦äº§ç”Ÿä¸€ä¸ªå­—ç¬¦ä¸²,å› æ­¤å¯ä»¥ç”¨é™æ€,è¿™æ ·ä¸ç®¡æœ‰å¤šå°‘ä¸ªå¯¹è±¡,ä¸€ä¸ªç±»ç»™ä¸€ä¸ªå­—ç¬¦ä¸²å°±å¤Ÿäº†,å› ä¸ºæ¯ä¸ªç±»éƒ½éœ€è¦,å› æ­¤è¿™ä¸ªæˆå‘˜åŠ åœ¨æ€»åŸºç±»(CObject   å°±å¯ä»¥äº†),åŸºç±»åœ¨é€šè¿‡è™šå‡½æ•°å»æ‹¿å°±å¯ä»¥äº†

â€‹        æ³¨æ„: é™æ€æˆå‘˜åªèƒ½åœ¨cppä¸­åˆå§‹åŒ–.

```c++
--------------CObject.h---------------
class CObject
{
private:
public:
  static const char* m_pszClassName;
  virtual const char*  GetClassName(){
      return m_pszClassName;
  };
};

--------------CObject.cpp---------------

const  char* Cobject:: m_pszClassName ="CObject" ;

```

è¿™æ ·å°±å®ç°äº†å¤šæ€,å¯ä»¥åŠ¨æ€çš„è¯†åˆ«ä¸€ä¸ªç±»å‹

ä½†æ˜¯è¿˜æ˜¯æ²¡åŠæ³•è¯†åˆ«ç»§æ‰¿å…³ç³»

```c++
SetControlText(CObject *pObj, CString text) {
  switch(pObj.GetClassName()) {
  case "CButton":
      ((CButton*)pOb)j->SetButtonText(text);
      break;
  case "CListCtrl":
      ((CListCtrl*)pOb)j->SetWindowText(0,text);
      break;
  }
}

ä½†æ˜¯ å¦‚æœå‡ºç°äº†   CButtonEX :public  CButton
é‚£ä¹ˆ ä¸Šè¿°ä»£ç å°†æ— æ³•ä½¿ç”¨ ,å› ä¸ºä¸Šé¢åˆ¤æ–­æ²¡æœ‰ CButtonEX çš„ç±»å‹,æ˜¾ç„¶æ˜¯ä¸åˆç†çš„
å³ä¸Šè¿°ä»£ç åªæ”¯æŒå·²æœ‰çš„æ§ä»¶,ä¸æ”¯æŒåé¢æ–°åŠ çš„æ§ä»¶,æˆ–è€…æ¯æ–°å¢ä¸€ä¸ªç©ºé—´å°±æ”¹ä¸€æ¬¡ä»£ç ,è¿™æ ·å°±ä¸å…·å¤‡å¯ç»´æŠ¤æ€§
è€Œæˆ‘ä»¬çš„æœŸæœ›æ˜¯,å³ä½¿æ˜¯åé¢æ–°å¢çš„æ§ä»¶ä¹Ÿèƒ½è‡ªåŠ¨è¯†åˆ«å‡ºæ¥,ä¸Šé¢æ˜æ˜¾æ— æ³•åšåˆ°
å› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å¯¹è±¡çš„ç»§æ‰¿å…³ç³»,å³ æ–°å¢çš„æ§ä»¶ç±»æ˜¯å¦ç»§æ‰¿äºæˆ‘ä»¬å·²å­˜åœ¨æ§ä»¶

è¦å®ç°å½“å‰ç±»æ˜¯ä¸æ˜¯ä¸€ä¸ªç±»çš„æ´¾ç”Ÿç±»,å¯ä»¥è€ƒè™‘æŠŠè¯¥ç±»çš„åŸºç±»ä¹Ÿä¿å­˜èµ·æ¥,ä½†æ˜¯åŸºç±»ä¹Ÿå¯èƒ½è¿˜æœ‰åŸºç±»
å› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨å•å‘é“¾è¡¨,  ä½†æ˜¯å…‰å­—ç¬¦ä¸²ç”¨é“¾è¡¨ä¸å¥½å†™,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨ç»“æ„ä½“
,è¿™æ ·,åé¢å¦‚æœéœ€è¦åŠ å…¶ä»–ä¿¡æ¯ä¹Ÿå¯ä»¥ç›´æ¥åŠ 

    
struct CRuntimeClass {
    const  char* m_pszClassName;
    const  CRuntimeClass *m_pNext;   
};


--------------CObject.h---------------
class CObject
{
private:
public:
  static const CRuntimeClass classCObject;
  virtual CRuntimeClass* GetRuntimeClass() const;
};


--------------CObject.cpp---------------
const CRuntimeClass CObject::classCObject = { "CObject", NULL };

CRuntimeClass* CObject::GetRuntimeClass() const {
  return (CRuntimeClass*)&classCObject;
}



--------------ä¸»å‡½æ•°.cpp--------------

const CRuntimeClass*  pRuntimeClass = pObject->GetRuntimeClass();
while(pRuntimeClass!=NULL)
{
     printf("%s->",pRuntimeClass->m_pszClassName);
     pRuntimeClass=  pRuntimeClass->m_pNext;
}

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éå† è¯¥ç±»æ‰€æœ‰çš„çˆ¶ç±»äº†,å°±èƒ½çŸ¥é“ä»–æ‰€æœ‰åŸºç±»çš„ç±»åäº†,è¿™æ ·å°±åˆ¤æ–­ä»–æ˜¯ä¸æ˜¯æŸä¸ªç±»çš„æ´¾ç”Ÿç±»ä¹Ÿå¾ˆç®€å•äº†
æˆ‘ä»¬è¿˜å¯ä»¥å§åˆ¤æ–­å°è£…æˆä¸€ä¸ªæˆå‘˜å‡½æ•°

struct CRuntimeClass {
    const  char* m_pszClassName;
    const  CRuntimeClass *m_pNext; 
    BOOL IsKindOf (const char* m_pszClassName);
};



BOOL IsKindOf ( const  CRuntimeClass* pClass )  const
{
    const CRuntimeClass *pRuntimeClass =  this;
    while(pRuntimeClass!=NULL)
    {
         //ä¸ºäº†æé«˜æ•ˆç‡,æ¯”è¾ƒå­—ç¬¦ä¸²å¯ä»¥æ”¹æˆæ¯”è¾ƒåœ°å€  if(pRuntimeClass == pClass )
         if(srtcmp(pRuntimeClass->m_pszClassName,pClass->m_pszClassName) == 0){
              return TRUE;
         }
         pRuntimeClass=  pRuntimeClass->m_pNext;
    }
    return FALSE;
}


//æ¯”åœ°å€çš„è¯,è°ƒç”¨çš„æ—¶å€™æ”¹ä¸€ä¸‹ä¼ å‚å°±å¯ä»¥äº†
pObject->GetRuntimeClass()->IsKindOf(&CObject::classCObject)

```

è¿™æ ·å°±æœ‰ä¸€ä¸ªé—®é¢˜,æ¯ä¸ªç±»éƒ½é‡å¾—å†™ä¸Šé¢ CObject çš„    static const CRuntimeClass classCObject;

virtual CRuntimeClass* GetRuntimeClass() const;  ,æ¢æˆè‡ªå·±å¯¹åº”çš„ ,è€Œä¸”ä¸èƒ½å†™,å†™é”™åŠŸèƒ½å°±ç”¨ä¸äº†äº†

ä¾‹å¦‚ 

```c++
--------------CWinApp.h---------------
class CCmdTarget : public CObject
{
  ....
  ....
  ....
public:
     
  static const CRuntimeClass classCCmdTarget;
  virtual CRuntimeClass* GetRuntimeClass() const;

};

--------------CCmdTarget.cpp--------------
....
....
....
const CRuntimeClass CCmdTarget::classCCmdTarget = { "CCmdTarget", &CObject::classCObject};

CRuntimeClass* CCmdTarget::GetRuntimeClass() const {
  return (CRuntimeClass*)&classCCmdTarget;
}

```

æ¯ä¸ªç±»éƒ½å¾—åŠ ,å¾ˆå®¹æ˜“å‡ºé”™, å› æ­¤å¯ä»¥ç”¨å®å»æ›¿ä»£å‡½æ•°,å› ä¸ºå®ä¸å®¹æ˜“å‡ºé”™

```c++
//å‡½æ•°å£°æ˜
#define DECLARE_DYNAMIC(class_name) \
public: \
	static const CRuntimeClass class##class_name; \
	virtual CRuntimeClass* GetRuntimeClass() const; \


//å–æˆå‘˜åœ°å€
#define _RUNTIME_CLASS(class_name) ((CRuntimeClass*)(&class_name::class##class_name))


#define RUNTIME_CLASS(class_name) _RUNTIME_CLASS(class_name)


//å‡½æ•°å®ç°
#define IMPLEMENT_RUNTIMECLASS(class_name, base_class_name, wSchema, pfnNew, class_init) \
	const CRuntimeClass class_name::class##class_name = { \
		#class_name, sizeof(class class_name), wSchema, pfnNew, \
			RUNTIME_CLASS(base_class_name), NULL, class_init }; \
	CRuntimeClass* class_name::GetRuntimeClass() const \
		{ return RUNTIME_CLASS(class_name); }


#define IMPLEMENT_DYNAMIC(class_name, base_class_name) \
	IMPLEMENT_RUNTIMECLASS(class_name, base_class_name, 0xFFFF, NULL, NULL)

```

é€šè¿‡å»æŸ¥çœ‹mfå®ç°ä»£ç ,å¯èƒ½çœ‹å‡º  CRuntimeClass  ç»“æ„ä½“å­˜åœ¨7ä¸ªæˆå‘˜

```c++
struct CRuntimeClass {
  LPCSTR m_lpszClassName;             //ç±»å
  int m_nObjectSize;                  //å¯¹è±¡å¤§å°
  UINT m_wSchema;                     //ç‰ˆæœ¬å·
  CObject* (*m_pfnCreateObject)();    //å‡½æ•°æŒ‡é’ˆ
  CRuntimeClass* m_pBaseClass;        //åŸºç±»æŒ‡é’ˆ


  CRuntimeClass* m_pNextClass;
  const void* m_pClassInit;
};

```

å› æ­¤å‰é¢çš„ä»£ç æˆ‘ä»¬éœ€è¦ä¿®æ”¹

```c++
--------------CObject.h---------------
#include <Windows.h>
#include <stdio.h>

class CWinApp;

HINSTANCE AfxGetInstanceHandle();
CWinApp* AfxGetApp();


class CObject;

struct CRuntimeClass {
  LPCSTR m_lpszClassName;
  int m_nObjectSize;
  UINT m_wSchema;
  CObject* (*m_pfnCreateObject)();
  CRuntimeClass* m_pBaseClass;

  //ä¸‹é¢ä¸¤ä¸ªæˆå‘˜æ²¡ç”¨
  CRuntimeClass* m_pNextClass;
  const void* m_pClassInit;
};


#define DECLARE_DYNAMIC(class_name) \
public: \
	static const CRuntimeClass class##class_name; \
	virtual CRuntimeClass* GetRuntimeClass() const; \

#define _RUNTIME_CLASS(class_name) ((CRuntimeClass*)(&class_name::class##class_name))

#define RUNTIME_CLASS(class_name) _RUNTIME_CLASS(class_name)

#define IMPLEMENT_RUNTIMECLASS(class_name, base_class_name, wSchema, pfnNew, class_init) \
	const CRuntimeClass class_name::class##class_name = { \
		#class_name, sizeof(class class_name), wSchema, pfnNew, \
			RUNTIME_CLASS(base_class_name), NULL, class_init }; \
	CRuntimeClass* class_name::GetRuntimeClass() const \
		{ return RUNTIME_CLASS(class_name); }


#define IMPLEMENT_DYNAMIC(class_name, base_class_name) \
	IMPLEMENT_RUNTIMECLASS(class_name, base_class_name, 0xFFFF, NULL, NULL)


class CObject
{
private:
public:
  static const CRuntimeClass classCObject;
  virtual CRuntimeClass* GetRuntimeClass() const;
};



--------------CObject.cpp---------------
#include "CObject.h"


const CRuntimeClass CObject::classCObject = { "CObject",
sizeof(CObject), 0xFFFF, NULL, NULL };

CRuntimeClass* CObject::GetRuntimeClass() const {
  return RUNTIME_CLASS(CObject);
}
```

é€šè¿‡åœ¨å‘½ä»¤è¡Œ åŠ é€‰é¡¹ /p(åªç¼–è¯‘ä¸é“¾æ¥) ç”Ÿæˆ  .i æ–‡ä»¶ ,å¯ä»¥æŸ¥çœ‹å±•å¼€è¿‡åçš„å®æ˜¯ä»€ä¹ˆæ ·å­ 

![img](./notesimg/1661003268713-f5cc82ae-3922-4bbe-85f0-eb546188d456.png)

å‰©ä¸‹çš„åªéœ€è¦æŠŠå„ä¸ªç±»åŠ ä¸Šå¯¹åº”çš„å®å°±å¯ä»¥äº† , å› ä¸ºå®å®šä¹‰å·²ç»åœ¨ CObject åŠ äº†,ä»–æ‰€æœ‰çš„æ´¾ç”Ÿå°±ä¸éœ€è¦åŠ äº†

å› ä¸º  CObject  è·Ÿå…¶ä»–æ´¾ç”Ÿç±»ä¸€æ ·,ä»–æ²¡æœ‰åŸºç±»,æ‰€ä»¥ä»–çš„éœ€è¦å¦å¤–å†™,ä¸ä¼šç”¨åˆ°å®

æ²¡æœ‰æ·»åŠ å®çš„ç±»,æŠŠå®åŠ è¿›å»å°±å¯ä»¥äº†

### æºç 

[ğŸ“MyMFC2.zip](./MyMFC2.zip)