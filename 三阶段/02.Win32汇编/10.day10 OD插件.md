### ç­›é€‰å™¨å¼‚å¸¸æ’ä»¶

è¢«è°ƒè¯•ç¨‹åº:  [ğŸ“TestUnh.zip](./TestUnh.zip) 

æˆ‘ä»¬ç”¨ODæ¡è¯•è¯•å‘ç°,æ— æ³•æ–­ä¸‹ ç­›é€‰å™¨å¼‚å¸¸

å¼‚å¸¸äº§ç”Ÿä¹‹å    å¼‚å¸¸é¦–å…ˆä¼šç»™è°ƒè¯•å™¨       è°ƒè¯•å™¨ä¸å¤„ç†å°±ä¼šç»™ SEH  ,  SEH ä¸å¤„ç†çš„è¯æœ‰åˆç»™è°ƒè¯•å™¨, è°ƒè¯•å™¨ä¸å¤„ç†çš„è¯å°±ä¼šç»™ç­›é€‰å™¨  ,   ç­›é€‰å™¨ä¸å¤„ç†çš„å°±ä¼šç»™æ“ä½œç³»ç»Ÿ,ç›´æ¥é€€è¿›ç¨‹

è¿™é‡Œé¢æ˜¯2æ¬¡çš„å¼‚å¸¸æ´¾å‘æµç¨‹     ç¬¬ä¸€æ¬¡ æ˜¯ åˆ° ç»™SHE      ä¹‹åå±äºç¬¬äºŒæ¬¡ æ´¾å‘æµç¨‹

ç¬¬äºŒæ¬¡æ´¾å‘æ˜¯ä¸€ä¸ªåˆ†æ”¯,ä¼šåˆ¤æ–­æ˜¯å¦æœ‰è°ƒè¯•å™¨,æœ‰çš„è¯å°±ç»™è°ƒè¯•å™¨,æ²¡æœ‰çš„è¯ç›´æ¥ç»™ç­›é€‰å™¨,å› æ­¤ç³»ç»Ÿä¼šæ£€æŸ¥è½¯ä»¶æ˜¯å¦å¤„äºè°ƒè¯•çŠ¶æ€  å³æ£€æŸ¥è°ƒè¯•ç«¯å£æ˜¯å¦å­˜åœ¨,å¦‚æœå­˜åœ¨,å¼‚å¸¸å°±ä¼šç»™è°ƒè¯•å™¨,å¦åˆ™ç»™ç­›é€‰å™¨,æ‰€ä»¥æˆ‘ä»¬åœ¨ç”¨ OD è°ƒè¯•ç­›é€‰å™¨å¼‚å¸¸æ—¶,æ˜¯ä¸å¯èƒ½å†ç­›é€‰å™¨è¿™ä¸‹æ–­ç‚¹çš„,å› æ­¤ç³»ç»Ÿæ£€æµ‹åˆ°äº†è°ƒè¯•å™¨,å¼‚å¸¸å°±ä¸ä¼šç»™ç­›é€‰å™¨ 

å› æ­¤æˆ‘ä»¬å¯ä»¥æ¬ºéª—ç³»ç»Ÿ,å‘Šè¯‰ç³»ç»Ÿ,ä¸å­˜åœ¨è°ƒè¯•å™¨,ç›´æ¥ç»™ç­›é€‰å™¨,å› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ° å¼‚å¸¸æ´¾å‘æ—¶,ç³»ç»Ÿåœ¨å“ªåˆ¤æ–­æ˜¯å¦æœ‰è°ƒè¯•å™¨å­˜åœ¨çš„,æ‰¾åˆ°åæˆ‘ä»¬å¯ä»¥æ›´æ”¹åˆ¤æ–­ç»“æœ æˆ–è€…è·³è½¬ çš„åœ°æ–¹ 

è¿™ä¸ªåœ¨ msdnä¸­æœ‰æ˜ç¡®çš„è¯´æ˜     UnhandledExceptionFilter   æ¥åˆ¤æ–­çš„

![img](./notesimg/1654089420290-9157a389-4eab-4d5d-aeb4-81da83c641f3.png)

![img](./notesimg/1654090886011-aeab0e05-9e9c-4a50-a63f-945216e21546.png)

![img](./notesimg/1654091048926-aa89990d-aef7-4a83-8dc5-f6006e0498b1.png)

![img](./notesimg/1654091200259-fed55b9d-84d2-45af-aa15-43fa208d8bb3.png)



æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦  æ›´æ”¹æ¡ä»¶è·³è½¬  ,çœ‹ ç­›é€‰å™¨å¼‚å¸¸èƒ½å¦æ–­ä¸‹æ¥ ,å°±å¯ä»¥åˆ¤æ–­æ˜¯åœ¨å“ª  åˆ¤æ–­æ˜¯å¦æœ‰ è°ƒè¯•å™¨çš„

![img](./notesimg/1654091669249-145313c4-f2a6-40b4-a176-d07697421d36.png)

![img](./notesimg/1654091760148-a9b31df1-1ebb-4445-8dfe-04bf1a329368.png)

![img](./notesimg/1654091891728-fc1bf0ac-ea37-41c2-bca2-2bfe2a02ada2.png)

![img](./notesimg/1654092072575-a5718baa-e4a1-4ed4-bd68-096f68b25f9f.png)

è·³è¿‡æµ‹è¯•å¯çŸ¥,å½“  call å‡½æ•° è¿”å›å€¼ ä¸º0  å°±å¯ä»¥æ”¶åˆ° ç­›é€‰å™¨å¼‚å¸¸,ä¸º1å°±æ— æ³•æ”¶åˆ°,é‚£ä¹ˆä½ç½®æˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†,æ¥ä¸‹æ¥æˆ‘ä»¬åªéœ€è¦æ”¹    åˆ¤æ–­ å‡½æ•°ä¸‹ä¸€è¡Œ   æŠŠ eax çš„å€¼ æ”¹ä¸º0  å°±å¯ä»¥  æ”¶åˆ° ç­›é€‰å™¨å¼‚å¸¸äº†  å³æ”¹æˆ  xor   eax,eax

![img](./notesimg/1654094969255-6b644e1c-95f1-4e61-875a-56789c18bfe7.png)



å› æ­¤æˆ‘ä»¬åªéœ€è¦å†™ä¸€ä¸ªæ’ä»¶è®©ä»–è‡ªå·±å»æ”¹



![img](./notesimg/1654093321837-b2c6ff74-439c-435b-91b5-7781fbe71e3a.png)

![img](./notesimg/1654093264778-0f6dc45a-a95a-4f2e-887c-dd957e6a64a3.png)

![img](./notesimg/1654093302242-7980fa61-f767-40ba-8e51-8201513f5bcc.png)

æ¥ä¸‹æ¥å°±æ˜¯å†™æ’ä»¶äº†

```
#include <windows.h>
#include "Plugin.h"


int ODBG_Plugindata(char* shortname) {

    strcpy_s(shortname, 32,"ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤");
    return PLUGIN_VERSION;

}


int ODBG_Plugininit(int ollydbgversion, HWND hw, ulong* features) {



    return 0;
}
```

ç”Ÿæˆè§£å†³æ–¹æ¡ˆæ—¶

![img](./notesimg/1654094212656-2a021961-1f00-449a-88a4-047286a433d4.png)

![img](./notesimg/1654094373856-76647065-89be-4054-b79f-da4c37b32b6c.png)

æŠŠç”Ÿæˆçš„ dll æ”¾åˆ°æŒ‡å®šç›®å½•,å†æ‰“å¼€ OD,å‘ç°æˆ‘ä»¬çš„æ’ä»¶å·²ç» åŠ è½½è¿›æ¥äº†

![img](./notesimg/1654094499377-87cea798-5549-4cbb-842e-dbfa6bb3bd42.png) 

æ—¢ç„¶æ’ä»¶å¯ä»¥è¯†åˆ«é‚£ä¸‹é¢å°±æ˜¯å¢åŠ åŠŸèƒ½äº†

![img](./notesimg/1654094969255-6b644e1c-95f1-4e61-875a-56789c18bfe7-170290693693822.png)

æˆ‘ä»¬çš„ç›®æ ‡æŠŠçº¢æ¡†çš„ä»£ç æ”¹æˆ  xor ,eax,eax   å³ æŠŠ  76A6D810 å¤„çš„ å€¼ æ”¹æˆ  33  ,å¦‚æœç›´æ¥å†™å›ºå®šåœ°å€,é‚£ä¹ˆç”µè„‘é‡å¯ådll çš„è·¯å¾„å°±å‘ç”Ÿè¿‡äº†æ”¹å˜,å³ è¯¥å¤„åœ°å€ä¹Ÿå˜åŒ–äº†,Nameæ’ä»¶ä¹Ÿç”¨ä¸äº†äº†,å› æ­¤æˆ‘ä»¬éœ€è¦ç”¨ç›¸å¯¹åœ°å€,å¯ä»¥å‡½æ•°åœ°å€+åç§»  æˆ–è€…  æ¨¡å—åœ°å€ + åç§»

![img](./notesimg/1654095276431-51803667-1408-459b-9760-5a5c747db15d.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°  kernelbase çš„ åœ°å€æ˜¯  768B0000   é‚£ä¹ˆ è·Ÿ   76A6D81B   çš„åç§»å€¼ä½ä¸º   0x1BD81B

```
#include <windows.h>
#include "Plugin.h"

void  FixUnHandledException();

int ODBG_Plugindata(char* shortname) 
{
    strcpy_s(shortname, 32,"ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤");
    FixUnHandledException() ;
    return PLUGIN_VERSION;

}


int ODBG_Plugininit(int ollydbgversion, HWND hw, ulong* features) 
{
    return 0;
}

void  FixUnHandledException() 
{
    //1.å®šä½ test eax,eaxçš„åœ°å€
    HMODULE hKernelbase = GetModuleHandle("Kernelbase");   
    LPBYTE pDst = (LPBYTE)hKernelbase + 0x1BD81B;
    //2.ä¿®æ”¹   test eax,eax  ä½ xor eax,eax
    DWORD dwOldPro = 0;

    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pDst, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pDst = 0x33;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pDst, 1, dwOldPro, &dwOldPro);
}
```

![img](./notesimg/1654096036078-8215f0bb-db43-4f31-8fec-9a9da2352e0c.png)

è¿è¡Œå‘ç°å¹¶æ²¡æœ‰è¢«ä¿®æ”¹,çŒœæƒ³å¯èƒ½æ˜¯å› ä¸º ä¿®æ”¹çš„å¤ªæ—©,ç¨‹åºè¿˜æ²¡æœ‰è¿è¡Œ

![img](./notesimg/1654096470752-a462c66e-316d-4cfb-8705-4a8314b98f95.png)

![img](./notesimg/1654096495387-7deed36a-6d10-49d3-8bd6-f585ac451853.png)

```
#include <windows.h>
#include "Plugin.h"

void  FixUnHandledException();
int ODBG_Paused(int reason, t_reg* reg);


int ODBG_Plugindata(char* shortname) 
{
    strcpy_s(shortname, 32,"ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤");
    
    return PLUGIN_VERSION;

}


int ODBG_Plugininit(int ollydbgversion, HWND hw, ulong* features) 
{
    return 0;
}

int ODBG_Paused(int reason, t_reg* reg)
{
    if (reason == PP_EVENT)
    {
        FixUnHandledException();
    }
    return 1;
}

void  FixUnHandledException() 
{
    //1.å®šä½ test eax,eaxçš„åœ°å€
    HMODULE hKernelbase = GetModuleHandle("Kernelbase");   
    LPBYTE pDst = (LPBYTE)hKernelbase + 0x1BD81B;
    //2.ä¿®æ”¹   test eax,eax  ä½ xor eax,eax
    DWORD dwOldPro = 0;

    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pDst, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pDst = 0x33;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pDst, 1, dwOldPro, &dwOldPro);

    //ç”¨äºåˆ¤æ–­dllæœ‰æ²¡æœ‰è¢«åŠ è½½
    MessageBox(NULL, "è¿™æ˜¯æˆ‘çš„æ’ä»¶", "æç¤º", MB_OK);
}
```

è°ƒè¯•å‘ç°è¿˜æ˜¯æ²¡æ”¹æˆåŠŸ

é‚£æ˜¯å› ä¸º OD è°ƒè¯•æ—¶æœ‰2ä¸ªè¿›ç¨‹ , æˆ‘ä»¬ä¿®æ”¹æ—¶ ä¿®æ”¹çš„æ˜¯ OD çš„è¿›ç¨‹ , å¹¶æ²¡æœ‰ä¿®æ”¹åˆ°è¢«è°ƒè¯•çš„è¿›ç¨‹,ä½†æ˜¯åœ°å€æ˜¯å¯¹çš„,å› ä¸ºåœ¨åŒä¸€å°ç”µè„‘, kernelbase çš„ åœ°å€æ˜¯å›ºå®šçš„ ,      å› æ­¤æˆ‘ä»¬éœ€è¦è·¨è¿›ç¨‹ä¿®æ”¹ å†…å­˜  OD æä¾›äº† å¯¹åº”çš„ api

å†…å­˜å‡½æ•°

ç»“æ„

OILYDBGä¸ºè¢«è°ƒè¯•ç¨‹åºä¿å­˜äº†ä¸€ä»½å·²åˆ†é…å†…å­˜å—çš„ä¿¡æ¯è¡¨,å®ƒç”±TMG

MEMORY

MEMORY*FINDMEMORY(ULONG ADDR);

VOID HAVECOPYOFMEMORY(CHAR *COPY,ULONG BASE,ULONG SIZE);

ULONG READMEMORY(VOID *BUF.ULONG ADDR.ULONG SIZE.INT MODE):

WRITEMEMORY(VOID*BUF ULONG ADDR,ULONG SIZE,INT MODE):

ULONG W

INT LISTMEMORY(VOID);

![image.png](./notesimg/1654097563163-7c9eca9f-8f0c-41f9-996c-20af641f12ba.png)





![image.png](./notesimg/1654097592537-4f0e37ca-6dd5-4e56-8150-44f760f949e0.png)

```
#include <windows.h>
#include "Plugin.h"

#pragma comment(lib,"Ollydbg.lib")
void  FixUnHandledException();
int ODBG_Paused(int reason, t_reg* reg);


int ODBG_Plugindata(char* shortname) 
{
    strcpy_s(shortname, 32,"ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤");  
    return PLUGIN_VERSION;

}


int ODBG_Plugininit(int ollydbgversion, HWND hw, ulong* features) 
{
    return 0;
}

int ODBG_Paused(int reason, t_reg* reg)
{
    if (reason == PP_EVENT)
    {
        FixUnHandledException();
    }
    return 1;
}

void  FixUnHandledException() 
{
    //1.å®šä½ test eax,eaxçš„åœ°å€
    HMODULE hKernelbase = GetModuleHandle("Kernelbase");   
    LPBYTE pDst = (LPBYTE)hKernelbase + 0x1BD81B;
   
#if 0
    //2.ä¿®æ”¹   test eax,eax  ä½ xor eax,eax
    DWORD dwOldPro = 0;
    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pDst, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pDst = 0x33;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pDst, 1, dwOldPro, &dwOldPro);
#endif // 0

    BYTE btCode = 0x33;
    Writememory(&btCode, (ulong)pDst, 1, MM_SILENT);

    //ç”¨äºåˆ¤æ–­dllæœ‰æ²¡æœ‰è¢«åŠ è½½
    ;MessageBox(NULL, "è¿™æ˜¯æˆ‘çš„æ’ä»¶", "æç¤º", MB_OK);
}
```

![img](./notesimg/1654098909479-67968de7-d155-49b6-8bbc-3629f24e4c49.png)

å†æ¬¡è°ƒè¯•,å¯ä»¥å‘ç°æˆ‘ä»¬æˆåŠŸä¿®æ”¹äº†,ç­›é€‰å™¨å¼‚å¸¸ä¹Ÿå¯ä»¥æˆåŠŸè°ƒè¯•äº† 



ä¸Šé¢è™½ç„¶æˆåŠŸäº†,ä½†æ˜¯å…¼å®¹æ€§è¿˜å­˜åœ¨é—®é¢˜,è¦æ±‚äºŒè¿›åˆ¶æ–‡ä»¶å¿…é¡»æ˜¯ä¸€æ ·,ä½†æ˜¯ä¸åŒçš„ç”µè„‘,ç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¯èƒ½ä¸ä¸€æ ·çš„,åˆ°æ—¶å…¼å®¹æ€§è¿˜æ˜¯å‡ºé—®é¢˜,è¿™ç§å¤„ç†æ–¹å¼æ˜¯æœæœºå™¨ç , å…ˆæ‰¾åˆ°ç‰¹å¾ç (ç¦»ä¿®æ”¹ä»£ç æœ€è¿‘çš„å”¯ä¸€å€¼) ,å†å»å¯»æ‰¾è¦ä¿®æ”¹çš„ä»£ç ,ä¸ç„¶ç›´æ¥æœè¦ä¿®æ”¹ä»£ç å¯èƒ½ä¼šæœ‰å¤šä¸ª  ,ç±»ä¼¼äºåˆ‡å‰²å‡ºæŒ‡å®šå­—ç¬¦ä¸²





### çª—å£è¿‡ç¨‹å‡½æ•°åœ°å€é”™è¯¯

OD å¦‚æœæ²¡æœ‰å®‰è£…ä¿®å¤æ’ä»¶å•Š,æœ‰äº› çª—å£çš„è¿‡ç¨‹å‡½æ•°åœ°å€æ˜¯é”™è¯¯çš„      çœ‹é›ªä¸‹è½½çš„å·²ç»ä¿®å¤

![img](./notesimg/1654099799355-801d4b78-f1b4-4612-a297-15a7d1f3ccc3.png)

è·å–è¿‡ç¨‹å‡½æ•°çš„åœ°å€æœ‰2ç§

ä¸€ç§æ˜¯é€šè¿‡   GetWindowLong  è·å¾—     ä¸€ç§æ˜¯é€šè¿‡  GetClassLong  

é€šè¿‡OD è°ƒ  OD  å¯¹   GetWindowLong   å’Œ   GetClassLong   ä¸‹æ–­ç‚¹

å¯ä»¥çŸ¥é“æ˜¯é€šè¿‡   GetClassLongA æ‹¿åˆ°çš„,å› æ­¤å¯ä»¥çŒœæƒ³ æ˜¯å› ä¸º     GetClassLongA   æ‹¿çš„æ˜¯ å¤šå­—èŠ‚çš„çª—å£è¿‡ç¨‹å‡½æ•° è€ŒUnicode çª—å£ è·å– è¿‡ç¨‹å‡½æ•°éœ€è¦ç”¨  GetClassLongW,å› æ­¤åªéœ€è¦åœ¨è·å– Unicode çª—å£  è¿‡ç¨‹å‡½æ•°æ˜¯æ˜¯ ç”¨ GetClassLongW å°±å¯ä»¥äº†

è·Ÿçª—å£ç›¸å…³çš„å‡½æ•°éƒ½åœ¨  user32 é‡Œé¢ ,è·Ÿç•Œé¢ç›¸å…³çš„ éƒ½åœ¨ user32 é‡Œé¢



![img](./notesimg/1654104739474-ea9deca1-0579-4589-8aea-a1381cbac58f.png)

è°ƒè¯•å¯çŸ¥  GetClassLong è°ƒå–çš„éƒ½æ˜¯è¯¥å¤„çš„ GetClassLongA ,å› æ­¤æˆ‘ä»¬åªéœ€è¦æ”¹åŠ¨è¿™é‡Œå°±å¯ä»¥äº†

![img](./notesimg/1654104875900-883d25ee-bff7-4868-8932-d1d50109ffc7.png)

![img](./notesimg/1654104947987-ee7dc8b5-13e9-47d5-80f2-f68681d4a1d1.png)

jmpæ˜¯ä¸€ä¸ªé—´æ¥è°ƒ,å…ˆå–åœ°å€,åœ¨è·³åˆ°ç›®æ ‡ä½ç½®,å› æ­¤æˆ‘ä»¬æ”¹è¯¥å¤„åœ°å€å°±å¯ä»¥äº†,

æˆ‘ä»¬è‡ªå·±å¯ä»¥å®ç°ä¸€ä¸ª MyGetClassLong  ç„¶åæŠŠåœ°å€ä¼ è¿‡æ¥è¿™æ ·ä»–å°±ä¼šè°ƒæˆ‘ä»¬çš„å‡½æ•°,æˆ‘ä»¬åªéœ€è¦åšä¸€ä¸‹åˆ¤æ–­æ˜¯ å¤šå­—èŠ‚çª—å£è¿˜æ˜¯ Unicode å°±å¯ä»¥äº†

è¯¥å¤„åœ°å€çš„æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ é€šè¿‡ç®—åç§»å¾—åˆ° ,å› ä¸º OD ç‰ˆæœ¬ä¸€æ ·,æ‰€ä»¥åç§»ä¹Ÿæ˜¯ä¸€æ ·çš„

![img](./notesimg/1654105273184-4825ee76-fe58-4192-8896-bc380242e045.png)

æ‰€ä»¥åç§»æ˜¯    0x0050D858 - 0x00400000 =  0x0010D858

```
#include <windows.h>
#include "Plugin.h"

#pragma comment(lib,"Ollydbg.lib")
void  FixUnHandledException();
int ODBG_Paused(int reason, t_reg* reg);
void FixGetClassLong();

int ODBG_Plugindata(char* shortname) 
{
    strcpy_s(shortname, 32,"ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤");  
    return PLUGIN_VERSION;

}


int ODBG_Plugininit(int ollydbgversion, HWND hw, ulong* features) 
{
    FixGetClassLong();
    return 0;
}

int ODBG_Paused(int reason, t_reg* reg)
{
    if (reason == PP_EVENT)
    {
        FixUnHandledException();
    }
    return 1;
}

void  FixUnHandledException() 
{
    //1.å®šä½ test eax,eaxçš„åœ°å€
    HMODULE hKernelbase = GetModuleHandle("Kernelbase");   
    LPBYTE pDst = (LPBYTE)hKernelbase + 0x1BD81B;
   
#if 0
    //2.ä¿®æ”¹   test eax,eax  ä½ xor eax,eax
    DWORD dwOldPro = 0;
    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pDst, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pDst = 0x33;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pDst, 1, dwOldPro, &dwOldPro);
#endif // 0

    BYTE btCode = 0x33;
    Writememory(&btCode, (ulong)pDst, 1, MM_SILENT);

    //ç”¨äºåˆ¤æ–­dllæœ‰æ²¡æœ‰è¢«åŠ è½½
    //MessageBox(NULL, "è¿™æ˜¯æˆ‘çš„æ’ä»¶", "æç¤º", MB_OK);
}

LONG MyGetClassLong(HWND hWnd,int nIndex)
{
    if (IsWindowUnicode(hWnd))  // åˆ¤æ–­ä¸€ä¸ªçª—å£æ˜¯å¦æ˜¯ unicodeçª—å£
    {
        return GetClassLongW(hWnd, nIndex);
    }
    else
    {
        return GetClassLongA(hWnd, nIndex);
    }


}

void FixGetClassLong()
{
    //1.å®šä½åœ°å€
    HMODULE Hod = GetModuleHandle(NULL);  //è·å–ä¸»æ¨¡å—åŸºå€(OD)
    LPDWORD pAddr =(LPDWORD)((LPBYTE)Hod + 0x10D858);

    //2.ä¿®æ”¹ä¸ºè‡ªå·±çš„åœ°å€
    DWORD dwOldPro = 0;
    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pAddr, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pAddr = (DWORD)MyGetClassLong;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pAddr, 1, dwOldPro, &dwOldPro);

}
```

è°ƒè¯•ä¼šå‘ç°ä¼šå´©, ä»£ç æ²¡å´©,ä½†æ˜¯è¿è¡Œäº†ä¸€æ®µæ—¶é—´å°±å´©ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ ˆæ­ªäº†

ç»è¿‡è°ƒè¯•,è¿˜æœ‰2ä¸ªå‚æ•°åœ¨æ ˆä¸Š



ç³»ç»Ÿçš„api ä¸€èˆ¬éƒ½æ˜¯æ ‡å‡†è°ƒç”¨çº¦å®š,  ä½†æ˜¯æˆ‘ä»¬è‡ªå·±çš„ä»£ç éœ€è¦è‡ªå·±å»å¹³æ ˆ, å› æ­¤è¦æ”¹åŠ¨è°ƒç”¨çº¦å®š  æ”¹æˆ stdcall

```
#include <windows.h>
#include "Plugin.h"

#pragma comment(lib,"Ollydbg.lib")
void  FixUnHandledException();
int ODBG_Paused(int reason, t_reg* reg);
void FixGetClassLong();

int ODBG_Plugindata(char* shortname) 
{
    strcpy_s(shortname, 32,"ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤");  
    return PLUGIN_VERSION;

}


int ODBG_Plugininit(int ollydbgversion, HWND hw, ulong* features) 
{
    FixGetClassLong();
    return 0;
}

int ODBG_Paused(int reason, t_reg* reg)
{
    if (reason == PP_EVENT)
    {
        FixUnHandledException();
    }
    return 1;
}

void  FixUnHandledException() 
{
    //1.å®šä½ test eax,eaxçš„åœ°å€
    HMODULE hKernelbase = GetModuleHandle("Kernelbase");   
    LPBYTE pDst = (LPBYTE)hKernelbase + 0x1BD81B;
   
#if 0
    //2.ä¿®æ”¹   test eax,eax  ä½ xor eax,eax
    DWORD dwOldPro = 0;
    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pDst, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pDst = 0x33;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pDst, 1, dwOldPro, &dwOldPro);
#endif // 0

    BYTE btCode = 0x33;
    Writememory(&btCode, (ulong)pDst, 1, MM_SILENT);

    //ç”¨äºåˆ¤æ–­dllæœ‰æ²¡æœ‰è¢«åŠ è½½
    //MessageBox(NULL, "è¿™æ˜¯æˆ‘çš„æ’ä»¶", "æç¤º", MB_OK);
}

LONG WINAPI MyGetClassLong(HWND hWnd,int nIndex)
{
    if (IsWindowUnicode(hWnd))  // åˆ¤æ–­ä¸€ä¸ªçª—å£æ˜¯å¦æ˜¯ unicodeçª—å£
    {
        return GetClassLongW(hWnd, nIndex);
    }
    else
    {
        return GetClassLongA(hWnd, nIndex);
    }
}

void FixGetClassLong()
{
    //1.å®šä½åœ°å€
    HMODULE Hod = GetModuleHandle(NULL);  //è·å–ä¸»æ¨¡å—åŸºå€(OD)
    LPDWORD pAddr =(LPDWORD)((LPBYTE)Hod + 0x10D858);

    //2.ä¿®æ”¹ä¸ºè‡ªå·±çš„åœ°å€
    DWORD dwOldPro = 0;
    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pAddr, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pAddr = (DWORD)MyGetClassLong;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pAddr, 1, dwOldPro, &dwOldPro);

}
```

å†å»è°ƒè¯•,å‘ç°å¯ä»¥è·å–æ­£ç¡®çš„ çª—å£è¿‡ç¨‹å‡½æ•°åœ°å€äº†

![img](./notesimg/1654106540969-55a4a4bd-6f84-44c0-ace7-8a62a9268ddd.png)





x32dbg ä¹Ÿå¯ä»¥å†™æ’ä»¶

![img](./notesimg/1654107504780-3d4b7163-d3ca-4e0c-92a8-9ab939f0f182.png)

![img](./notesimg/1654107577543-95bb798f-0887-4218-9caa-54c0cba37155.png)



### ä½œä¸š

#####    ä¿®å¤ODä¸èƒ½æ–­ç­›é€‰å™¨å¼‚å¸¸çš„bugï¼Œå…¼å®¹win10å’Œwin7ã€‚

æ€è·¯,å…ˆå®šä½åˆ°å‡½æ•°å…¥å£,å†å»æ‰¾ç‰¹å¾ç  , å†å»æœè¦ä¿®æ”¹çš„ä»£ç , ç›´åˆ°  ret ç»“æŸ

win10 å’Œ win7 ç‰¹å¾ç ä¸ä¸€æ ·,éœ€è¦åˆ†åˆ«è®¾å®š

```
#include <windows.h>
#include "Plugin.h"
#include <string>

#pragma comment(lib,"Ollydbg.lib")
void  FixUnHandledException();
int ODBG_Paused(int reason, t_reg* reg);
void FixGetClassLong();
void  FixUnHandledExceptionByKey();

using namespace std;
string getSystemName()
{
    string vname;
    //å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºwin8.1æˆ–win10
    typedef void(__stdcall* NTPROC)(DWORD*, DWORD*, DWORD*);
    HINSTANCE hinst = LoadLibrary("ntdll.dll");
    DWORD dwMajor, dwMinor, dwBuildNumber;
    NTPROC proc = (NTPROC)GetProcAddress(hinst, "RtlGetNtVersionNumbers");
    proc(&dwMajor, &dwMinor, &dwBuildNumber);

    if (dwMajor == 10 && dwMinor == 0)	//win 10
    {

        return "Win10";
    }

    SYSTEM_INFO info;                //ç”¨SYSTEM_INFOç»“æ„åˆ¤æ–­64ä½AMDå¤„ç†å™¨  
    GetSystemInfo(&info);            //è°ƒç”¨GetSystemInfoå‡½æ•°å¡«å……ç»“æ„  
    OSVERSIONINFOEX os;
    os.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEX);
#pragma warning(disable:4996)
    if (GetVersionEx((OSVERSIONINFO*)&os))
    {

        //ä¸‹é¢æ ¹æ®ç‰ˆæœ¬ä¿¡æ¯åˆ¤æ–­æ“ä½œç³»ç»Ÿåç§°  
        switch (os.dwMajorVersion)
        {                        //åˆ¤æ–­ä¸»ç‰ˆæœ¬å·  

        case 6:
            switch (os.dwMinorVersion)
            {

            case 1:
                if (os.wProductType == VER_NT_WORKSTATION)
                {
                    return "Win7";
                }
                break;
            }
            break;
        default:
            vname = "æœªçŸ¥æ“ä½œç³»ç»Ÿ";
        }

    }
    return vname;
}

int ODBG_Plugindata(char* shortname) 
{
    strcpy_s(shortname, 32,"ç­›é€‰å™¨å¼‚å¸¸ä¿®å¤");  
    return PLUGIN_VERSION;

}


int ODBG_Plugininit(int ollydbgversion, HWND hw, ulong* features) 
{
    FixGetClassLong();
    return 0;
}

int ODBG_Paused(int reason, t_reg* reg)
{
    if (reason == PP_EVENT)
    {
        //FixUnHandledException();
        FixUnHandledExceptionByKey();
    }
    return 1;
}

void  FixUnHandledExceptionByKey() 
{
    string strSystemName = getSystemName();   //åˆ¤æ–­ç³»ç»Ÿ
    string strModule;
    
    if (strSystemName == "Win10")
    {
        strModule = "Kernelbase";
    }else  if (strSystemName == "Win10")
    {
        strModule = "Kernel32";
    }
    //1.å®šä½ test eax,eaxçš„åœ°å€
    HMODULE hKernelbase = GetModuleHandle(strModule.c_str());
   
    LPBYTE pAddr = (LPBYTE)GetProcAddress(hKernelbase, "UnhandledExceptionFilter");
    BYTE bDate= *pAddr;
    BOOL isGetSing = FALSE;
    //0x8BC683F8   ç‰¹å¾ç 
    //0x85         è¦ä¿®æ”¹çš„ä»£ç 
    //0x33         ä¿®æ”¹åçš„ä»£ç 
    //0xC3         ç»“æŸ
    while (bDate == 0xC3) {
       DWORD dwSignature = (DWORD)*pAddr;
        
        //æœ‰é—®é¢˜,2ä¸ªç³»ç»Ÿç‰¹å¾ç ä¸ä¸€æ ·,éœ€è¦åˆ†åˆ«è®¾ç½®
       if (dwSignature == 0x8BC683F8)
       {
           isGetSing = TRUE;
       }
       pAddr++;
       bDate = *pAddr;
       if (isGetSing)
       {
           if (bDate == 0x85)
           {
               BYTE btCode = 0x33;
               Writememory(&btCode, (ulong)pAddr, 1, MM_SILENT);
               return;
           }
       }
    }
}


void  FixUnHandledException()
{
    //1.å®šä½ test eax,eaxçš„åœ°å€
    HMODULE hKernelbase = GetModuleHandle("Kernelbase");
    LPBYTE pDst = (LPBYTE)hKernelbase + 0x1BD81B;

#if 0
    //2.ä¿®æ”¹   test eax,eax  ä½ xor eax,eax
    DWORD dwOldPro = 0;
    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pDst, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pDst = 0x33;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pDst, 1, dwOldPro, &dwOldPro);
#endif // 0

    BYTE btCode = 0x33;
    Writememory(&btCode, (ulong)pDst, 1, MM_SILENT);

    //ç”¨äºåˆ¤æ–­dllæœ‰æ²¡æœ‰è¢«åŠ è½½
    //MessageBox(NULL, "è¿™æ˜¯æˆ‘çš„æ’ä»¶", "æç¤º", MB_OK);
}

LONG WINAPI MyGetClassLong(HWND hWnd,int nIndex)
{
    if (IsWindowUnicode(hWnd))  // åˆ¤æ–­ä¸€ä¸ªçª—å£æ˜¯å¦æ˜¯ unicodeçª—å£
    {
        return GetClassLongW(hWnd, nIndex);
    }
    else
    {
        return GetClassLongA(hWnd, nIndex);
    }
}

void FixGetClassLong()
{
    //1.å®šä½åœ°å€
    HMODULE Hod = GetModuleHandle(NULL);  //è·å–ä¸»æ¨¡å—åŸºå€(OD)
    LPDWORD pAddr =(LPDWORD)((LPBYTE)Hod + 0x10D858);

    //2.ä¿®æ”¹ä¸ºè‡ªå·±çš„åœ°å€
    DWORD dwOldPro = 0;
    //ä¿®æ”¹å†…å­˜å±æ€§
    VirtualProtect(pAddr, 1, PAGE_EXECUTE_READWRITE, &dwOldPro);
    *pAddr = (DWORD)MyGetClassLong;
    //è¿˜åŸå†…å­˜å±æ€§
    VirtualProtect(pAddr, 1, dwOldPro, &dwOldPro);

}
```

