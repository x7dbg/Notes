## x64è°ƒç”¨çº¦å®š

x86åº”ç”¨ç¨‹åºçš„å‡½æ•°è°ƒç”¨æœ‰stdcallã€_cdeclã€Fastcallç­‰æ–¹å¼ï¼Œä½†x64åº”ç”¨ç¨‹åºåªæœ‰1ç§å¯„å­˜å™¨å¿«é€Ÿè°ƒç”¨çº¦å®šã€‚å‰4ä¸ªå‚æ•°ä½¿ç”¨å¯„å­˜å™¨ä¼ é€’ï¼Œå¦‚æœå‚æ•°è¶…è¿‡4ä¸ªï¼Œå¤šä½™çš„å‚æ•°å°±æ”¾åœ¨æ ˆé‡Œï¼Œäººæ ˆé¡ºåºä¸ºä»å³åˆ°å·¦ï¼Œç”±å‡½æ•°è°ƒç”¨æ–¹å¹³è¡¡æ ˆç©ºé—´ã€‚å‰4ä¸ªå‚æ•°å­˜æ”¾çš„å¯„å­˜å™¨æ˜¯å›ºå®šçš„ï¼Œåˆ†åˆ«æ˜¯ç¬¬1ä¸ªå‚æ•°RCXã€ç¬¬2ä¸ªå‚æ•° RDXã€ç¬¬3ä¸ªå‚æ•°R8ã€ç¬¬4ä¸ªå‚æ•°R9ï¼Œå…¶ä»–å‚æ•°ä»å³å¾€å·¦ä¾æ¬¡å…¥æ ˆã€‚ä»»ä½•å¤§äº8å­—èŠ‚æˆ–è€…ä¸æ˜¯1å­—èŠ‚ã€2å­—èŠ‚ã€4å­—èŠ‚ã€8å­—èŠ‚çš„å‚æ•°å¿…é¡»ç”±å¼•ç”¨æ¥ä¼ é€’ï¼ˆåœ°å€ä¼ é€’)ã€‚æ‰€æœ‰æµ®ç‚¹å‚æ•°çš„ä¼ é€’éƒ½æ˜¯ä½¿ç”¨XMMå¯„å­˜å™¨å®Œæˆçš„ï¼Œå®ƒä»¬åœ¨XMMOã€XMM1ã€XMM2å’Œ XMM3ä¸­ä¼ é€’ï¼Œå¦‚è¡¨4.9æ‰€ç¤ºã€‚

![img](notesimg/1642604447899-a7054f87-6752-4782-befa-63bbafeec701.png)

å‡½æ•°çš„å‰4ä¸ªå‚æ•°è™½ç„¶ä½¿ç”¨å¯„å­˜å™¨æ¥ä¼ é€’ï¼Œä½†æ˜¯æ ˆä»ç„¶ä¸ºè¿™4ä¸ªå‚æ•°é¢„ç•™äº†ç©ºé—´( 32å­—èŠ‚),ä¸ºæ–¹ä¾¿æè¿°ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºé¢„ç•™æ ˆç©ºé—´ã€‚åœ¨x64ç¯å¢ƒé‡Œï¼Œå‰4ä¸ªå‚æ•°ä½¿ç”¨å¯„å­˜å™¨ä¼ é€’ï¼Œå› æ­¤åœ¨å‡½æ•°å†…éƒ¨è¿™4ä¸ªå¯„å­˜å™¨å°±ä¸èƒ½ä½¿ç”¨äº†ï¼Œç›¸å½“äºå‡½æ•°å°‘äº†4ä¸ªå¯ç”¨çš„é€šç”¨å¯„å­˜å™¨ã€‚å½“å‡½æ•°åŠŸèƒ½æ¯”è¾ƒå¤æ‚æ—¶ï¼Œè¿™å¯èƒ½å¯¼è‡´å¯„å­˜å™¨ä¸å¤Ÿç”¨ã€‚ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨é¢„ç•™æ ˆç©ºé—´ï¼Œæ–¹æ³•æ˜¯å‡½æ•°è°ƒç”¨è€…å¤šç”³è¯·32å­—èŠ‚çš„æ ˆç©ºé—´ï¼Œå½“å‡½æ•°å¯„å­˜å™¨ä¸å¤Ÿç”¨æ—¶ï¼Œå¯ä»¥æŠŠå¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ°åˆšæ‰ç”³è¯·çš„æ ˆç©ºé—´ä¸­ã€‚é¢„ç•™æ ˆç©ºé—´ç”±å‡½æ•°è°ƒç”¨è€…æå‰ç”³è¯·ã€‚ç”±å‡½æ•°è°ƒç”¨è€…è´Ÿè´£å¹³è¡¡æ ˆç©ºé—´ã€‚

å‡½æ•°è°ƒç”¨åï¼Œå¯„å­˜å™¨å’Œå†…å­˜çš„æƒ…å†µå¦‚å›¾4.19æ‰€ç¤ºã€‚

![img](notesimg/1642604473739-f81526bd-2df4-4482-af4f-1d8f898ba8b2.png)

## ä¼ å‚(å‡½æ•°è°ƒç”¨çº¦å®š)  

https://docs.microsoft.com/zh-cn/cpp/build/x64-calling-convention?view=msvc-170

æ‰€æœ‰ä¼ å‚å¦‚æœè¦push,å¿…é¡»è¦æŠ¬æ ˆä¹‹å‰,è€Œä¸”åªæœ‰ä¸€æ¬¡ push æœºä¼š

### å‚æ•°å…¨éƒ¨ä¸ºæ•´å½¢

#### å‚æ•°æ•°é‡å°äº4ä¸ª

```cpp
int Add (int nNum1, int nNum2)
{
	return nNuml + nNum2 ;
}

int main ()
{
    printf ( "%d\r\n", Add (1,2) ) ;
    return 0;
}
```

##### DEBUG

###### main()

![img](notesimg/1642604673902-32c6b0a7-e637-4eae-9b6b-d5398a239cbf.png)

###### Add()

![img](notesimg/1642604691183-455a43ab-d609-400a-9d66-aa8497fbbb66.png)

åœ¨æœ¬å®ä¾‹ä¸­ï¼Œä¸¤ä¸ªå‚æ•°é€šè¿‡å¯„å­˜å™¨è¿›è¡Œä¼ é€’ï¼Œç¬¬1ä¸ªå‚æ•°ä¸ºECXã€ç¬¬2ä¸ªå‚æ•°ä¸ºEDXï¼Œä½†åœ¨æ ˆä¸­ä»ä¸ºå®ƒä»¬é¢„ç•™äº†4ä¸ªå‚æ•°å¤§å°çš„ç©ºé—´ï¼Œç”³è¯·äº†32å­—èŠ‚(20h = 32d =4ä¸ªå‚æ•°Ã—8å­—èŠ‚)çš„é¢„ç•™æ ˆç©ºé—´ã€‚

è¿™ä¸ªä¾‹å­ä¸­ä½¿ç”¨çš„æ˜¯ Debug ç‰ˆçš„æ±‡ç¼–ä»£ç ã€‚å½“ç¨‹åºè¢«ç¼–è¯‘æˆReleaseç‰ˆæ—¶ï¼Œå‡½æ•°å‚æ•°çš„ä¼ é€’å¹¶æ— æœ¬è´¨åŒºåˆ«ã€‚å½“å¼€å¯å†…è”å‡½æ•°æ‰©å±•ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹æ—¶ï¼Œå‡½æ•°å¯èƒ½ä¼šè¿›è¡Œå†…è”æ‰©å±•ä¼˜åŒ–ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å°†å¯è®¡ç®—ç»“æœçš„å˜é‡è½¬æ¢æˆå¸¸é‡ï¼Œä»£ç å¦‚ä¸‹ã€‚

![img](notesimg/1642604717007-beb3226e-eee3-4da4-8b9c-d9b21c00b4ab.png)





#### å‚æ•°æ•°é‡å¤§äºå››ä¸ª

```cpp
#include <stdio.h>
int Add(int nNum1,int nNum2,int nNum3,int nNum4,int nNum5,int nNum6)
{
    return nNum1 + nNum2 + nNum3 + nNum4 + nNum5 + nNum6;
}

int main()
{
    printf("%d\r\n", Add(1, 2, 3, 4, 5, 6));
    return 0;
}
```

##### DEBUG

###### main()

![img](notesimg/1642604850598-cc263676-f98b-487d-b5be-cba7a10acded.png)

å› ä¸ºè°ƒè¯•æ˜¯å¯èƒ½å¯¹ å‰é¢å‚æ•°å–åœ°å€,å› æ­¤å¿…é¡»æ‹·è´åˆ°æ ˆé¢„ç•™ç©ºé—´

###### Add()

![img](notesimg/1642604864058-f6294e65-066c-4f73-bb47-47ec4a341204.png)

![img](notesimg/1642604870654-311c8ec0-39c5-450e-ac4f-5e19d859cb6b.png)

-   ä»æœ¬ä¾‹ä¸­å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå‚æ•°å¤šäº4ä¸ªï¼Œå‰4ä¸ªå‚æ•°é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œä»ç¬¬5ä¸ªå‚æ•°å¼€å§‹ä½¿ç”¨æ ˆä¼ é€’ï¼ŒæŒ‡ä»¤ä¸ºâ€œmov dword ptr [rsp+20h], 5â€ã€‚ç”±äºæ ˆä¸ºå‰4ä¸ªå‚æ•°é¢„ç•™äº†å¤§å°ç›¸åŒçš„æ ˆç©ºé—´ï¼Œç”³è¯·äº†32å­—èŠ‚(20h = 32d=4ä¸ªå‚æ•°Ã—8å­—èŠ‚)çš„é¢„ç•™æ ˆç©ºé—´ï¼Œç¬¬5ä¸ªå‚æ•°ä»æ ˆçš„[rsp+20h]å¤„å¼€å§‹ä¿å­˜ã€‚å‚æ•°ä½¿ç”¨çš„æ ˆç©ºé—´ç”±å‡½æ•°è°ƒç”¨è€…è´Ÿè´£å¹³è¡¡ã€‚





### å‚æ•°å…¨éƒ¨ä¸ºæµ®ç‚¹

printf ä¸æ”¯æŒ float  ,   %f å’Œ   %lf éƒ½æ˜¯  double , printf è¾“å‡º float æ˜¯, ä¼šå‘é€éšå¼è½¬æ¢,è½¬æˆdouble

```c++
#include <stdio.h>

double Add(float a, double b, float c, double d, float e, float f) {
    return a + b + c + d + e + f;
}
int main()
{
    printf("add2 %f\n", Add(1.0f, 2.0, 3.0f, 4.0, 5.0f, 6.0f));
    return 0;
}
```

```
RELEASE
main
å‰å››ä¸ªå‚æ•°èµ°å¤šåª’ä½“å¯„å­˜å™¨ xmm0 ~ xmm3
sub     rsp, 38h
movss   xmm1, cs:dword_140002234       //ç¬¬5ä¸ªå‚æ•°
movss   xmm0, cs:dword_140002238      //ç¬¬6ä¸ªå‚æ•°
movsd   xmm3, cs:qword_140002228     //ç¬¬4ä¸ªå‚æ•°
movss   xmm2, cs:dword_140002230      //ç¬¬3ä¸ªå‚æ•°
movss   dword ptr [rsp+28h], xmm0      //æŠŠç¬¬6ä¸ªå‚æ•°çš„æ”¾åˆ°æ ˆé‡Œé¢,å…ˆæŠŠ å‚æ•°6æ”¾å¯„å­˜å™¨ï¼Œç„¶åé€šè¿‡å¯„å­˜å™¨                                                                                æ”¾å…¥æ ˆé‡Œï¼Œå†æŠŠå‚æ•°1æ”¾åˆ°å¯„å­˜å™¨é‡Œ  
movss   xmm0, cs:dword_14000221C    //ç¬¬1å‚æ•°
movss   dword ptr [rsp+20h], xmm1      //æŠŠç¬¬5ä¸ªå‚æ•°çš„æ”¾åˆ°æ ˆé‡Œé¢
movsd   xmm1, cs:qword_140002220    //ç¬¬2å‚æ•°
call    sub_140001000
movaps  xmm1, xmm0            //å°† è¿”å›å€¼ xmm0  ç»™ xmm1 åšä¸ºå‚æ•°,å› æ­¤æ˜¯ç¬¬äºŒä¸ªå‚æ•°  ,æ‰€ä»¥è¦ç”¨xmm1      lea     rcx, aAdd2F     ; "add2 %f\n"
movq    rdx, xmm0
call    sub_140001110
xor     eax, eax
add     rsp, 38h
retn
add
cvtss2sd xmm0, xmm0      //å‚æ•°1 è½¬ç±»å‹,float è½¬ double
addsd   xmm0, xmm1
xorps   xmm1, xmm1
cvtss2sd xmm1, xmm2    
movss   xmm2, dword ptr [rsp+30h] 
addsd   xmm0, xmm1
movss   xmm1, dword ptr [rsp+28h]
cvtps2pd xmm1, xmm1
addsd   xmm0, xmm3
cvtps2pd xmm2, xmm2
addsd   xmm0, xmm1
addsd   xmm0, xmm2
retn
å‚æ•°ä¸ºæ•´å‹æµ®ç‚¹æ··åˆ
å‰å››ä¸ªå‚æ•°  æ•´å½¢ ç”¨ é€šç”¨å¯„å­˜å™¨  ,æµ®ç‚¹ç”¨å¤šåª’ä½“å¯„å­˜å™¨,åé¢åå‚æ•°éƒ½æ˜¯å…¥æ ˆ
```

```c++
#include <stdio.h>

double Add(int a, double b, int c, float d, int e, int f) {
    return a + b + c + d + e + f;
}
int main()
{
    printf("add2 %f\n", Add(1, 2, 3, 4, 5, 6));
    return 0;
}
```

```
RELEASE
main
sub     rsp, 38h
movss   xmm3, cs:dword_140002228       //ç¬¬4ä¸ªå‚æ•°
mov     r8d, 3                                                   //ç¬¬3å‚æ•°
movsd   xmm1, cs:qword_140002220      //ç¬¬2å‚æ•°
mov     dword ptr [rsp+28h], 6                  //ç¬¬6å‚æ•°
mov     dword ptr [rsp+20h], 5                  //ç¬¬5å‚æ•°
lea     ecx, [r8-2]                                             //ç¬¬1å‚æ•°
call    sub_140001000
movaps  xmm1, xmm0
lea     rcx, aAdd2F     ; "add2 %f\n"
movq    rdx, xmm0
call    sub_140001100
xor     eax, eax
add     rsp, 38h
retn
add
xorps   xmm0, xmm0
xorps   xmm2, xmm2
cvtsi2sd xmm0, ecx
cvtss2sd xmm2, xmm3
addsd   xmm0, xmm1
xorps   xmm1, xmm1
cvtsi2sd xmm1, r8d
addsd   xmm0, xmm1
xorps   xmm1, xmm1
cvtsi2sd xmm1, dword ptr [rsp+28h]
addsd   xmm0, xmm2
xorps   xmm2, xmm2
cvtsi2sd xmm2, dword ptr [rsp+30h]
addsd   xmm0, xmm1
addsd   xmm0, xmm2
retn
```

### å‚æ•°æ˜¯å˜å‚ 

å¦‚æœæœ‰æµ®ç‚¹å‚æ•°,å°†ä¼šèµ° é€šç”¨å¯„å­˜å™¨,ä¸ä¼šèµ°å¤šåª’ä½“å¯„å­˜å™¨ä¼ å‚

å…ˆæŠŠæµ®ç‚¹æ•°çš„å€¼ç»™å¤šåª’ä½“å¯„å­˜å™¨  ,å†é€šè¿‡å¤šåª’ä½“å¯„å­˜å™¨ç»™é€šç”¨å¯„å­˜å™¨

```c++
#include <stdio.h>
#include <varargs.h>

void Show(int args, ...) {
    va_list argList;
    va_start(argList); //argList = rsp
    va_arg(argList, int);
    for (int i = 0; i < args; i++) {
        printf("%d ", va_arg(argList, int));  //*(int*)rsp  rsp+=4
    }
    va_end(argList);
}

int main()
{
    Show(4, 1, 2, 3,4);   //ç¬¬ä¸€ä¸ªå‚æ•° æ˜¯ å˜å‚å‚æ•°ä¸ªæ•°
    return 0;
}
```

```
RELEASE
main
sub     rsp, 38h
mov     edx, 1               //ç¬¬2ä¸ªå‚æ•°
mov     dword ptr [rsp+20h], 4       //ç¬¬5ä¸ªå‚æ•°
lea     r9d, [rdx+2]      //ç¬¬4ä¸ªå‚æ•°
lea     r8d, [rdx+1]      //ç¬¬3ä¸ªå‚æ•°
lea     ecx, [rdx+3]       //ç¬¬1ä¸ªå‚æ•°
call    sub_140001000
xor     eax, eax
add     rsp, 38h
retn
show
	 test    ecx, ecx
	 jle     short locret_140001051
        //å‚æ•°è½¬å…¥æ ˆé¡¶  ä» 8å¼€å§‹ å› ä¸º å‰é¢æ˜¯è¿”å›åœ°å€ ,å¯¹äºå˜å‚å‡½æ•°æ¥è¯´,å…¥å£ä¸€å®šä¼šæœ‰è¿™å››è¡Œä»£ç 
	 mov     [rsp+8], ecx
	 mov     [rsp+10h], rdx
	 mov     [rsp+18h], r8
	mov     [rsp+20h], r9
	 push    rbx
	 push    rdi
	 sub     rsp, 28h
lea     rbx, [rsp+40h]    //  va_start     è¿™é‡Œæ˜¯40 æ˜¯å› ä¸º 10 ( 2ä¸ªpush ) + 28 (sub) +  8 (å¯¹å…¶)
                                        //  rbx  å°±æ˜¯  argList  è¡¨ç¤ºå‚æ•°æ ˆé¡¶
	 xor     edi, edi
	 nop     dword ptr [rax+00h]
	 nop     dword ptr [rax+rax+00000000h]
loc_140001030:          //å¾ªç¯å–å†…å®¹              
	 mov     edx, [rbx+8]     ;å–æ ˆé¡¶å†…å®¹
	 lea     rbx, [rbx+8]
	 lea     rcx, unk_140002210
	 call    sub_140001100
	 inc     edi
	 cmp     edi, [rsp+40h]
	 jl      short loc_140001030
	 add     rsp, 28h
	 pop     rdi
	 pop     rbx
locret_140001051:                      
	 retn
```

### å‚æ•°æ˜¯ç»“æ„ä½“

ä¼ ç»“æ„ä¼šæœ‰ä¸€ä¸ªæ ˆé¡¶çš„æ‹·è´,ç„¶åä¼ ç»“æ„çš„åœ°å€

#### ç»“æ„ä½“å¤§å°ä¸º 4å­—èŠ‚

é€šè¿‡å¯„å­˜å™¨ä¼ å‚

```cpp
struct s {
    int i;

};
//ç»“æ„ä½“ ä¸è¶…è¿‡8ä¸ªå­—èŠ‚  å¯„å­˜å™¨ä¼ å‚
void Show1(struct s a) {
    printf("%p  %d\n",&a, a.i );
}

ä¸Šé¢å°±ç±»ä¼¼äº
void Show1(int a) {
    int n = a;
    printf("%p  %d\n",&n, n );
}
```

#### ç»“æ„ä½“å¤§å°ä¸å¤§äº8å­—èŠ‚

æŠŠæˆå‘˜å½“ä½œ  longlong ï¼Œåœ¨é€šè¿‡å¯„å­˜å™¨ä¼ å€¼ ,å†…éƒ¨é€šè¿‡ç§»ä½æ¥è·å–é«˜32ä½ å’Œ ä½ 32ä½çš„å€¼

```c++
#include <stdio.h>

struct s {
    int i;
    int j;
};
//ç»“æ„ä½“ ä¸è¶…è¿‡8ä¸ªå­—èŠ‚  å¯„å­˜å™¨ä¼ å‚
void Show1(struct s a) {
    printf("%d %d\n", a.i, a.j);
}




int main()
{
   struct s a1 = {1, 2};
   Show1(a1);
   return 0;
}
```

```
DEBUG
main
mov     dword ptr [rbp+8], 1      //rbp+8 ç»“æ„ä½“é¦–åœ°å€  æ”¾å…¥ç¬¬1ä¸ªå‚æ•°
mov     dword ptr [rbp+0Ch], 2   // æ”¾å…¥ç¬¬2ä¸ªå‚æ•°
mov     rcx, [rbp+8]    ; a                //è¿™é‡Œæ˜¯mov ,æ‰€ä»¥ä¸æ˜¯å–åœ°å€,ä»–ç›´æ¥ æŠŠ 2ä¸ªæˆå‘˜ å½“ longlong,é€šè¿‡å¯„å­˜								       å™¨ä¼ å€¼
call    j_?Show1@@YAXUs@@@Z ; Show1(s
show
mov     [rsp-8+arg_0], rcx
push    rbp
push    rdi
sub     rsp, 0E8h
lea     rbp, [rsp+20h]
lea     rcx, __EF9F97DB_64RETest@cpp ; JMC_flag
call    j___CheckForDebuggerJustMyCode
mov     r8d, [rbp+0E4h]
mov     edx, [rbp+0E0h]
lea     rcx, _Format    ; "%d %d\n"
call    j_printf
lea     rsp, [rbp+0C8h]
pop     rdi
pop     rbp
retn

RELEASE
main
sub     rsp, 28h
mov     dword ptr [rsp+30h], 1
mov     dword ptr [rsp+34h], 2
mov     rcx, [rsp+30h]     //è¿™é‡Œæ˜¯mov ,æ‰€ä»¥ä¸æ˜¯å–åœ°å€  lea,ä»–ç›´æ¥ æŠŠ 2ä¸ªæˆå‘˜ å½“ longlong,é€šè¿‡å¯„å­˜								       å™¨ä¼ å€¼
call    sub_140001000
xor     eax, eax
add     rsp, 28h
retn
show
mov     r8, rcx
mov     edx, ecx
shr     r8, 20h            // å†…éƒ¨é€šè¿‡ç§»ä½æ¥è·å–é«˜32ä½ å’Œ ä½ 32 ä½çš„å€¼ ,ç¬¬32ä½æ˜¯ç¬¬ä¸€ä¸ªæˆå‘˜(å°å°¾)
lea     rcx, aDD        ; "%d %d\n"
jmp     sub_1400010C0
```

#### ç»“æ„ä½“å¤§å°è¶…è¿‡8å­—èŠ‚

å®˜ç½‘è¯´è¿‡,ä¸€ä¸ªå‚æ•°ç»å¯¹ä¸ä¼šç”¨ 2 ä¸ª å¯„å­˜å™¨ä¼ é€’

```c++
#include <stdio.h>

struct s {
    int i;
    int j;
    int k;
};
//ç»“æ„ä½“ ä¸è¶…è¿‡8ä¸ªå­—èŠ‚  å¯„å­˜å™¨ä¼ å‚
void Show(struct s a) {
    printf("%d %d %d\n", a.i, a.j, a.k);
}

int main()
{
   struct s a = {1, 2,3};
   Show(a);
   return 0;
}

```

```
RELEASE
main
sub     rsp, 38h
lea     rcx, [rsp+20h]                         //ç»“æ„ä½“é¦–åœ°å€ä½œä¸ºå‚æ•°
mov     dword ptr [rsp+20h], 1    //ç»“æ„ä½“é¦–æˆå‘˜1    å› ä¸ºå‰é¢æ²¡æœ‰ä½¿ç”¨r8,r9,æ‰€ä»¥è¿™é‡Œä¸å¯èƒ½ä¸ºå‚æ•°,åªèƒ½æ˜¯å±€                                                                 éƒ¨å˜é‡
mov     dword ptr [rsp+24h], 2    //ç»“æ„ä½“é¦–æˆå‘˜2    å› ä¸ºè¿™é‡Œæ˜¯24,æ‰€ä»¥ä¸å¯èƒ½ä¸ºå‚æ•°
mov     dword ptr [rsp+28h], 3    //ç»“æ„ä½“é¦–æˆå‘˜3
call    sub_140001000                    //show
xor     eax, eax
add     rsp, 38h
retn
show
è¿™é‡Œæ±‡ç¼–ä»£ç æ˜¯æœ‰é—®é¢˜çš„,å› ä¸º è¿™é‡Œçš„åœ°å€ è·Ÿ ä¼ è¿›æ¥çš„åœ°å€æ˜¯åŒä¸€ä¸ªåœ°å€,ä¿®æ”¹å½¢å‚ä¼šå½±å“å®å‚
è¿™é‡Œä¹‹æ‰€ä»¥æ•¢è¿™æ ·æ˜¯å› ä¸ºç¼–è¯‘å™¨å‘ç°æˆ‘ä»¬å¹¶æ²¡æœ‰ä¿®æ”¹å½¢å‚
mov     r9d, [rcx+8]
mov     r8d, [rcx+4]
mov     edx, [rcx]
lea     rcx, aDDD       ; "%d %d %d\n"
jmp     sub_1400010C0
```

#### ç»“æ„ä½“å¤§å°è¶…è¿‡8å­—èŠ‚2

```c++
#include <stdio.h>

struct s {
    int i;
    int j;
    int k;
};

void Show(struct s a) {
    a.i = 100;
    printf("%d %d %d\n", a.i, a.j, a.k);
}

int main()
{
    struct s a = { 1, 2, 3 };
    scanf_s("%d", &a.i);
    Show(a);
    printf("%d\n", a.i);
    return 0;
}
```

```
main
sub     rsp, 48h
lea     rdx, [rsp+20h]
mov     dword ptr [rsp+20h], 1      //ç»“æ„ä½“é¦–åœ°å€
lea     rcx, aD_0       ; "%d"
mov     dword ptr [rsp+24h], 2
mov     dword ptr [rsp+28h], 3
call    scanf_s
movsd   xmm0, qword ptr [rsp+20h]       //å…ˆæŠŠç»“æ„ä½“åœ°å€ç»™xmm0
lea     rcx, [rsp+30h]          //ä¼ å‚ç”¨çš„ç»“æ„ä½“åœ°å€æ˜¯    rsp+30h
mov     eax, [rsp+28h]
movsd   qword ptr [rsp+30h], xmm0     //å†æŠŠxmm0çš„å€¼ç»™ rsp+30h  è¿™æ ·å°±ç›¸å½“äºæ ˆæ‹·è´
mov     [rsp+38h], eax
call    ?Show@@YAXUs@@@Z ; Show(s)
mov     edx, [rsp+20h]      //ä¼ å‚ç”¨çš„ç»“æ„ä½“åœ°å€æ˜¯    rsp+20h
lea     rcx, aD         ; "%d\n"
call    printf
xor     eax, eax
add     rsp, 48h
retn
show
mov     r9d, [rcx+8]
mov     edx, 64h ; 'd'
mov     r8d, [rcx+4]
lea     rcx, _Format    ; "%d %d %d\n"
jmp     printf
```

```c++
#include <stdio.h>


class CObect {
public:
    void fun1() {
        printf("fun1\n");
    }
};
int main()
{
  
    CObect obj;
    obj.fun1();
    return 0;
}
```

```
sub     rsp, 28h
lea     rcx, [rsp+30h]  ; this      //thisæŒ‡é’ˆå½“ç¬¬ä¸€ä¸ªå‚æ•°
call    ?fun1@CObect@@QEAAXXZ ; CObect::fun1(void)
xor     eax, eax
add     rsp, 28h
retn

lea     rcx, _Format    ; "fun1\n"
jmp     printf
```

### èšåˆä½“(__m64)  å¯ä»¥å½“åšç»“æ„ä½“

```c++
#include <stdio.h>
#include <xmmintrin.h>

void Show(__m64 a) {
    printf("%d %d\n", a.m64_u32[0], a.m64_u32[1]);
}
int main()
{
  
    __m64 m1;
    m1.m64_u32[0] = 1;
    m1.m64_u32[1] = 2;
    Show(m1);
    return 0;
}
```

```
sub     rsp, 28h
mov     dword ptr [rsp+30h], 1
mov     dword ptr [rsp+34h], 2
mov     rcx, [rsp+30h]  ; a
call    ?Show@@YAXT__m64@@@Z ; Show(__m64)
xor     eax, eax
add     rsp, 28h
retn


?Show@@YAXT__m64@@@Z proc near
mov     r8, rcx
mov     edx, ecx
shr     r8, 20h
lea     rcx, _Format    ; "%d %d\n"
jmp     printf
?Show@@YAXT__m64@@@Z endp
```

## è¿”å›å€¼

ä½äº 8å­—èŠ‚ ç”¨   rax æˆ–è€…  xmm0  ,ç»“æ„ä½“çš„è¯ å¦‚æœæˆå‘˜æ˜¯float,è¿”å›è¿˜æ˜¯ç”¨  rax 

è¶…è¿‡8å­—èŠ‚   è¿”å›åœ°å€

```c++
#include <stdio.h>


struct s1 {
    int i;
    int j;
};
struct s2 {
    int i;
    int j;
    int k;
};

int Get1() {
    return 10;
}

long long Get2() {
    return 0x1234567812345678LL;
}

float Get3() {
    return 10;
}

struct s1 Get4() {
    struct s1 a = { 1, 2 };
    return a;
}
struct s2 Get5() {
    struct s2 a = { 1, 2,3 };
    return a;
}


struct s2 Get6(struct s2 a) {
    printf("%d %d %d\n", a.i, a.j, a.k);
    struct s2 n = { 1, 2, 3 };
    return n;
}

int main()
{
  
    
    printf("%d\n", Get1());
    printf("%lld\n", Get2());
    printf("%lf\n", Get3());
    printf("%d\n", Get4().j);
    printf("%d\n", Get5().k);
    struct s2 n1 = {10, 20, 30};
    printf("%d\n", Get6(n1).k);
    return 0;
}
```

```
main
sub     rsp, 48h
call    ?Get1@@YAHXZ    ; Get1(void)
mov     edx, eax
lea     rcx, aD         ; "%d\n"
call    printf
call    ?Get2@@YA_JXZ   ; Get2(void)
mov     rdx, rax
lea     rcx, aLld       ; "%lld\n"
call    printf
call    ?Get3@@YAMXZ    ; Get3(void)
xorps   xmm1, xmm1
lea     rcx, aLf        ; "%lf\n"
cvtss2sd xmm1, xmm0
movq    rdx, xmm1
call    printf
call    ?Get4@@YA?AUs1@@XZ ; Get4(void)
shr     rax, 20h
lea     rcx, aD         ; "%d\n"
mov     edx, eax
call    printf
lea     rcx, [rsp+48h+result] ; result    ;å®šä¹‰ä¸€ä¸ªå±€éƒ¨å˜é‡
call    ?Get5@@YA?AUs2@@XZ ; Get5(void)
lea     rcx, aD         ; "%d\n"
movsd   xmm0, qword ptr [rax]
mov     edx, [rax+8]
movsd   [rsp+48h+var_18], xmm0
call    printf
lea     rdx, [rsp+48h+result]
mov     [rsp+48h+result.i], 0Ah
lea     rcx, [rsp+48h+var_18]
mov     [rsp+48h+result.j], 14h
mov     [rsp+48h+result.k], 1Eh
call    ?Get6@@YA?AUs2@@U1@@Z ; Get6(s2)
lea     rcx, aD         ; "%d\n"
mov     edx, [rax+8]
call    printf
xor     eax, eax
add     rsp, 48h
retn
```

#### è¿”å›å€¼æ˜¯ä¸è¶…è¿‡4èŠ‚æ•´å½¢

ç›´æ¥é€šè¿‡ eax è¿”å›

mov     eax, 0Ah

retn

#### è¿”å›å€¼æ˜¯ä¸è¶…è¿‡8å­—èŠ‚æ•´å½¢

ç›´æ¥é€šè¿‡ rax è¿”å›

mov     rax, 1234567812345678h

retn

#### è¿”å›å€¼æ˜¯æµ®ç‚¹

é€šè¿‡æµ®ç‚¹å¯„å­˜å™¨  xmm0  è¿”å›

movss   xmm0, cs:__real@41200000

retn

#### è¿”å›å€¼æ˜¯ç»“æ„ä½“(å¤§å°ä¸è¶…è¿‡8å­—èŠ‚)

é€šè¿‡å¯„å­˜å™¨   rax  è¿”å› 

mov     rax, 200000001h

retn

#### è¿”å›å€¼æ˜¯å¯¹è±¡ (å¤§å°è¶…è¿‡8å­—èŠ‚)

å®šä¸€ä¸ªå±€éƒ¨å˜é‡,æ”¾å…¥ç»“æ„ä½“åœ°å€ ,åœ¨å‡½æ•°é‡Œé¢æ“ä½œå‚æ•°,å¹¶ä¸”å°†ç»“æ„ä½“åœ°å€ä½œä¸ºè¿”å›å€¼

mov     dword ptr [rcx], 1

mov     rax, rcx       //å°†ç»“æ„ä½“åœ°å€ä½œä¸ºè¿”å›å€¼

mov     dword ptr [rcx+4], 2

mov     dword ptr [rcx+8], 3

retn

#### ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿæ˜¯ç»“æ„ä½“

è·Ÿæ„é€ å‡½æ•°å¾ˆåƒ

```
lea     rdx, [rsp+20h]                            //ç¬¬äºŒä¸ªå‚æ•°
mov     dword ptr [rsp+20h], 0Ah     //ç»“æ„ä½“åœ°å€
lea     rcx, [rsp+30h]                             //ç¬¬ä¸€ä¸ªå‚æ•°ç»™çš„æ˜¯è¿”å›å€¼
mov     dword ptr [rsp+24h], 14h
mov     dword ptr [rsp+28h], 1Eh
call    ?Get6@@YA?AUs2@@U1@@Z ; Get6(s2)
lea     rcx, aD         ; "%d\n"
mov     edx, [rax+8]
call    printf


push    rbx
sub     rsp, 20h
mov     r9d, [rdx+8]
mov     rbx, rcx
mov     r8d, [rdx+4]
lea     rcx, _Format    ; "%d %d %d\n"
mov     edx, [rdx]
call    printf
mov     rax, rbx
mov     dword ptr [rbx], 1
mov     dword ptr [rbx+4], 2
mov     dword ptr [rbx+8], 3
add     rsp, 20h
pop     rbx
retn
```

## F5åŠŸèƒ½

```c++
#include <stdio.h>


class CObect {
public:
    void fun1() {
        printf("fun1\n");
    }
};
int main()
{
  
    CObect obj;
    obj.fun1();
    return 0;
}
```

__int64 fun1()

{

  return sub_1400010A0("fun1\n");

}

å¯ä»¥çœ‹åˆ°å°‘äº†å‚æ•°,å› æ­¤åœ¨64ä½ç¨‹åº  ida  F5 åŠŸèƒ½å‚æ•°æ•°é‡ç»å¸¸æ˜¯é”™è¯¯çš„, 32ä¸º å‚æ•°æ•°é‡åŸºæœ¬éƒ½æ˜¯å¯¹çš„

è§£å†³åŠæ³•:  æŒ‰å¿«æ·é”® ç„¶å æŠŠ  void * æ”¾è¿›å»,å°±å¯ä»¥äº†

![img](notesimg/1661613470306-02ad1082-bcb5-4ced-af66-36cd8cbb5deb.png) 

å‚æ•°é”™äº†,è¯´æ˜ä¸­é—´ä»£ç ä¹Ÿææœ‰å¯èƒ½é”™è¯¯,å°‘ä¸€ä¸ªå‚æ•°,ä»£ç å°±ä¹±äº†



## è·¨å‡½æ•°è°ƒç”¨   setjmp/longjmp

å‡½æ•°çš„å®ç°ä»£ç  åªèƒ½ç”¨ ä¼šå˜æ¥å®ç°

åŠŸèƒ½ç±»ä¼¼goto   åªä¸è¿‡ goto ä¸èƒ½è·¨å‡½æ•° , è¿™ä¸ªå¯ä»¥   

ä»¥å‰æ²¡æœ‰ try  catch çš„åŠŸèƒ½,æ‰€æœ‰ä½¿æ˜¯ setjmp/longjmp æ¥å®ç°    è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å‡½æ•°,ç°åœ¨å¯ä»¥ç”¨  try catch æ›¿ä»£,æ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨

1.  setjmp         ä¿å­˜å¯„å­˜å™¨ç¯å¢ƒ
2.  longjmp      æ¢å¤å¯„å­˜å™¨ç¯å¢ƒ

```c++
#include <stdio.h>
#include <xmmintrin.h>
#include <setjmp.h>   //å¤´æ–‡ä»¶


jmp_buf mark;   //å¯„å­˜å™¨ç¯å¢ƒ


void Show(__m64 a) {
    longjmp(mark, 3);    //æ‰§è¡Œè¿™è¡Œä»£ç å°±ä¼šè·³è½¬åˆ°  setjmp æ‰€åœ¨çš„åœ°å€,å¹¶ä¸”è¿”å›è®¾å®šçš„è¿”å›å€¼
    printf("%d %d\n", a.m64_u32[0], a.m64_u32[1]);
}

int main()
{
  
    __m64 m1;
    m1.m64_u32[0] = 1;
    m1.m64_u32[1] = 2;

    int ret = setjmp(mark);   //è·³å›åœ°å€ æ‰§è¡Œå®Œlongjmpå°±ä¼šè·³åˆ°æ­¤å¤„ä»£ç 
    
    if (ret != 3) {           //è¿™é‡Œå¦‚æœ ä¸åŠ åˆ¤æ–­è¿”å›å€¼ å°±ä¼š é€’å½’
        Show(m1);             //ç­‰äº3è¯´æ˜è¿™ä¸ªå‡½æ•°å·²ç»æ‰§è¡Œè¿‡äº†
    }

    return 0;
}
```

æ³¨æ„,ä½¿ç”¨   setjmp/longjmp  è¯´æ˜ æ”¾å¼ƒäº†å¯„å­˜å™¨ é‡Œé¢ä¿å­˜çš„å€¼,å³,ä½¿ç”¨ è¯¥å‡½æ•°,å¹¶ä¸ä¼šä¿å­˜å’Œæ¢å¤ä¹‹å‰å¯„å­˜å™¨é‡Œé¢çš„å€¼





## ä½œä¸š

##### å¸¸è§„ä½œä¸š

##### é€†å‘ä¿„ç½—æ–¯æ–¹å—

[ğŸ“Game.zip](./Game.zip)

å‚è€ƒç­”æ¡ˆ

[ğŸ“CppTetris-master.zip](./CppTetris-master.zip)