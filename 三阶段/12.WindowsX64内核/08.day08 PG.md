### è¯¾å ‚ä»£ç 

[ğŸ“64ä½å†…æ ¸08.zip](./64ä½å†…æ ¸08.zip)

## PGè¡¥è¯¾

### ç£ç›˜

-   å†…æ ¸é©±åŠ¨æ“ä½œæ–‡ä»¶ä¼šè‡ªåŠ¨è¯†åˆ«ç£ç›˜çš„åˆ†åŒºæ ¼å¼,ç„¶åè¿›è¡Œæ“ä½œ
-   æˆ‘ä»¬ä¸é€šè¿‡é©±åŠ¨å…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„,æˆ‘ä»¬å¯ä»¥è‡ªå·±å»éå†æ“ä½œæ ¼å¼ä¹Ÿæ˜¯å¯ä»¥çš„ä½†æ˜¯è¿˜æ˜¯ç”¨ CrateFile() 
-   ç”¨  CrateFile() å¹¶ä¸æ˜¯ä¸ºäº†å»æ“ä½œæŸä¸ªæ–‡ä»¶,è€Œæ˜¯ä¸ºäº†è¯»åˆ°æŠŠç£ç›˜æ‰‡åŒºçš„æ•°æ®
-   ç£ç›˜æ˜¯ä»¥æ‰‡åŒºä½ç»“æ„å­˜å‚¨æ•°æ®,ä¸€ä¸ªæ‰‡åŒº512ä¸ªå­—èŠ‚(0x200)
-   ç”¨ windows ç³»ç»Ÿé¦–å…ˆç¬¬ä¸€æ­¥æ•Œå¯¹ç£ç›˜è¿›è¡Œåˆ†åŒº,å¯¹ç£ç›˜è¿›è¡Œåˆ†åŒºå¯¹ç¡¬ç›˜åšä¸€ä¸ªæ ¼å¼çš„æ“ä½œ,ç°åœ¨ä¸»åŠ›æ˜¯NTFS
-   æ“ä½œç³»ç»Ÿå¼€æœºæµç¨‹

-   -   CPU => é€šç”µ  =>  ç¡¬ç›˜ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼ˆMBR) =>  å†…å­˜(7C00)  =>  æ‰§è¡Œä»£ç  => Winload.exe(ç³»ç»ŸåŠ è½½å™¨) => ntoskel.exe(åŠ è½½å†…æ ¸) => WinLogin(ç™»å½•ç•Œé¢) => Desktop(æ¡Œé¢)

-   å¦‚æœæˆ‘ä¹ˆææ¸…æ¥šå®ƒçš„æ ¼å¼,æˆ‘ä»¬å¯ä»¥è‡ªå·±å»æ“ä½œæ‰‡åŒº,å»éå†å®ƒçš„åˆ†åŒºä¿¡æ¯è¡¨,é‚£æˆ‘ä»¬å°±å¯ä»¥æ‰‹å·¥å»åšç£ç›˜çš„çš„å¢åˆ æ”¹æŸ¥æ“ä½œ,ç”¨çš„å°±æ˜¯ç¬¦å·é“¾æ¥

```c++

#include <stdio.h>
#include <Windows.h>
#include <stdlib.h>
int main()
{
  HANDLE hFile = CreateFile("//?/C:",   //ç¬¦å·é“¾æ¥
    GENERIC_READ | GENERIC_WRITE,       //è®¿é—®æƒé™
    FILE_SHARE_READ | FILE_SHARE_WRITE, //ä¸èƒ½ç‹¬å ,å¦åˆ™å¯èƒ½å¤±è´¥ 
    NULL, 
    OPEN_EXISTING,               
    0, 0);
  printf("hFile:%p\n", hFile);
  unsigned char Buf[512];
  SetFilePointer(hFile, 0 * 512, NULL, FILE_BEGIN); //è®¾ç½®æ–‡ä»¶æŒ‡é’ˆ
  ReadFile(hFile, Buf, sizeof(Buf), NULL, NULL);    //è¯»å–ç¬¬ä¸€ä¸ªæ‰‡åŒºæ•°æ®
  for (int i = 1; i <= sizeof(Buf); i++) {          //å±•ç¤ºæ‰‡åŒºæ•°æ®
    printf("%02X ", Buf[i - 1]);
    if (i % 16 == 0)
    {
      printf("\n");
    }
  }
  CloseHandle(hFile);

  return 0;
}
//ç¬¬ä¸€ä¸ªæ‰‡åŒºä»£ç å°±æ˜¯MBRä»£ç  æ˜¯16ä½æ±‡ç¼–,å¦‚æœæ”¹äº†è¿™æ®µä»£ç ,å°±æ— æ³•å¼€æœº
//åé¢æ‰‡åŒºè¿˜ä¼šæ”¾ä¸€ä¸ª MBRå¤‡ä»½ä»£ç ,æ–¹ä¾¿å‡ºç°æ•…éšœè¿˜åŸ
//winhex ä¹Ÿå…·å¤‡æ‰“å¼€ç¡¬ç›˜åŠŸèƒ½,åŸç†è·Ÿä¸Šé¢ç›¸åŒ
//è¿™æ®µä»£ç åœ¨å›ºå®šå†…å­˜åœ°å€ 0x7C00 å¤„åŠ è½½ 
```

[ğŸ“ç£ç›˜æ–‡ä»¶æ ¼å¼åŸºç¡€.ppt](./ç£ç›˜æ–‡ä»¶æ ¼å¼åŸºç¡€.ppt)

[ğŸ“NTFSæ–‡ä»¶æ ¼å¼ç®€ä»‹.ppt](./NTFSæ–‡ä»¶æ ¼å¼ç®€ä»‹.ppt)

-   FAT32 æ¯ä¸ªæ–‡ä»¶æœ€å¤§åªèƒ½æ˜¯4G.è¶…è¿‡4Gå°†æ— æ³•æ”¾ä¸‹
-   NTFS ä¸€ä¸ªç°‡æ˜¯4K,ä½ æœ‰æ—¶å€™æ–‡ä»¶å¤§å°åªæœ‰ä¸€ä¸ªå­—èŠ‚,ä½†æ˜¯ä»–å ç”¨å¤§å°å´æ˜¯4K
-   NTFSåˆ†åŒºå¤§å°ä¸èƒ½è¶…è¿‡2T,è¶…è¿‡å°±æ— æ³•åˆ†åŒº
-   NTFSçš„æ ¼å¼ æ˜¯ä¸€é¢— B+ æ•°,éå†è¿™ä¸ªä¸ªæ•°å°±å¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œå¢åˆ æ”¹æŸ¥çš„æ“ä½œ 
-   å¦‚æœæ˜¯win11 è¿˜æœ‰ UEFI å’Œ GPT æ ¼å¼
-   ç”µè„‘å¼€æœºå…ˆè¿è¡Œçš„ä»£ç æ˜¯ BIOS(å¼€æœºè‡ªæ£€) ä»£ç ,ä¸»æ¿ä¸Šçš„é‚£éƒ¨åˆ†ä»£ç ,ä¹Ÿæ˜¯ç”¨16ä½æ±‡ç¼–å†™çš„



### PG(PatchGuard)

-   æ“ä½œç³»ç»Ÿåœ¨è°ƒè¯•çŠ¶æ€,é©±åŠ¨æ˜¯ä¸éœ€è¦éªŒè¯ç­¾åçš„,ä¸éœ€è¦è¿‡ DSE
-   é©±åŠ¨å°½é‡ä¸è¦å¸¦ä¸­æ–‡è·¯å¾„,ä¸ç„¶å¯èƒ½ç¼–è¯‘ä¸äº†
-   å¼€äº†è°ƒè¯•å™¨è¿æ¥ windbg çš„è¯ PG ä¼šä¸ç”Ÿæ•ˆ
-    æœ‰æ—¶å€™windbgè¿ä¸ä¸Šè°ƒè¯•å™¨å¯ä»¥ä¸‹ä¸€ä¸ªæ–­ç‚¹



-   pgæ˜¯ä¸€æ®µè¡¥ä¸ä¿æŠ¤ä»£ç 

1.  æ£€æµ‹å†…æ ¸çš„ä¿®æ”¹
2.  æ£€æµ‹ssdtçš„ä¿®æ”¹
3.  æ£€æµ‹idtçš„ä¿®æ”¹
4.  å†…æ ¸åˆå§‹åŒ–æ—¶å¯åŠ¨(INITèŠ‚: æ‰§è¡Œä¸€æ¬¡å°±é‡Šæ”¾,æ‰€ä»¥åœ¨å†…å­˜æ‰¾ä¸åˆ°è¿™æ®µä»£ç )
5.  æ£€æµ‹ä½ç½®éšæœº
6.  æ£€æµ‹å‘¨æœŸ2åˆ†é’Ÿå·¦å³
7.  åè°ƒè¯•ï¼Œåè·Ÿè¸ª
8.  è¿è¡Œä¸€æ¬¡å°±æ¢åœ°å€ï¼ŒExAllocPool => ExAllocPool
9.  ä»£ç è‡ªè§£å¯†ï¼ˆç®—æ³•xor)  Context,ä»£ç ä¸æ‰§è¡Œä¸è§£å¯†



-   å®‰å…¨æ¨¡å¼ä¸å¯åŠ¨PGä¿æŠ¤



-   æ‰¾PGä»£ç çš„æ–¹æ³•

-   -   initèŠ‚ä¸­ æ‰¾æ²¡æœ‰ç¬¦å·å‡½æ•°æœ€å¤§çš„ä»£ç 
    -   ç„¶åå‚è€ƒå¼•ç”¨,çœ‹è°è°ƒäº†è¿™ä¸ªå‡½æ•°
    -    PsInitSystem => KeInitAmd64SpecificState -> RUNTIME_FUNCTION => KiFilterFiberContext -> PGInitContext(PGä»£ç å‡½æ•°)
    -    Context => ExAllocPool => å†™å…¥ =ã€‹ CmpAppendDllSection
    -   newå®Œ  Context  å,ä»å¼€å§‹åˆ°ç»“å°¾ ä¼šéšæœºç”Ÿæˆä¸€ä¸ªkey ç„¶åè¿›è¡Œå¼‚æˆ–,è¿™ä¸ªkeyåœ¨è°ƒ Context  çš„å‡½æ•°æ—¶,ä¼šæ”¾åœ¨rdxå½“ä¸­,ä»¥åæˆ–è¿‡å æ‰ä¼šè§£å¯†å‡ºçœŸæ­£ä»£ç 
    -   

-   å› æ­¤æˆ‘ä»¬æƒ³è¿‡PGæœ‰2ç§æ–¹æ¡ˆ

1.   é™æ€   : åœ¨ä¸Šé¢è°ƒç”¨PGçš„å‡½æ•°ä¸­ç›´æ¥ retn æˆ–è€…æŠŠ è°ƒç”¨ PG çš„ä»£ç  nop æ‰,å³å¯¹  ntoskrnl.exe æ‰“è¡¥ä¸,ç³»ç»Ÿä¼šæ ¡éªŒç­¾å,å› ä¸ºç­¾åä»£ç æ˜¯ç”± winload.exe è´Ÿè´£,æ‰€ä»¥ å¯ä»¥  patch copy winload.exe   -

-   -   æ€¥éœ€è¦   patch copy ntoskrnl.exe     patch copy winload.exe  è¿™2ä¸ªæ–‡ä»¶,è¿˜å¾—ç”Ÿæˆä¸€ä¸ª å¼€æœºå¯åŠ¨é¡¹,å› ä¸ºä¸èƒ½æŠŠåŸæ¥çš„æ”¹çš„,ä¸ç„¶å¯èƒ½æ”¹åäº†,æ‰€æœ‰æˆ‘ä»¬å¯ä»¥æ‹·è´è¿™2ä¸ªæ–‡ä»¶,ç”¨  bcdedit æ¥æ–°å»ºä¸€ä¸ªå¯åŠ¨é¡¹,æ¥æŒ‡æ˜è¿™2ä¸ªæ–‡ä»¶,ä½†æ˜¯æ˜¯ä¸åŒç‰ˆæœ¬çš„æ±‡ç¼–å¯èƒ½æ˜¯ä¸åŒçš„,å› æ­¤æ¯ä¸ªç‰ˆæœ¬éƒ½éœ€è¦  patch 

1.  åŠ¨æ€:

1.  1.  patch Context     åœ¨å†…å­˜ä¸­æ‰¾åˆ°   CmpAppendDllSection ä»£ç  ,ç›´æ¥è®©ä»–retn
    2.  patch è°ƒç”¨æº       å³è°è°ƒäº†  Context      æˆ‘ä»¬å°± patchè°
    3.  patch KeBugCheck     patchè°ƒç”¨é“¾,ä¾‹å¦‚patchè“å±,å•æ•°è¦æ³¨æ„å…¼å®¹æ€§



-   ä¸Šé¢çš„æ–¹æ¡ˆä¸­    patch è°ƒç”¨æº    æ˜¯æœ€ä¼˜çš„æ–¹æ³•,å› ä¸º   patch Context  ä¸ç¨³å®š,æ— æ³•ç¡®å®šæ˜¯å¦æ˜¯  Context   ä»£ç ,åªæœ‰å‰å››ä¸ªå­—èŠ‚å¯ç”¨äºåˆ¤æ–­,å› æ­¤ä¸ç¨³å®š,ç¼“è§£æ–¹æ³•å°±æ˜¯é‚£åé¢æ•°æ®è‡ªå·±å» å¼‚æˆ–,çœ‹æ˜¯ä¸æ˜¯è‡ªå·±æƒ³è¦çš„ä»£ç  
-   é™æ€è¿‡ç¨³å®šæ€§æœ€å¼º,ä½†æ˜¯ä¸é€‚åˆå•†ç”¨,å› ä¸ºè¦åŠ å¼€æœºå¯åŠ¨é¡¹
-   PGä»£ç   win10 å’Œ win7 å˜åŒ–ä¸»è¦æ£€æµ‹å’Œåè°ƒè¯•



### åŠ¨æ€è¿‡PGæºç 

-   éå†æ‰€æœ‰çš„é¡µ :å› ä¸º  Context   ä¼šåŠ¨æ€ç”³è¯·å†…å­˜

```c++
#include <ntddk.h>

typedef enum _SYSTEM_INFORMATION_CLASS {
  SystemBasicInformation,
  SystemProcessorInformation,             // obsolete...delete
  SystemPerformanceInformation,
  SystemTimeOfDayInformation,
  SystemPathInformation,
  SystemProcessInformation,
  SystemCallCountInformation,
  SystemDeviceInformation,
  SystemProcessorPerformanceInformation,
  SystemFlagsInformation,
  SystemCallTimeInformation,
  SystemModuleInformation,
  SystemLocksInformation,
  SystemStackTraceInformation,
  SystemPagedPoolInformation,
  SystemNonPagedPoolInformation,
  SystemHandleInformation,
  SystemObjectInformation,
  SystemPageFileInformation,
  SystemVdmInstemulInformation,
  SystemVdmBopInformation,
  SystemFileCacheInformation,
  SystemPoolTagInformation,
  SystemInterruptInformation,
  SystemDpcBehaviorInformation,
  SystemFullMemoryInformation,
  SystemLoadGdiDriverInformation,
  SystemUnloadGdiDriverInformation,
  SystemTimeAdjustmentInformation,
  SystemSummaryMemoryInformation,
  SystemMirrorMemoryInformation,
  SystemPerformanceTraceInformation,
  SystemObsolete0,
  SystemExceptionInformation,
  SystemCrashDumpStateInformation,
  SystemKernelDebuggerInformation,
  SystemContextSwitchInformation,
  SystemRegistryQuotaInformation,
  SystemExtendServiceTableInformation,
  SystemPrioritySeperation,
  SystemVerifierAddDriverInformation,
  SystemVerifierRemoveDriverInformation,
  SystemProcessorIdleInformation,
  SystemLegacyDriverInformation,
  SystemCurrentTimeZoneInformation,
  SystemLookasideInformation,
  SystemTimeSlipNotification,
  SystemSessionCreate,
  SystemSessionDetach,
  SystemSessionInformation,
  SystemRangeStartInformation,
  SystemVerifierInformation,
  SystemVerifierThunkExtend,
  SystemSessionProcessInformation,
  SystemLoadGdiDriverInSystemSpace,
  SystemNumaProcessorMap,
  SystemPrefetcherInformation,
  SystemExtendedProcessInformation,
  SystemRecommendedSharedDataAlignment,
  SystemComPlusPackage,
  SystemNumaAvailableMemory,
  SystemProcessorPowerInformation,
  SystemEmulationBasicInformation,
  SystemEmulationProcessorInformation,
  SystemExtendedHandleInformation,
  SystemLostDelayedWriteInformation,
  SystemBigPoolInformation,
  SystemSessionPoolTagInformation,
  SystemSessionMappedViewInformation,
  SystemHotpatchInformation,
  SystemObjectSecurityMode,
  SystemWatchdogTimerHandler,
  SystemWatchdogTimerInformation,
  SystemLogicalProcessorInformation,
  SystemWow64SharedInformation,
  SystemRegisterFirmwareTableInformationHandler,
  SystemFirmwareTableInformation,
  SystemModuleInformationEx,
  SystemVerifierTriageInformation,
  SystemSuperfetchInformation,
  SystemMemoryListInformation,
  SystemFileCacheInformationEx,
  MaxSystemInfoClass  // MaxSystemInfoClass should always be the last enum
} SYSTEM_INFORMATION_CLASS;


typedef struct _SYSTEM_BIGPOOL_ENTRY {
  PVOID VirtualAddress;
  SIZE_T SizeInBytes;
  UCHAR Tag[4];
} SYSTEM_BIGPOOL_ENTRY, * PSYSTEM_BIGPOOL_ENTRY;

typedef struct _SYSTEM_BIGPOOL_INFORMATION {
  ULONG Count;
  SYSTEM_BIGPOOL_ENTRY AllocatedInfo[1];
} SYSTEM_BIGPOOL_INFORMATION, * PSYSTEM_BIGPOOL_INFORMATION;

NTSTATUS  NTAPI ZwQuerySystemInformation(
  __in SYSTEM_INFORMATION_CLASS SystemInformationClass,
  __out_bcount_opt(SystemInformationLength) PVOID SystemInformation,
  __in ULONG SystemInformationLength,
  __out_opt PULONG ReturnLength
);

VOID Unload(_In_ struct _DRIVER_OBJECT* DriverObject) {
  UNREFERENCED_PARAMETER(DriverObject);
  DbgPrint("[51asm] Unload\n");
}

#define PDE_BASE 0xFFFFF6FB40000000    //é¡µç›®å½•è¡¨åŸºå€
#define PTE_BASE 0xFFFFF68000000000    //é¡µè¡¨åŸºå€

NTSTATUS PG() {
  NTSTATUS Status;
  PSYSTEM_BIGPOOL_INFORMATION PoolInfo = NULL;
  PVOID Buffer;
  ULONG BufferSize = 4096;
  ULONG ReturnLength;
  ULONG i;
  ULONG Number = 0;   //æ‰¾åˆ°çš„æ•°é‡

retry:
  Buffer = ExAllocatePoolWithTag(NonPagedPool, BufferSize, '1234');

  if (!Buffer) {
    return STATUS_NO_MEMORY;
  }
  Status = ZwQuerySystemInformation(SystemBigPoolInformation,
    Buffer,
    BufferSize,
    &ReturnLength
  );

  if (Status == STATUS_INFO_LENGTH_MISMATCH) {
    ExFreePool(Buffer);
    BufferSize = ReturnLength;
    goto retry;
  }

  if (NT_SUCCESS(Status)) {
    PoolInfo = (PSYSTEM_BIGPOOL_INFORMATION)Buffer;
    //PML4  PDPE  PDE  PTE    NX = 0      NX = 1
    for (i = 0; i < PoolInfo->Count; i++) {    //éå†å†…å­˜
      PSYSTEM_BIGPOOL_ENTRY pEntry = &PoolInfo->AllocatedInfo[i];
      if (pEntry->SizeInBytes >= 0x10000) {   //Contextå¤§å°è‚¯å®šå¤§äº10000,ä¸”å¯æ‰§è¡Œ
        PULONG64 PDE = (PULONG64)((ULONG64)PDE_BASE + (((ULONG64)pEntry->VirtualAddress >> 18) & 0x3FFFFFF8));  //è·å–é¡µç›®å½•è¡¨é¡¹
        if ((*PDE & 0x80) == 1 && *PDE & 1) {//PS == 1   P    //è¯´æ˜æ²¡æœ‰é¡µè¡¨
        }
        else {
          PULONG64 PTE = (PULONG64)((ULONG64)PTE_BASE + (((ULONG64)pEntry->VirtualAddress >> 9) & 0x7FFFFFFFF8));     //è·å–é¡µè¡¨é¡¹
          if ((*PTE & 1) && ((*PTE & 0x8000000000000000) == 0)) {//P=1 NX=0 å¯æ‰§è¡Œä»£ç 
             *PTE |= 0x8000000000000000;
             //14å·ä¸­æ–­  ç¼ºé¡µä¸­æ–­
              DbgPrint("[51asm] VirtualAddress:%p SizeInBytes:%p PDE:%p PTE:%p\n",
                pEntry->VirtualAddress, (PVOID)pEntry->SizeInBytes,PDE, PTE); //æ‰“å°ä¿¡æ¯
              Number++;
          }
        }
      }
    }
    DbgPrint("[51asm] Count:%d Number:%d\n", PoolInfo->Count,Number);
  }

  if (Buffer)
    ExFreePool(Buffer);

  return Status;

  
}

NTSTATUS DriverEntry(__in struct _DRIVER_OBJECT* DriverObject,__in PUNICODE_STRING  RegistryPath)
{
  UNREFERENCED_PARAMETER(DriverObject);
  UNREFERENCED_PARAMETER(RegistryPath);

  DriverObject->DriverUnload = Unload;
  DbgPrint("[51asm] DriverEntry\n");

  PG();
  return STATUS_SUCCESS;
}

```

-   éå†å‡ºæ¥æ€ä¹ˆç¡®å®šPGä»£ç å‘¢,å¯ä»¥æŠŠä»£ç é¡µæ”¹æˆä¸å¯æ‰§è¡Œ,å¦‚æœè§¦å‘äº†è“å±,å°±è¯´æ˜è¿™æ®µä»£ç å¯èƒ½  Context(PG) ä»£ç 

### é™æ€è¿‡ PG å‚è€ƒæºç 

### é™æ€è¿‡ PG å‚è€ƒæºç 

[ğŸ“UPGDSED_master.zip](./UPGDSED_master.zip)

