## ä¸€èˆ¬æ–­ç‚¹(è½¯ä»¶æ–­ç‚¹)



æ–­ç‚¹çš„å°Šä¸¥

1.  æ–­çš„ä¸‹æ¥     
2.  èµ°çš„è¿‡å»     
3.  ä¸‹æ¬¡è¿˜æ¥

æ‰€æœ‰åˆæ ¼çš„æ–­ç‚¹éƒ½åº”è¯¥æ»¡è¶³è¿™3ä¸ªè¦æ±‚



ODä¸‹æ–­ç‚¹å®é™…æ˜¯æŠŠæŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ”¹æˆäº†CC,å½“ç¨‹åºæ‰§è¡Œåˆ°CCçš„æ—¶å€™å…¶å®æ˜¯æŠ›äº†ä¸€ä¸ªå¼‚å¸¸(EXCEPTION_BREAKPOINT),è¿™ä¸ªå¼‚å¸¸å°±ä¼šè¿›å…¥è°ƒè¯•å™¨é‡Œé¢å› ä¸ºå¤„äºè°ƒè¯•çŠ¶æ€,è°ƒè¯•å™¨æ‹¿åˆ°è¿™ä¸ªå¼‚å¸¸ä¹‹åå°±ä¼šçŸ¥é“ç¨‹åºè¦æ–­åˆ°è¿™é‡Œ,å†™äº†CCä¹‹å,è¿™æ¡æŒ‡ä»¤æ­£å¸¸çš„åŠŸèƒ½å°±è¢«ç ´åäº†,ä½†æ˜¯è¿™æ¡æŒ‡ä»¤æ­£å¸¸åŠŸèƒ½ä¸­ä»–è¿˜æ˜¯åº”è¯¥æ‰§è¡Œçš„,é‚£æ€ä¹ˆè®©ä»–èµ°è¿‡å»å‘¢,é‚£å°±æ˜¯æŠŠè¿™æ¡æŒ‡ä»¤æ¢å¤,ä¸‹æ¬¡å†æ¥åªéœ€è¦èµ°è¿‡å»ä¹‹åå†æŠŠå®ƒå†™å›CC,è¿™æ¡æŒ‡ä»¤æ‰§è¡Œå®Œå¯é€šè¿‡ TF æ ‡å¿—ä½ æ¥å®ç°, (TFç½®1å°±ä¼šæŠ›å‡ºå¼‚å¸¸(EXCEPTION_SINGLE_STEP)),

![img](notesimg/1654685616035-a9b0d3f0-66a1-43ed-8949-b4a842480e1e.png)



æ–­æ­¥é…åˆ: æ–­ç‚¹å’Œå•æ­¥é…åˆå®ç°æ–­ç‚¹ä¸‹æ¬¡å†æ¥ 

è°ƒè¯•çš„æ—¶å€™ å¦‚æœ æ–­ç‚¹ä¸‹æ¬¡æ²¡æ¥  å°±æ£€æŸ¥æ–­æ­¥é…åˆ,å¦‚æœå´©äº†è¯´æ˜æ²¡æœ‰æ¢å¤,å¦‚æœç¨‹åºè·‘é£äº†,æ–­ç‚¹ä¸å†æ¥,è¯´æ˜å•æ­¥æ²¡å¤„ç†å¥½



è°ƒè¯•å™¨å¯¹è¢«è°ƒè¯•è¿›ç¨‹æ‹¥æœ‰æ‰€æœ‰çš„æƒé™(é™¤äº†å†™)



![img](notesimg/1654691491887-01798240-0603-4c86-b865-3109f5131fff.png)

  ç¬¬äºŒä¸ªæˆå‘˜å°±æ˜¯è°ƒè¯•å™¨åˆ¤æ–­å¼‚å¸¸ç¬¬ä¸€ä¸ªæ¬¡æ¥è¿˜æ˜¯ç¬¬äºŒæ¬¡

ç¬¬ä¸€ä¸ªæˆå‘˜,å¼‚å¸¸ä¿¡æ¯ç»“æ„ä½“

![img](notesimg/1654691606740-76feb84c-cdec-4b37-bddc-12c04b65cbfd.png)



### è·å–å¯„å­˜å™¨ç¯å¢ƒ    GetThreadContext

![img](notesimg/1654692452343-4ce8f217-9ec1-41f0-a0df-0b204bb86994.png)

ç¬¬ä¸€ä¸ªå‚æ•°: çº¿ç¨‹å¥æŸ„   ,ç¬¬äºŒä¸ªç»“æ„ä½“æŒ‡é’ˆ(ç»“æ„ä½“ç±»å‹è¦åˆ° vsä¸­å»çœ‹, msdnæ²¡æœ‰) 



### ä»£ç å®ç°

ä»¥æ‰«é›·ä¸ºä¾‹

```
æ‰«é›·çš„è¿‡ç¨‹å‡½æ•°ï¼š
åœ°å€                    æœºå™¨ç            åŠ©è®°ç¬¦
01001BC9          55                  push    ebp
01001BCA         8BEC             mov     ebp, esp
01001BCC         83EC 40        sub     esp, 40
01001BCF         8B55 0C        mov     edx, dword ptr [ebp+C]        //åœ¨è¯¥è¡Œä¸‹æ–­ç‚¹
01001BD2         8B4D 14       mov     ecx, dword ptr [ebp+14]
01001BD5         53                  push    ebx
01001BD6         56                  push    esi
01001BD7         33DB             xor     ebx, ebx
```

```
.586
.model flat,stdcall
option casemap:none

   include windows.inc
   include user32.inc
   include kernel32.inc
   include msvcrt.inc
   
   includelib user32.lib
   includelib kernel32.lib
   includelib msvcrt.lib
   
.data
    g_szExe db "winmine.exe", 0     ;è¢«è°ƒè¯•çš„ç¨‹åº
    g_hExe  dd 0                    ;è¢«è°ƒè¯•çš„ç¨‹åºå¥æŸ„
    g_szEXCEPTION_DEBUG_EVENT         db "EXCEPTION_DEBUG_EVENT", 0dh, 0ah, 0
    g_szCREATE_THREAD_DEBUG_EVENT     db "CREATE_THREAD_DEBUG_EVENT", 0dh, 0ah, 0
    g_szCREATE_PROCESS_DEBUG_EVENT    db "CREATE_PROCESS_DEBUG_EVENT", 0dh, 0ah, 0
    g_szEXIT_THREAD_DEBUG_EVENT       db "EXIT_THREAD_DEBUG_EVENT", 0dh, 0ah, 0
    g_szEXIT_PROCESS_DEBUG_EVENT      db "EXIT_PROCESS_DEBUG_EVENT", 0dh, 0ah, 0
    g_szLOAD_DLL_DEBUG_EVENT          db "LOAD_DLL_DEBUG_EVENT", 0dh, 0ah, 0
    g_szUNLOAD_DLL_DEBUG_EVENT        db "UNLOAD_DLL_DEBUG_EVENT", 0dh, 0ah, 0
    g_szOUTPUT_DEBUG_STRING_EVENT     db "OUTPUT_DEBUG_STRING_EVENT", 0dh, 0ah, 0
    
    g_szLoadDllFmt    db "%08X %s", 0dh, 0ah, 0
    g_szwLoadDllFmt   dw '%', '0', '8', 'X', ' ', '%', 's', 0dh, 0ah, 0
    
    g_szBpFmt  db      "CCå¼‚å¸¸ %08X", 0dh, 0ah, 0
    g_szSsFmt  db      "å•æ­¥å¼‚å¸¸ %08X", 0dh, 0ah, 0
    
    g_btOldCode db   0           ;è®°å½•æ²¡ä¸‹æ–­ç‚¹ä¹‹å‰çš„å­—ç¬¦
    g_dwBpAddr  dd   01001BCFh   ;ä¸‹æ–­ç‚¹çš„åœ°å€
    g_byteCC    db   0CCh        ; çŸ­ç‚¹ç¬¦å· CC 
   
.code  

;å¤„ç†å¼‚å¸¸ä¿¡æ¯
OnException proc uses esi pDE:ptr DEBUG_EVENT 
    LOCAL @dwOldProc:DWORD   ;ä¿®æ”¹ä¹‹å‰çš„å†…å­˜å±æ€§
    LOCAL @dwBytesOut:DWORD   
    LOCAL @hThread:HANDLE
    LOCAL @ctx:CONTEXT

    mov esi, pDE
    assume esi:ptr DEBUG_EVENT
    
    ;åˆ¤æ–­æ˜¯å¦æ–­ç‚¹å¼‚å¸¸
    .if [esi].u.Exception.pExceptionRecord.ExceptionCode == EXCEPTION_BREAKPOINT
        
        ;åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±çš„CC  é€šè¿‡åœ°å€åˆ¤æ–­
        mov eax, [esi].u.Exception.pExceptionRecord.ExceptionAddress
        .if eax != g_dwBpAddr     ;è¯¥å¤„åœ°å€æ˜¯ä¸æ˜¯æˆ‘ä»¬ä¸‹æ–­ç‚¹åœ°å€
            ;ä¸æ˜¯è‡ªå·±çš„CCå¼‚å¸¸ï¼Œä¸å¤„ç†
            mov eax, DBG_EXCEPTION_NOT_HANDLED 
            ret
        .endif
    
      
        ;å¤„ç†è‡ªå·±çš„CCå¼‚å¸¸
        invoke crt_printf, offset g_szBpFmt, [esi].u.Exception.pExceptionRecord.ExceptionAddress
        
         ;ä¿®æ”¹å†…å­˜å±æ€§
        invoke VirtualProtect, g_dwBpAddr, 1, PAGE_EXECUTE_READWRITE, addr @dwOldProc

        ;æ¢å¤æŒ‡ä»¤
        invoke WriteProcessMemory, g_hExe, g_dwBpAddr, offset g_btOldCode, size g_btOldCode, addr @dwBytesOut 
  
        ;è¿˜åŸå†…å­˜å±æ€§
        invoke VirtualProtect, g_dwBpAddr, 1, @dwOldProc, addr @dwOldProc
        
        ;è®¾ç½®å•æ­¥
        
        ;è·å–çº¿ç¨‹å¥æŸ„
        invoke OpenThread, THREAD_ALL_ACCESS, FALSE, [esi].dwThreadId
        mov @hThread, eax
        
        ;è®¾ç½®ç»“æ„ä½“æ ‡å¿—ä½,ç”¨æ¥åˆ¤æ–­è·å–é‚£äº›å¯„å­˜å™¨ç¯å¢ƒ
        ; CONTEXT_FULL  è¡¨ç¤ºè·å–æ§åˆ¶,æ•´æ•°,æ®µ   CONTEXT_ALL æ˜¯æ‰€æœ‰çš„
        mov @ctx.ContextFlags, CONTEXT_FULL
        ;è·å–å¯„å­˜å™¨ç¯å¢ƒ
        invoke GetThreadContext, @hThread, addr @ctx
        
        ;å°†TFæ ‡å¿—ä½ç½®1
        or @ctx.regFlag, 100h
            
        ;è¿”å›å½“å‰ä»£ç åœ°å€  @ctx.regEip æ‰§è¡Œå®ŒCCçš„åœ°å€ 
        dec @ctx.regEip     ;å‡1,ccæ˜¯ä¸€ä¸ªå­—èŠ‚.
        
        ;è®¾ç½®å¯„å­˜å™¨ç¯å¢ƒ
        invoke SetThreadContext, @hThread, addr @ctx
        
        ;å…³é—­çº¿ç¨‹å¥æŸ„
        invoke CloseHandle, @hThread
        
        mov eax, DBG_CONTINUE
        ret
    .endif
    
    ;å•æ­¥æ¥äº†  (å¦‚æœæ˜¯å•æ­¥å¼‚å¸¸)
    .if [esi].u.Exception.pExceptionRecord.ExceptionCode == EXCEPTION_SINGLE_STEP
        ;å¤„ç†è‡ªå·±çš„å•æ­¥
        invoke crt_printf, offset g_szSsFmt, [esi].u.Exception.pExceptionRecord.ExceptionAddress
        
         ;ä¿®æ”¹å†…å­˜å±æ€§
        invoke VirtualProtect, g_dwBpAddr, 1, PAGE_EXECUTE_READWRITE, addr @dwOldProc
    
        ;é‡è®¾æ–­ç‚¹, é‡æ–°å†™å…¥CC
        invoke WriteProcessMemory, g_hExe,  g_dwBpAddr, offset g_byteCC, size g_byteCC, addr @dwBytesOut
    
        ;è¿˜åŸå†…å­˜å±æ€§
        invoke VirtualProtect, g_dwBpAddr, 1, @dwOldProc, addr @dwOldProc
    
        ;å¼‚å¸¸å·²å¤„ç†,ç»§ç»­æ‰§è¡Œä»£ç 
        mov eax, DBG_CONTINUE
        ret
    .endif
    
    
    assume esi:nothing
    
    mov eax, DBG_EXCEPTION_NOT_HANDLED 
    ret

OnException endp



OnCreateProcess proc 
    LOCAL @dwBytesOut:DWORD  
    LOCAL @dwOldProc:DWORD   ;ä¿®æ”¹ä¹‹å‰çš„å†…å­˜å±æ€§
    
    ;ä¿®æ”¹å†…å­˜å±æ€§
    invoke VirtualProtect, g_dwBpAddr, 1, PAGE_EXECUTE_READWRITE, addr @dwOldProc
  
    
    ;ä¿å­˜åŸæ¥çš„è¢«ä¸‹æ–­ç‚¹åœ°å€ æŒ‡ä»¤åˆ° g_btOldCode ,ç”¨äºæ¢å¤
    invoke ReadProcessMemory, g_hExe, g_dwBpAddr, offset g_btOldCode, size g_btOldCode, addr @dwBytesOut
    
    ;åœ¨ 01001BCF(æ–­ç‚¹åœ°å€)å†™å…¥CC
    invoke WriteProcessMemory, g_hExe,  g_dwBpAddr, offset g_byteCC, size g_byteCC, addr @dwBytesOut
    
    
    ;è¿˜åŸå†…å­˜å±æ€§
    invoke VirtualProtect, g_dwBpAddr, 1, @dwOldProc, addr @dwOldProc
  
    ret

OnCreateProcess endp


main proc
    LOCAL @si:STARTUPINFO
    LOCAL @pi:PROCESS_INFORMATION
    LOCAL @de:DEBUG_EVENT 
    LOCAL @dwStatus:DWORD   ;äº‹ä»¶å¤„ç†ç»“æœ
    
    invoke RtlZeroMemory, addr @si, size @si
    invoke RtlZeroMemory, addr @pi, size @pi
    invoke RtlZeroMemory, addr @de, size @de
    
    mov @dwStatus, DBG_CONTINUE
    ;å»ºç«‹è°ƒè¯•ä¼šè¯
    invoke CreateProcess, NULL, offset g_szExe, NULL, NULL, FALSE, \
        DEBUG_ONLY_THIS_PROCESS,\
        NULL, NULL,\
        addr @si,\
        addr @pi
    .if !eax
        ret
    .endif 
    mov eax, @pi.hProcess
    mov g_hExe, eax
    
    ;å¾ªç¯æ¥å—è°ƒè¯•äº‹ä»¶
    .while TRUE
        invoke WaitForDebugEvent, addr @de, INFINITE
        
        ;å¤„ç†è°ƒè¯•äº‹ä»¶
        .if @de.dwDebugEventCode == EXCEPTION_DEBUG_EVENT
            ;invoke crt_printf, offset g_szEXCEPTION_DEBUG_EVENT
            invoke OnException, addr @de
            mov @dwStatus, eax
        .elseif @de.dwDebugEventCode == CREATE_THREAD_DEBUG_EVENT
            invoke crt_printf, offset g_szCREATE_THREAD_DEBUG_EVENT
        .elseif @de.dwDebugEventCode == CREATE_PROCESS_DEBUG_EVENT
            ;invoke crt_printf, offset g_szCREATE_PROCESS_DEBUG_EVENT
            invoke OnCreateProcess
        .elseif @de.dwDebugEventCode == EXIT_THREAD_DEBUG_EVENT
            invoke crt_printf, offset g_szEXIT_THREAD_DEBUG_EVENT
        .elseif @de.dwDebugEventCode == EXIT_PROCESS_DEBUG_EVENT
            invoke crt_printf, offset g_szEXIT_PROCESS_DEBUG_EVENT
        .elseif @de.dwDebugEventCode == LOAD_DLL_DEBUG_EVENT
            ;invoke OnLoadDll, addr @de
        .elseif @de.dwDebugEventCode == UNLOAD_DLL_DEBUG_EVENT
            invoke crt_printf, offset g_szUNLOAD_DLL_DEBUG_EVENT
        .elseif @de.dwDebugEventCode == OUTPUT_DEBUG_STRING_EVENT
            invoke crt_printf, offset g_szOUTPUT_DEBUG_STRING_EVENT
        .endif
        
        ;æäº¤äº‹ä»¶å¤„ç†ç»“æœ
        invoke ContinueDebugEvent, @de.dwProcessId, @de.dwThreadId, @dwStatus
        invoke RtlZeroMemory, addr @de, size @de
    .endw
    
    ret

main endp


start:
    invoke main 

end start
```

## åæ±‡ç¼–å¼•æ“

https://bbs.pediy.com/thread-205590.htm

udis86å®˜ç½‘    http://udis86.sourceforge.net/

[ğŸ“udis86.zip](/udis86.zip)

```
00513D41    8945 FC         mov     dword ptr [ebp-4], eax
00513D44    817D FC 4EE640B>cmp     dword ptr [ebp-4], BB40E64E
00513D4B    75 09           jnz     short 00513D56
00513D4D    C745 FC 4FE640B>mov     dword ptr [ebp-4], BB40E64F
00513D54    EB 1C           jmp     short 00513D72
00513D56    8B55 FC         mov     edx, dword ptr [ebp-4]
00513D59    81E2 0000FFFF   and     edx, FFFF0000
00513D5F    75 11           jnz     short 00513D72
00513D61    8B45 FC         mov     eax, dword ptr [ebp-4]
00513D64    0D 11470000     or      eax, 4711
00513D69    C1E0 10         shl     eax, 10
00513D6C    0B45 FC         or      eax, dword ptr [ebp-4]
00513D6F    8945 FC         mov     dword ptr [ebp-4], eax
00513D72    8B4D FC         mov     ecx, dword ptr [ebp-4]
00513D75    890D 04A05100   mov     dword ptr [__security_cookie], e>
00513D7B    8B55 FC         mov     edx, dword ptr [ebp-4]
00513D7E    F7D2            not     edx
00513D80    8915 00A05100   mov     dword ptr [__security_cookie_com>
00513D86    8BE5            mov     esp, ebp
00513D88    5D              pop     ebp
00513D89    C3              ret

```

```
#include "udis86.h"
#pragma comment(lib, "libudis86.lib")

#include <iostream>
using namespace std;

int  main()
{
	unsigned char data[73] = {
	0x89, 0x45, 0xFC, 0x81, 0x7D, 0xFC, 0x4E, 0xE6, 0x40, 0xBB, 0x75, 0x09, 0xC7, 0x45, 0xFC, 0x4F,
	0xE6, 0x40, 0xBB, 0xEB, 0x1C, 0x8B, 0x55, 0xFC, 0x81, 0xE2, 0x00, 0x00, 0xFF, 0xFF, 0x75, 0x11,
	0x8B, 0x45, 0xFC, 0x0D, 0x11, 0x47, 0x00, 0x00, 0xC1, 0xE0, 0x10, 0x0B, 0x45, 0xFC, 0x89, 0x45,
	0xFC, 0x8B, 0x4D, 0xFC, 0x89, 0x0D, 0x04, 0xA0, 0x51, 0x00, 0x8B, 0x55, 0xFC, 0xF7, 0xD2, 0x89,
	0x15, 0x00, 0xA0, 0x51, 0x00, 0x8B, 0xE5, 0x5D, 0xC3
	};
    
	ud_t ud_obj;                                        //å®šä¹‰
	ud_init(&ud_obj);                                   //åˆå§‹åŒ–
	ud_set_input_buffer(&ud_obj, data, sizeof(data));   //ç¼“å†²åŒºæ¥æº
	ud_set_mode(&ud_obj, 32);                           //32è¿˜æ˜¯64ä½åæ±‡ç¼–
	ud_set_syntax(&ud_obj, UD_SYN_INTEL);               //é»˜è®¤è¯­æ³•       
	ud_set_pc(&ud_obj, 0x00513D41);                     //æŒ‡ä»¤å¼€å§‹åœ°å€
	while (ud_disassemble(&ud_obj))                     //å¼€å§‹åæ±‡ç¼–
	{
		auto nLen = ud_insn_len(&ud_obj);   //å½“å‰æŒ‡ä»¤é•¿åº¦
		auto nOff = ud_insn_off(&ud_obj);   //EIP  å½“å‰æŒ‡ä»¤åœ°å€
		auto pHex = ud_insn_hex(&ud_obj);   //æœºå™¨ç 
		auto ptr = ud_insn_ptr(&ud_obj);    //åœ¨æœ¬ç¨‹åºå†…å­˜ä¸­çš„åœ°å€
		auto opr = ud_insn_opr(&ud_obj, 0);  
		auto mn = ud_insn_mnemonic(&ud_obj);
		auto mn0 = ud_lookup_mnemonic(mn);
		cout << hex << nOff << " "
			<< pHex << "\t\t"
			<< ud_insn_asm(&ud_obj) << endl;              //åæ±‡ç¼–ç»“æœ
	}

	return 0;
}

```

![img](notesimg/1654698738597-0af26ff0-8025-4e15-b972-d164a227c5ce.png)



## ä½œä¸šï¼š

####  è°ƒè¯•å™¨ï¼Œæ”¯æŒä¸€èˆ¬æ–­ç‚¹åŠŸèƒ½ã€‚